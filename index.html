<!--2024/8/1 22:13 (UTC+8) latest update (restart)-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<link rel="stylesheet" href="style.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap"
			rel="stylesheet"
		/>
		<title>Structure</title>
	</head>
	<body class="app" theme="dark">
		<div class="sidebar">
			<div class="xCzYCeh7x">
				<a class="xbfRemN6Z" href="./" tabindex="-1" translate="no">
					Structure
				</a>
			</div>
			<div class="x8u3Iqtu9">
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					class="x1YPTYxid"
				>
					<circle cx="11" cy="11" r="8" />
					<path d="m21 21-4.3-4.3" />
				</svg>
				<input
					class="xujXllYgW"
					translate="no"
					type="text"
					placeholder="Search..."
					disabled
					maxlength="25"
					tabindex="-1"
				/>
			</div>
			<div class="x8FrVw7Ca">
				<div class="xemr1y6ie">
					<div class="spinner">
						<svg
							class="xxA4Cqchz"
							xmlns="http://www.w3.org/2000/svg"
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="none"
							stroke-width="2	"
							stroke-linecap="round"
							stroke-linejoin="round"
						>
							<path d="M21 12a9 9 0 1 1-6.219-8.56" />
						</svg>
						<span class="xkT2bkntT">Loading...</span>
					</div>
				</div>
			</div>
		</div>
		<div class="main">
			<div class="xehdiGgBv">
				<div class="xMyenRl7K">
					<div class="x8JU9DbQZ">
						<svg
							class="xvx75W2b4"
							xmlns="http://www.w3.org/2000/svg"
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="none"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
						>
							<path d="m12 19-7-7 7-7" />
							<path d="M19 12H5" />
						</svg>
					</div>
					<span class="xvwhg72ii"></span>
				</div>
			</div>
			<div class="xikyLwDf4 xVjpzmyej">
				<!--Start-->
			</div>
			<div class="x9vGRGDgT">
				<div class="xkFjA3rNT">
					<div class="xu3LrfLBe">
						<div
							class="xtsARDHTI"
							placeholder="Message..."
							contenteditable="false"
							autocomplete="off"
							spellcheck="false"
							tabindex="-1"
						></div>
						<div class="xuwRtDpu4 disabled">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="24"
								height="24"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
								class="x1EV2qZZE"
							>
								<path d="m3 3 3 9-3 9 19-9Z" />
								<path d="M6 12h16" />
							</svg>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="xUO0M1BpL">
			<div class="overlay"></div>
			<div class="content">
				<div class="xrYn5ZY3v">帳號登入</div>
				<div class="xRRuA0Z3S">
					<div class="xYIKBnbHS xLO5aWUNC" tabindex="0">
						<svg class="xGBqJjpdr" viewBox="0 0 20 20">
							<path
								d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"
								fill="#4285F4"
							></path>
							<path
								d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"
								fill="#34A853"
							></path>
							<path
								d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"
								fill="#FBBC05"
							></path>
							<path
								d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"
								fill="#EA4335"
							></path>
						</svg>
						<div>使用 Google 登入</div>
					</div>
					<div class="xYIKBnbHS xXyiikhrj" tabindex="0">
						<svg class="xGBqJjpdr" viewBox="0 0 21 21">
							<path fill="#f35325" d="M0 0h10v10H0z" />
							<path fill="#81bc06" d="M11 0h10v10H11z" />
							<path fill="#05a6f0" d="M0 11h10v10H0z" />
							<path fill="#ffba08" d="M11 11h10v10H11z" />
						</svg>
						<div>使用 Microsoft 登入</div>
					</div>
				</div>
			</div>
		</div>
		<script src="script.js"></script>
		<script type="module">
			const googleSiginBtn = _(".xYIKBnbHS.xLO5aWUNC");
			const sigInframe = _(".xUO0M1BpL .content");

			const GoogleSigInSuccess = function (name, email, avatar) {
				sigInframe.innerHTML = `<div class="xJ0pEZGEO">已成功登入Google帳號</div>
				<div class="xDmLoXo3E">
					<img
						class="xm7NzrczQ"
						draggable="false"
						src="${avatar}"
						alt="avatar"
					/>
					<div class="xDLBHn55v">
						<div class="xQ6IT8O6S">${name}</div>
						<div class="xPnpcvswL">${email}</div>
					</div>
				</div>`;
				_(".xUO0M1BpL").onclick = function () {
					_(".xUO0M1BpL").classList.remove("show");
					setTimeout(function () {
						_(".xUO0M1BpL").remove();
					}, 500);
				};
			};

			import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";

			const firebaseConfig = {
				apiKey: "AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",
				authDomain: "smiling-theory-397204.firebaseapp.com",
				databaseURL:
					"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",
				projectId: "smiling-theory-397204",
				storageBucket: "smiling-theory-397204.appspot.com",
				messagingSenderId: "360479398694",
				appId: "1:360479398694:web:05b7df5ce277f89ea8ffe7",
				measurementId: "G-6BKTT1K7D1",
			};

			import {
				getAuth,
				signInWithPopup,
				GoogleAuthProvider,
				onAuthStateChanged,
				signOut,
			} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";
			import {
				getFirestore,
				collection,
				addDoc,
				setDoc,
				doc,
				getDocs,
				onSnapshot,
				query,
				orderBy,
				limit,
				startAfter,
			} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";

			//初始化應用程序
			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);

			//全局定義
			window.sendMessage = async function (roomId, messageContent) {
				try {
					const timestamp = Date.now().toString();
					const docRef = doc(
						collection(db, "chats", roomId, "messages"),
						timestamp
					);
					await setDoc(docRef, {
						senderUID: window.UserID,
						sender: window.UserName,
						content: messageContent,
						timestamp: Date.now(),
					});
				} catch (e) {
					console.error("Error adding message: ", e);
				}
			};

			// 載入之前的聊天紀錄
			// 每次載入20條
			// 記得添加一個觸發載入功能
			window.loadChatHistory = async function (room) {
				const querySnapshot = await getDocs(
					query(
						collection(db, "chats", room, "messages"),
						orderBy("timestamp", "asc"),
						limit(20)
					)
				);

				querySnapshot.forEach((item) => {
					var f = item.data();
					if (f.senderUID === window.UserID) {
						_A22(f.content, "0");
					} else {
						_A25(f.content, "0", f.sender, timeAgo(f.timestamp));
					}
				});
			};

			async function _A2653(a, b) {
				var length = await getDocs(collection(db, "chats", b, "messages"));
				createChatRoom(a, b, length.size, "現在");
			}

			window.createListener = function (room) {
				// 之後可以取消監聽
				window.unsubscribe = onSnapshot(
					collection(db, "chats", room, "messages"),
					(snapshot) => {
						console.log(snapshot)
						// 防止取用快取數據
						if (snapshot.metadata.fromCache) {
							return;
						}
						snapshot.docChanges().forEach((change) => {
							const message = change.doc.data();
							if (change.type === "added") {
								if (message.senderUID === window.UserID) {
									// 本人 (不用做任何事)
								} else {
									// 別人
									_A25(message.content, "0", message.sender, "現在");
								}
							}
						});
					},
					(error) => {
						console.error("監聽錯誤:", error);
					}
				);
			};

			window.onload = async function () {
				const querySnapshot = await getDocs(collection(db, "chats"));
				console.log(querySnapshot);
				_(".xemr1y6ie .spinner").remove();
				querySnapshot.forEach((doc) => {
					var item = doc.data();
					_A2653(item.name, item.id);
				});
			};
			//google登入功能
			const provider = new GoogleAuthProvider();
			const auth = getAuth();

			const SignInWidthGoogle = function () {
				signInWithPopup(auth, provider)
					.then((result) => {
						const credential = GoogleAuthProvider.credentialFromResult(result);
						const token = credential.accessToken;
						const user = result.user;
						window.UserID = user.uid;
						window.UserName = user.displayName;
						GoogleSigInSuccess(user.displayName, user.email, user.photoURL);
					})
					.catch((error) => {
						const errorCode = error.code;
						const errorMessage = error.message;
						const email = error.customData.email;
						const credential = GoogleAuthProvider.credentialFromError(error);
						console.log(errorMessage);
					});
			};

			onAuthStateChanged(auth, (user) => {
				if (user) {
					window.UserID = user.uid;
					window.UserName = user.displayName;
					// User is signed in, see docs for a list of available properties
					// https://firebase.google.com/docs/reference/js/firebase.User
					_A2();
					console.log("User is signed in: ", user);
					// Update UI to reflect user is signed in
				} else {
					_(".xUO0M1BpL").classList.add("show");
					// User is signed out
					window.UserID = "";
					console.log("User is signed out");
					// Update UI to reflect user is signed out
				}
			});

			window.logout = () => {
				signOut(auth)
					.then(() => {
						console.log("User signed out");
					})
					.catch((error) => {
						console.error("Sign out error", error);
					});
			};
			googleSiginBtn.onclick = function () {
				sigInframe.innerHTML = `<div class="spinner">
					<svg
						class="xxA4Cqchz"
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						stroke-width="2	"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M21 12a9 9 0 1 1-6.219-8.56" />
					</svg>
					<span class="xkT2bkntT">等待中...</span>
				</div>`;
				SignInWidthGoogle();
			};

			googleSiginBtn.onkeydown = function (e) {
				if (e.keyCode === 13) {
					window.SignInWidthGoogle();
				}
			};
		</script>
	</body>
</html>
