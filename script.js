import{initializeApp}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage,ref,uploadBytesResumable,getDownloadURL}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore,collection,setDoc,doc,getDocs,getDoc,startAfter,onSnapshot,query,orderBy,limit}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";(()=>{let firebaseConfig={apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"},_=function(e){return document.querySelector(e)},isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var lastDoc,userID,userName,currentRoom="",isAppBadgeSupport=!1,unreadCount=0;let components={activitybar:_(".activitybar"),sidebar:_(".sidebar"),main:_(".main"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageArea:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),actionModalContent:_(".x54SkYRT0"),actionModal:_(".x54SkYRT0"),actionModalTitle:_(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:_(".xWDUelLWA"),actionModalOverlay:_(".x54SkYRT0 .overlay"),actionModalIcon:_(".x3DtTJteF"),signInBtn1:_(".xYIKBnbHS#x7BYgkdiJ"),signInBtn2:_(".xYIKBnbHS#xBnuWNG6V"),signInBtn3:_(".xYIKBnbHS#xWmsCDNbu"),signInModal:_(".xUO0M1BpL"),signInModalContent:_(".xUO0M1BpL .content"),signInModalTitle:_(".xUO0M1BpL .xrYn5ZY3v"),signOutBtn:_(".xlifWPlRj#x8Kzd47QX"),openSettingsBtn:_(".xlifWPlRj#x93dGr74c")},sensitiveWords=["幹","操","草","白癡","智障","死","笨蛋","傻逼"];var currentRoom,_N0=!1,_GF=!1;async function handleSendMessage(){let e=replaceSensitiveWords(replaceUrlsWithLinks(components.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/(\r?\n){3,}/g,"\n\n")).replaceAll("\n","<br>"));if(!e)return;components.messageInput.innerHTML="";let t=doc(collection(db,"chats",currentRoom,"messages"));await setDoc(t,{senderUID:userID,sender:userName,content:e,timestamp:Date.now()}),displaySentMessage(e,t.id)}function displaySentMessage(e,t){let a=document.createElement("div"),n=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div");l.classList.add("xRHoYYwoZ"),n.classList.add("xMyW2iRSH"),a.classList.add("xVC8gtuyS"),a.classList.add("xiOw4dg0O"),s.classList.add("xKljxgVJA"),i.classList.add("xu4Celbbq"),r.classList.add("xc4iCj2Gy"),a.appendChild(s),s.appendChild(l),l.appendChild(i),i.appendChild(r),l.appendChild(n),r.innerHTML="你",n.innerHTML=e,components.messageArea.appendChild(a),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});try{a.setAttribute("data-mid",t)}catch(d){console.log("無法設置該元素參數：",d)}}function displayReceivedMessage(e,t,a,n,s=!0){let i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div"),p=document.createElement("div"),u=document.createElement("div"),m=document.createElement("div");if(m.classList.add("xRHoYYwoZ"),r.classList.add("xMyW2iRSH"),i.classList.add("xVC8gtuyS"),l.classList.add("xSYcbYqTG"),d.classList.add("xKljxgVJA"),c.classList.add("xu4Celbbq"),o.classList.add("xc4iCj2Gy"),p.classList.add("xuvoVURIs"),u.classList.add("xt8fROB2L"),p.innerText=" • ",u.innerText=n,i.setAttribute("data-mid",t),i.appendChild(l),i.appendChild(d),d.appendChild(m),m.appendChild(c),c.appendChild(o),c.appendChild(p),c.appendChild(u),m.appendChild(r),o.innerText=a,r.innerHTML=e,s)components.messageArea.appendChild(i),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let f=components.messageArea.firstChild;components.messageArea.insertBefore(i,f)}}function replaceUrlsWithLinks(e){return e.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){return'<a class="x0ciSQShX" href="'.concat(e,'" target="_blank">').concat(decodeURIComponent(e),"</a>")})}function _A2(){if(!1===_GF){components.searchInput.removeAttribute("disabled"),components.searchInput.setAttribute("tabindex","0"),components.messageArea.classList.remove("xVjpzmyej"),_(".xnKzgeITl")&&_(".xnKzgeITl").remove();var e=(new Date).getHours();displayReceivedMessage("{dl}好，歡迎回來，現在就開始對話吧！".replace("{dl}",e>=5&&e<11?"早上":e>=11&&e<14?"中午":e>=14&&e<18?"下午":"晚安"),"0","陌生人","現在"),_GF=!0,_N0=!0}}function _A22(e,t,a=!0){var n=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div");if(l.classList.add("xRHoYYwoZ"),s.classList.add("xMyW2iRSH"),n.classList.add("xVC8gtuyS"),i.classList.add("xKljxgVJA"),r.classList.add("xu4Celbbq"),n.setAttribute("data-mid",t),n.appendChild(i),i.appendChild(l),l.appendChild(r),l.appendChild(s),s.innerHTML=e,n.classList.add("xiOw4dg0O"),r.innerHTML='<div class="xc4iCj2Gy">你</div>',a)components.messageArea.appendChild(n),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let d=components.messageArea.firstChild;components.messageArea.insertBefore(n,d)}}function protectHtml(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",isAppBadgeSupport&&navigator.clearAppBadge(),unreadCount=0)}),components.messageInput.addEventListener("input",function(e){""===e.target.innerText.trim()&&(e.target.innerHTML="")}),components.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:isMobileDevice||e.shiftKey||(e.preventDefault(),handleSendMessage());break;case 85:case 66:e.ctrlKey&&e.preventDefault()}}),isMobileDevice&&document.body.classList.add("mobile"),("setAppBadge"in navigator||"clearAppBadge"in navigator)&&(isAppBadgeSupport=!0),components.sendButton.onclick=handleSendMessage,components.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,protectHtml((e.clipboardData||window.clipboardData).getData("text/plain")))},document.onkeydown=function(e){switch(e.keyCode){case 191:"true"===components.messageInput.getAttribute("contenteditable")&&document.activeElement!==components.messageInput&&document.activeElement!==components.searchInput&&(e.preventDefault(),_(".xtsARDHTI").focus());break;case 75:e.ctrlKey&&_N0&&(e.preventDefault(),components.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),document.oncontextmenu=function(e){e.preventDefault()},_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){currentRoom="",_(".main").classList.remove("x8VAGH6N2"),components.messageInput.innerHTML="",components.messageInput.setAttribute("contenteditable","false"),components.messageInput.setAttribute("tabindex","-1"),components.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var lastTouchEndTime=0;function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceSensitiveWords(e){let t=sensitiveWords.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),a=RegExp(t.join("|"),"gi");return e.replace(a,e=>"*".repeat(e.length))}function createChatRoom(e,t,n,a){var c;let s=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");s.setAttribute("tabindex","0"),s.classList.add("x2fP9fkxS"),createListener(t);let l=async()=>{(currentRoom!==t||isMobileDevice)&&(lastDoc=void 0,loadChatHistory(currentRoom=t),components.messageArea.innerHTML="",components.sendButton.classList.remove("disabled"),components.fileInput.removeAttribute("disabled"),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice||(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),_(".x2fP9fkxS.interim:not(.active)")&&_(".x2fP9fkxS.interim:not(.active)").remove(),s.classList.add("active")),isMobileDevice&&_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),_(".main").classList.add("x8VAGH6N2"),_(".xvwhg72ii").innerText=s.getAttribute("data-roomName"),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.setAttribute("tabindex","0"),components.sendButton.setAttribute("tabindex","0"))};if(s.onclick=function(){l()},s.onkeydown=function(e){13===e.keyCode&&(components.messageArea.innerHTML="",l())},s.setAttribute("data-roomid",t),s.setAttribute("data-roomname",e),s.appendChild(o),o.classList.add("xQ65c0Nkc"),i.classList.add("xybvM5cRF"),o.appendChild(i),i.innerText=e,r.classList.add("xT3Ta8vKw"),n){c=n;let regex=/<script>(.*?)<\/script>/g,match,results=[];for(;null!==(match=regex.exec(n));)results.push(match[1]);results.forEach(item=>{eval(item)}),console.log(results)}else c=`${a} 則訊息`;r.innerHTML=`
		<span class="x97KBA8qs">${c}</span>
	`,o.appendChild(r),_(".xemr1y6ie").appendChild(s)}function timeAgo(e){let t=Math.floor((Date.now()-e)/1e3);return t<60?`${t}秒`:t<3600?`${Math.floor(t/60)}分鐘`:t<86400?`${Math.floor(t/3600)}小時`:t<2592e3?`${Math.floor(t/86400)}天`:t<31536e3?`${Math.floor(t/2592e3)}個月`:`${Math.floor(t/31536e3)}年前`}function formatFileSize(e){let t=["B","KB","MB","GB","TB"],a=e,n=0;for(;a>=1024&&n<t.length-1;)a/=1024,n++;return`${a.toFixed(2)} ${t[n]}`}document.addEventListener("touchend",function(e){var t=(new Date).getTime();t-lastTouchEndTime<=300&&e.preventDefault(),lastTouchEndTime=t},!1),document.addEventListener("gesturestart",function(e){e.preventDefault()}),components.messageInput.addEventListener("drop",e=>{e.preventDefault();let t=e.dataTransfer.getData("text/plain");try{e.target.focus(),document.execCommand("insertHTML",!0,protectHtml(t))}catch(a){console.log(a)}}),components.searchInput.oninput=e=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(t=>{t.getAttribute("data-roomname").toLowerCase().includes(e.target.value.toLowerCase())?t.classList.remove("hide"):t.classList.add("hide")})},_(".x8u3Iqtu9").onclick=function(){components.searchInput.focus()},components.messageInput.oncopy=e=>{e.preventDefault();let t=window.getSelection().toString();e.clipboardData.setData("text/plain",t)},components.messageArea.addEventListener("scroll",function(){0===(components.messageArea.pageYOffset||components.messageArea.scrollTop)&&loadMoreChatHistory(currentRoom)});let app=initializeApp(firebaseConfig),db=getFirestore(app),storage=getStorage(app);async function _A2653(e,t,a){createChatRoom(e,a,t,(await getDocs(collection(db,"chats",a,"messages"))).size)}async function loadMoreChatHistory(e){try{if(void 0!==lastDoc){let t=await getDocs(query(collection(db,"chats",e,"messages"),orderBy("timestamp","desc"),startAfter(lastDoc),limit(10)));t.docs[9]&&(lastDoc=t.docs[9]),t.forEach(e=>{var t=e.data();t.senderUID===userID?_A22(t.content,e.id,!1):displayReceivedMessage(t.content,t.id,t.sender,timeAgo(t.timestamp),!1)}),null!=t.docs[9]&&null!=t.docs[9]||(lastDoc=void 0)}}catch(a){}}async function loadChatHistory(e){let t=await getDocs(query(collection(db,"chats",e,"messages"),orderBy("timestamp","desc"),limit(10)));t.docs[9]&&(lastDoc=t.docs[9]);let a=[];t.forEach(e=>{a.push(e)}),a.reverse(),a.forEach(e=>{var t=e.data();t.senderUID===userID?_A22(t.content,e.id):displayReceivedMessage(t.content,e.id,t.sender,timeAgo(t.timestamp))})}function createListener(e){onSnapshot(collection(db,"chats",e,"messages"),t=>{t.metadata.fromCache||t.docChanges().forEach(t=>{if(currentRoom!==e)return;let a=t.doc.data();switch(t.type){case"added":a.senderUID!==userID&&("hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) Structure`,isAppBadgeSupport&&navigator.setAppBadge(unreadCount)),displayReceivedMessage(a.content,t.doc.id,a.sender,"現在"));break;case"removed":try{(s=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${t.doc.id}"]`)).classList.add("deleted"),s.innerHTML="這則訊息已被刪除"}catch(n){console.log("發生未知錯誤",n)}break;case"modified":try{var s;(s=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${t.doc.id}"] .xMyW2iRSH`)).innerHTML=a.content}catch(i){console.log("發生未知錯誤",i)}}})},e=>{console.error("監聽錯誤:",e)})}window.onload=async function(){let e=await getDocs(collection(db,"chats"));_(".xemr1y6ie .spinner").remove(),e.forEach(e=>{var t=e.data();-1!==t.members.indexOf(userID)&&_A2653(t.name,t.description,e.id)})};let provider=new GoogleAuthProvider,auth=getAuth(),SignInWidthGoogle=function(){signInWithPopup(auth,provider).then(e=>{GoogleAuthProvider.credentialFromResult(e).accessToken;let t=e.user;userID=t.uid,userName=t.displayName,components.signInModalContent.innerHTML=`<div class="xJ0pEZGEO">已成功登入Google帳號</div>
					<div class="xDmLoXo3E">
					<img class="xm7NzrczQ" draggable="false" src="${t.photoURL}" alt="avatar"/>
					<div class="xDLBHn55v"><div class="xQ6IT8O6S">${t.displayName}</div>
					<div class="xPnpcvswL">${t.email}</div></div></div>`,components.signInModal.onclick=function(){components.signInModal.classList.remove("show"),setTimeout(function(){components.signInModal.remove()},500)}}).catch(e=>{GoogleAuthProvider.credentialFromError(e),console.log(e.code,e.message)})};onAuthStateChanged(auth,e=>{e?(userID=e.uid,userName=e.displayName,_A2()):(components.signInModal.classList.add("show"),userID="",console.log("User is signed out"))}),components.signOutBtn.onclick=()=>{signOut(auth).then(()=>{console.log("User signed out")}).catch(e=>{console.error("Sign out error",e)})},components.signInBtn1.onclick=function(){SignInWidthGoogle()},components.fileInput.onchange=function(e){let t=e.target.files[0];if(t.size/1024/1024>5)return components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="這個文件太大了",components.actionModalSubtitle.innerText=`這個文件足足有 ${formatFileSize(t.size)}，我們無法負擔`,_(".xCECpHDwZ").classList.remove("show"),void(components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")});components.actionModalOverlay.onclick=function(){};let a=ref(storage,"uploads/"+t.name);components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="正在努力上傳中",components.actionModalSubtitle.innerText="這可能需要一點時間，請耐心等待...",_(".xCECpHDwZ").classList.add("show"),_(".xTGGn7ABj").innerText=t.name,_(".xtyaQiCLO").innerText=formatFileSize(t.size);let n=uploadBytesResumable(a,t);n.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;_(".xk0osKWCK").style.width=`${t}%`,console.log("Upload is "+t+"% done")},e=>{console.error("上传失败:",e)},async()=>{components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")},components.actionModalTitle.innerText="完成上傳",components.actionModalSubtitle.innerText="這個文件已成功上傳，你的好友可以訪問了",_(".xCECpHDwZ").classList.remove("show");let e=await getDownloadURL(n.snapshot.ref),a=`我剛剛上傳了一個名為「${t.name}」的文件，<a href="${e}" class="x0ciSQShX" target="_blank">點擊下載</a>`,s=doc(collection(db,"chats",currentRoom,"messages"));await setDoc(s,{senderUID:userID,sender:userName,content:a,timestamp:Date.now()}),displaySentMessage(a,s.id),components.fileInput.value=""})}})();
