import{initializeApp as _}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as b,signInWithPopup as L,GoogleAuthProvider as y,onAuthStateChanged as C,signOut as A}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as E,ref as w,uploadBytesResumable as T,getDownloadURL as k}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as H,collection as I,setDoc as S,doc as D,getDocs as M,startAfter as B,onSnapshot as R,query as j,orderBy as K,limit as Y}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";(()=>{class _{constructor(){this.dialogRoot=document.createElement("div"),this.dialogOverlay=document.createElement("div"),this.dialogContent=document.createElement("div"),this.dialogTitle=document.createElement("div"),this.dialogRoot.classList.add("x54SkYRT0"),this.dialogRoot.setAttribute("data-state","open"),this.dialogOverlay.classList.add("overlay"),this.dialogContent.classList.add("content"),this.dialogRoot.appendChild(this.dialogOverlay),this.dialogRoot.appendChild(this.dialogContent),document.body.appendChild(this.dialogRoot),this.dialogRoot.classList.add("show")}close(){this.dialogRoot.setAttribute("data-state","closed"),setTimeout(()=>{this.dialogRoot.remove()},100)}}let b=function(_){return document.querySelector(_)},L=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var y,C,A,E="",w=!1,T=0;let k={activitybar:b(".activitybar"),sidebar:b(".sidebar"),main:b(".main"),messageInput:b(".xtsARDHTI"),searchInput:b(".xujXllYgW"),messageArea:b(".xikyLwDf4"),sendButton:b(".xuwRtDpu4"),fileInput:b(".xVEJA40Qh"),actionModalContent:b(".x54SkYRT0"),actionModal:b(".x54SkYRT0"),actionModalTitle:b(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:b(".xWDUelLWA"),actionModalOverlay:b(".x54SkYRT0 .overlay"),actionModalIcon:b(".x3DtTJteF"),signOutBtn:b(".xlifWPlRj#x8Kzd47QX"),openSettingsBtn:b(".xlifWPlRj#x93dGr74c")},H=["幹","操","草","白癡","智障","死","笨蛋","傻逼"];var I=!1,S=!1;async function D(){var _,b;let L,y=(b=(_=k.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/(\r?\n){3,}/g,"\n\n")).replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(_){return'<a class="x0ciSQShX" href="'.concat(_,'" target="_blank">').concat(decodeURIComponent(_),"</a>")}).replaceAll("\n","<br>"),L=RegExp(H.map(_=>_.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|"),"gi"),b.replace(L,_=>"*".repeat(_.length)));if(!y)return;k.messageInput.innerHTML="";let w=u(p(z,"chats",E,"messages"));await m(w,{senderUID:C,sender:A,content:y,timestamp:Date.now()}),M(y,w.id)}function M(_,b){let L=document.createElement("div"),y=document.createElement("div"),C=document.createElement("div"),A=document.createElement("div"),E=document.createElement("div"),w=document.createElement("div");w.classList.add("xRHoYYwoZ"),y.classList.add("xMyW2iRSH"),L.classList.add("xVC8gtuyS"),L.classList.add("xiOw4dg0O"),C.classList.add("xKljxgVJA"),A.classList.add("xu4Celbbq"),E.classList.add("xc4iCj2Gy"),L.appendChild(C),C.appendChild(w),w.appendChild(A),A.appendChild(E),w.appendChild(y),E.innerHTML="你",y.innerHTML=_,k.messageArea.appendChild(L),k.messageArea.scrollTo({top:k.messageArea.scrollHeight,behavior:"smooth"});try{L.setAttribute("data-mid",b)}catch(T){console.log("無法設置該元素參數：",T)}}function B(_,b,L,y,C=!0){let A=document.createElement("div"),E=document.createElement("div"),w=document.createElement("div"),T=document.createElement("div"),H=document.createElement("div"),I=document.createElement("div"),S=document.createElement("div"),D=document.createElement("div");if(D.classList.add("xRHoYYwoZ"),E.classList.add("xMyW2iRSH"),A.classList.add("xVC8gtuyS"),w.classList.add("xSYcbYqTG"),T.classList.add("xKljxgVJA"),H.classList.add("xu4Celbbq"),I.classList.add("xc4iCj2Gy"),S.classList.add("xt8fROB2L"),S.innerText=y,A.setAttribute("data-mid",b),A.appendChild(w),A.appendChild(T),T.appendChild(D),D.appendChild(H),H.appendChild(I),H.appendChild(S),D.appendChild(E),I.innerText=L,E.innerHTML=_,C)k.messageArea.appendChild(A),k.messageArea.scrollTo({top:k.messageArea.scrollHeight,behavior:"smooth"});else{let M=k.messageArea.firstChild;k.messageArea.insertBefore(A,M)}}function R(_,b,L=!0){var y=document.createElement("div"),C=document.createElement("div"),A=document.createElement("div"),E=document.createElement("div"),w=document.createElement("div");if(w.classList.add("xRHoYYwoZ"),C.classList.add("xMyW2iRSH"),y.classList.add("xVC8gtuyS"),A.classList.add("xKljxgVJA"),E.classList.add("xu4Celbbq"),y.setAttribute("data-mid",b),y.appendChild(A),A.appendChild(w),w.appendChild(E),w.appendChild(C),C.innerHTML=_,y.classList.add("xiOw4dg0O"),E.innerHTML='<div class="xc4iCj2Gy">你</div>',L)k.messageArea.appendChild(y),k.messageArea.scrollTo({top:k.messageArea.scrollHeight,behavior:"smooth"});else{let T=k.messageArea.firstChild;k.messageArea.insertBefore(y,T)}}function j(_){return _.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",w&&navigator.clearAppBadge(),T=0)}),k.messageInput.addEventListener("input",function(_){""===_.target.innerText.trim()&&(_.target.innerHTML="")}),k.messageInput.addEventListener("keydown",function(_){switch(_.keyCode){case 13:L||_.shiftKey||(_.preventDefault(),D());break;case 85:case 66:_.ctrlKey&&_.preventDefault()}}),L&&document.body.classList.add("mobile"),("setAppBadge"in navigator||"clearAppBadge"in navigator)&&(w=!0),k.sendButton.onclick=D,k.messageInput.onpaste=function(_){_.preventDefault(),document.execCommand("insertHTML",!0,j((_.clipboardData||window.Clipboard).getData("text/plain")))},document.onkeydown=function(_){switch(_.keyCode){case 191:"true"===k.messageInput.getAttribute("contenteditable")&&document.activeElement!==k.messageInput&&document.activeElement!==k.searchInput&&(_.preventDefault(),b(".xtsARDHTI").focus());break;case 75:_.ctrlKey&&I&&(_.preventDefault(),k.searchInput.focus());break;case 123:_.preventDefault();break;case 67:_.ctrlKey&&_.shiftKey&&_.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:_.ctrlKey&&_.preventDefault();break;case 37:case 39:_.altKey&&_.preventDefault()}},document.querySelectorAll("body > div").forEach(function(_){_.onwheel=function(_){_.ctrlKey&&_.preventDefault()}}),document.oncontextmenu=function(_){_.preventDefault()},b(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){E="",b(".main").classList.remove("x8VAGH6N2"),k.messageInput.innerHTML="",k.messageInput.setAttribute("contenteditable","false"),k.messageInput.setAttribute("tabindex","-1"),k.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(_){_.touches&&_.touches.length>1&&_.preventDefault()},{passive:!1});var K=0;function Y(_){let b=Math.floor((Date.now()-_)/1e3);return b<60?`${b}秒`:b<3600?`${Math.floor(b/60)}分鐘`:b<86400?`${Math.floor(b/3600)}小時`:b<2592e3?`${Math.floor(b/86400)}天`:b<31536e3?`${Math.floor(b/2592e3)}個月`:`${Math.floor(b/31536e3)}年前`}function G(_){let b=["B","KB","MB","GB","TB"],L=_,y=0;for(;L>=1024&&y<b.length-1;)L/=1024,y++;return`${L.toFixed(2)} ${b[y]}`}document.addEventListener("touchend",function(_){var b=(new Date).getTime();b-K<=300&&_.preventDefault(),K=b},!1),document.addEventListener("gesturestart",function(_){_.preventDefault()}),k.messageInput.addEventListener("drop",_=>{_.preventDefault();let b=_.dataTransfer.getData("text/plain");try{_.target.focus(),document.execCommand("insertHTML",!0,j(b))}catch(L){console.log(L)}}),k.searchInput.oninput=_=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(b=>{b.getAttribute("data-roomname").toLowerCase().includes(_.target.value.toLowerCase())?b.classList.remove("hide"):b.classList.add("hide")})},b(".x8u3Iqtu9").onclick=function(){k.searchInput.focus()},k.messageInput.oncopy=_=>{_.preventDefault();let b=window.getSelection().toString();_.clipboardData.setData("text/plain",b)},k.messageArea.addEventListener("scroll",function(){0===(k.messageArea.pageYOffset||k.messageArea.scrollTop)&&async function(_){try{if(void 0!==y){let b=await g(f(p(z,"chats",_,"messages"),$("timestamp","desc"),h(y),x(10)));y=10===b.docs.length?b.docs[9]:void 0,b.forEach(_=>{let b=_.data();b.senderUID===C?R(b.content,_.id,!1):B(b.content,_.id,b.sender,Y(b.timestamp),!1)});let L=k.messageArea.scrollHeight;k.messageArea.scrollTop=L-O,O=L}}catch(A){console.error("Error fetching messages: ",A)}}(E)});let O,V=e({apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"}),z=c(V),W=o(V);window.onload=async function(){let _=await g(p(z,"chats")),A=0;b(".xemr1y6ie .spinner").remove(),_.forEach(_=>{var H=_.data();-1!==H.members.indexOf(C)&&(A++,async function(_,A,H){var I,S,D,M,j,K,G;let V,W,Z,P,U;I=_,S=H,D=A,M=(await g(p(z,"chats",H,"messages"))).size,V=document.createElement("div"),W=document.createElement("div"),Z=document.createElement("div"),P=document.createElement("div"),V.setAttribute("tabindex","0"),V.classList.add("x2fP9fkxS"),v(p(z,"chats",K=S,"messages"),_=>{_.metadata.fromCache||_.docChanges().forEach(_=>{if(E!==K)return;let L=_.doc.data();switch(_.type){case"added":L.senderUID!==C&&("hidden"===document.visibilityState&&(T++,document.title=`(${T}) Structure`,w&&navigator.setAppBadge(T)),B(L.content,_.doc.id,L.sender,"現在"));break;case"removed":try{(A=b(`.xikyLwDf4 .xVC8gtuyS[data-mid="${_.doc.id}"]`)).classList.add("deleted"),A.innerHTML="這則訊息已被刪除"}catch(y){console.log("發生未知錯誤",y)}break;case"modified":try{var A;(A=b(`.xikyLwDf4 .xVC8gtuyS[data-mid="${_.doc.id}"] .xMyW2iRSH`)).innerHTML=L.content}catch(k){console.log("發生未知錯誤",k)}}})},_=>{console.error("監聽錯誤:",_)}),U=async()=>{(E!==S||L)&&(y=void 0,async function(_){let b=await g(f(p(z,"chats",_,"messages"),$("timestamp","desc"),x(10)));b.docs[9]&&(y=b.docs[9]);let L=[];b.forEach(_=>{L.push(_)}),L.reverse(),L.forEach(_=>{var b=_.data();b.senderUID===C?R(b.content,_.id):B(b.content,_.id,b.sender,Y(b.timestamp))}),O=k.messageArea.scrollHeight}(E=S),k.messageArea.innerHTML="",k.sendButton.classList.remove("disabled"),k.fileInput.removeAttribute("disabled"),k.messageInput.setAttribute("contenteditable","true"),L||(b(".x2fP9fkxS.active")&&b(".x2fP9fkxS.active").classList.remove("active"),b(".x2fP9fkxS.interim:not(.active)")&&b(".x2fP9fkxS.interim:not(.active)").remove(),V.classList.add("active")),L&&b(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),b(".main").classList.add("x8VAGH6N2"),b(".xvwhg72ii").innerText=V.getAttribute("data-roomName"),k.messageInput.setAttribute("contenteditable","true"),k.messageInput.setAttribute("tabindex","0"),k.sendButton.setAttribute("tabindex","0"))},V.onclick=function(){U()},V.onkeydown=function(_){13===_.keyCode&&U()},V.setAttribute("data-roomid",S),V.setAttribute("data-roomname",I),V.appendChild(W),W.classList.add("xQ65c0Nkc"),Z.classList.add("xybvM5cRF"),W.appendChild(Z),Z.innerText=I,P.classList.add("xT3Ta8vKw"),j=D||(0===M?"暫無訊息":`${(G=M).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")} 則訊息`),P.innerHTML=`
		<span class="x97KBA8qs">${j}</span>
	`,W.appendChild(P),b(".xemr1y6ie").appendChild(V)}(H.name,H.description,_.id))}),0===A&&(b(".xemr1y6ie").innerHTML='<div class="xZYFExNlg">尚未加入任何聊天室</div>')};let Z=new s,P=t();n(P,L=>{L?(C=L.uid,A=L.displayName,function(){if(!1===S){k.searchInput.removeAttribute("disabled"),k.searchInput.setAttribute("tabindex","0"),k.messageArea.classList.remove("xVjpzmyej"),b(".xnKzgeITl")&&b(".xnKzgeITl").remove();var _=(new Date).getHours();B("{dl}好，歡迎回來，現在就開始對話吧！".replace("{dl}",_>=5&&_<11?"早上":_>=11&&_<14?"中午":_>=14&&_<18?"下午":"晚安"),"0","陌生人","現在"),S=!0,I=!0}}()):(C="",function(){let b=document.createElement("div");b.classList.add("xrYn5ZY3v"),b.innerText="帳號登入";let L=document.createElement("div");L.classList.add("xRRuA0Z3S");let y=document.createElement("div");y.id="x7BYgkdiJ",y.innerHTML='<svg class="xGBqJjpdr" viewBox="0 0 20 20">\n	<path d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z" fill=#4285F4></path>\n	<path d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z" fill=#34A853></path>\n	<path d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z" fill=#FBBC05></path>\n	<path d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z" fill=#EA4335></path></svg>\n	<div>使用 Google 登入</div>';let E=document.createElement("div");E.id="xBnuWNG6V",E.className="actionbtn xYIKBnbHS",y.className="actionbtn xYIKBnbHS",E.innerHTML='<svg class=xGBqJjpdr viewBox="0 0 20 20">\n	<path d="M1 5.006A2 2 0 012.995 3h14.01A2 2 0 0119 5.006v9.988A2 2 0 0117.005 17H2.995A2 2 0 011 14.994V5.006zM3 5l7 4 7-4v2l-7 4-7-4V5z" fill-rule=evenodd fill=#788aa2></path>\n	</svg>\n	<div>使用 電子郵件 登入</div>',L.appendChild(y),L.appendChild(E);let w=new _;w.dialogContent.classList.add("bt"),w.dialogContent.appendChild(b),w.dialogContent.appendChild(L),y.onclick=function(){a(P,Z).then(_=>{s.credentialFromResult(_).accessToken;let b=_.user;C=b.uid,A=b.displayName,w.dialogContent.innerHTML=`<div class="xJ0pEZGEO">已成功登入Google帳號</div>
						<div class="xDmLoXo3E">
						<img class="xm7NzrczQ" draggable="false" src="${b.photoURL}" alt="avatar"/>
						<div class="xDLBHn55v"><div class="xQ6IT8O6S">${b.displayName}</div>
						<div class="xPnpcvswL">${b.email}</div></div></div>`,w.dialogOverlay.onclick=function(){w.close()}}).catch(_=>{s.credentialFromError(_),console.log(_.code,_.message)})}}())}),k.signOutBtn.onclick=()=>{i(P).then(()=>{console.log("User signed out")}).catch(_=>{console.error("Sign out error",_)})},k.fileInput.onchange=function(b){let L=b.target.files[0],y=new _;y.dialogContent.classList.add("bt");let w=document.createElement("div");w.classList.add("xrYn5ZY3v");let T=document.createElement("div");if(T.classList.add("xWDUelLWA"),y.dialogContent.appendChild(w),y.dialogContent.appendChild(T),L.size/1024/1024>5)return w.innerText="這個文件太大了",T.innerText=`這個文件足足有 ${G(L.size)}，我們無法負擔`,void(y.dialogOverlay.onclick=function(){y.close()});let H=r(W,"uploads/"+L.name);w.innerText="正在努力上傳中",T.innerText="這可能需要一點時間，請耐心等待...";let I=document.createElement("div");I.classList.add("xCECpHDwZ"),y.dialogContent.appendChild(I);let S=document.createElement("div");S.classList.add("xty9qDHrl"),I.appendChild(S);let D=document.createElement("div");D.classList.add("xIEj1ZAnA"),D.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n								<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>\n								<path d="M14 2v4a2 2 0 0 0 2 2h4"></path>\n							</svg>',S.appendChild(D);let B=document.createElement("div");B.classList.add("xxs4n9nhX"),S.appendChild(B),B.innerHTML=`<div class="xTGGn7ABj">${L.name}</div><div class="xtyaQiCLO">${G(L.size)}</div>`,S.appendChild(B);let R=document.createElement("div");R.classList.add("xsoLox5sj"),S.appendChild(R);let j=document.createElement("div");j.classList.add("xk0osKWCK"),R.appendChild(j);let K=l(H,L);K.on("state_changed",_=>{let b=_.bytesTransferred/_.totalBytes*100;j.style.width=`${b}%`,console.log("Upload is "+b+"% done")},_=>{console.error(_)},async()=>{y.dialogOverlay.onclick=function(){y.close()},I.remove(),w.innerText="完成上傳",T.innerText="這個文件已成功上傳，你的好友可以訪問了";let _=`我剛剛上傳了一個名為「${L.name}」的文件，<a href="${await d(K.snapshot.ref)}" class="x0ciSQShX" target="_blank">點擊下載</a>`,b=u(p(z,"chats",E,"messages"));await m(b,{senderUID:C,sender:A,content:_,timestamp:Date.now()}),M(_,b.id),k.fileInput.value=""})}})();
