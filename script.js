import{initializeApp as e}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as t,signInWithPopup as a,GoogleAuthProvider as s,onAuthStateChanged as n,signOut as i}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as o,ref as r,uploadBytesResumable as l,getDownloadURL as d}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as c,collection as p,setDoc as m,doc as u,getDocs as g,startAfter as h,onSnapshot as v,query as f,orderBy as $,limit as x}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";let firebaseConfig={apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"};class MyDialog{constructor(){this.dialogRoot=document.createElement("div"),this.dialogOverlay=document.createElement("div"),this.dialogContent=document.createElement("div"),this.dialogTitle=document.createElement("div"),this.dialogRoot.classList.add("x54SkYRT0"),this.dialogRoot.setAttribute("data-state","open"),this.dialogOverlay.classList.add("overlay"),this.dialogContent.classList.add("content"),this.dialogRoot.appendChild(this.dialogOverlay),this.dialogRoot.appendChild(this.dialogContent),document.body.appendChild(this.dialogRoot),this.dialogRoot.classList.add("show")}close(){this.dialogRoot.setAttribute("data-state","closed"),setTimeout(()=>{this.dialogRoot.remove()},100)}}let _=function(e){return document.querySelector(e)},isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var lastDoc,userID,userName,currentRoom,currentRoom="",isAppBadgeSupport=!1,unreadCount=0;let components={activitybar:_(".activitybar"),sidebar:_(".sidebar"),main:_(".main"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageArea:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),actionModalContent:_(".x54SkYRT0"),actionModal:_(".x54SkYRT0"),actionModalTitle:_(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:_(".xWDUelLWA"),actionModalOverlay:_(".x54SkYRT0 .overlay"),actionModalIcon:_(".x3DtTJteF"),signOutBtn:_(".xlifWPlRj#x8Kzd47QX"),openSettingsBtn:_(".xlifWPlRj#x93dGr74c")},sensitiveWords=["幹","操","草","白癡","智障","死","笨蛋","傻逼"];var _N0=!1,_GF=!1;async function handleSendMessage(){let e=replaceSensitiveWords(replaceUrlsWithLinks(components.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/(\r?\n){3,}/g,"\n\n")).replaceAll("\n","<br>"));if(!e)return;components.messageInput.innerHTML="";let t=u(p(db,"chats",currentRoom,"messages"));await m(t,{senderUID:userID,sender:userName,content:e,timestamp:Date.now()}),displaySentMessage(e,t.id)}function displaySentMessage(e,t){let a=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div");r.classList.add("xRHoYYwoZ"),s.classList.add("xMyW2iRSH"),a.classList.add("xVC8gtuyS"),a.classList.add("xiOw4dg0O"),n.classList.add("xKljxgVJA"),i.classList.add("xu4Celbbq"),o.classList.add("xc4iCj2Gy"),a.appendChild(n),n.appendChild(r),r.appendChild(i),i.appendChild(o),r.appendChild(s),o.innerHTML="你",s.innerHTML=e,components.messageArea.appendChild(a),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});try{a.setAttribute("data-mid",t)}catch(l){console.log("無法設置該元素參數：",l)}}function displayReceivedMessage(e,t,a,s,n=!0){let i=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),c=document.createElement("div"),p=document.createElement("div"),m=document.createElement("div");if(m.classList.add("xRHoYYwoZ"),o.classList.add("xMyW2iRSH"),i.classList.add("xVC8gtuyS"),r.classList.add("xSYcbYqTG"),l.classList.add("xKljxgVJA"),d.classList.add("xu4Celbbq"),c.classList.add("xc4iCj2Gy"),p.classList.add("xt8fROB2L"),p.innerText=s,i.setAttribute("data-mid",t),i.appendChild(r),i.appendChild(l),l.appendChild(m),m.appendChild(d),d.appendChild(c),d.appendChild(p),m.appendChild(o),c.innerText=a,o.innerHTML=e,n)components.messageArea.appendChild(i),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let u=components.messageArea.firstChild;components.messageArea.insertBefore(i,u)}}function replaceUrlsWithLinks(e){return e.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){return'<a class="x0ciSQShX" href="'.concat(e,'" target="_blank">').concat(decodeURIComponent(e),"</a>")})}function _A2(){if(!1===_GF){components.searchInput.removeAttribute("disabled"),components.searchInput.setAttribute("tabindex","0"),components.messageArea.classList.remove("xVjpzmyej"),_(".xnKzgeITl")&&_(".xnKzgeITl").remove();var e=new Date().getHours();displayReceivedMessage(`{dl}好，歡迎回來，現在就開始對話吧！`.replace("{dl}",e>=5&&e<11?"早上":e>=11&&e<14?"中午":e>=14&&e<18?"下午":"晚安"),"0","陌生人","現在"),_GF=!0,_N0=!0}}function _A22(e,t,a=!0){var s=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div");if(r.classList.add("xRHoYYwoZ"),n.classList.add("xMyW2iRSH"),s.classList.add("xVC8gtuyS"),i.classList.add("xKljxgVJA"),o.classList.add("xu4Celbbq"),s.setAttribute("data-mid",t),s.appendChild(i),i.appendChild(r),r.appendChild(o),r.appendChild(n),n.innerHTML=e,s.classList.add("xiOw4dg0O"),o.innerHTML='<div class="xc4iCj2Gy">你</div>',a)components.messageArea.appendChild(s),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let l=components.messageArea.firstChild;components.messageArea.insertBefore(s,l)}}function protectHtml(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",isAppBadgeSupport&&navigator.clearAppBadge(),unreadCount=0)}),components.messageInput.addEventListener("input",function(e){""===e.target.innerText.trim()&&(e.target.innerHTML="")}),components.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:isMobileDevice||e.shiftKey||(e.preventDefault(),handleSendMessage());break;case 85:case 66:e.ctrlKey&&e.preventDefault()}}),isMobileDevice&&document.body.classList.add("mobile"),("setAppBadge"in navigator||"clearAppBadge"in navigator)&&(isAppBadgeSupport=!0),components.sendButton.onclick=handleSendMessage,components.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,protectHtml((e.clipboardData||window.Clipboard).getData("text/plain")))},document.onkeydown=function(e){switch(e.keyCode){case 191:"true"===components.messageInput.getAttribute("contenteditable")&&document.activeElement!==components.messageInput&&document.activeElement!==components.searchInput&&(e.preventDefault(),_(".xtsARDHTI").focus());break;case 75:e.ctrlKey&&_N0&&(e.preventDefault(),components.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),document.oncontextmenu=function(e){e.preventDefault()},_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){currentRoom="",_(".main").classList.remove("x8VAGH6N2"),components.messageInput.innerHTML="",components.messageInput.setAttribute("contenteditable","false"),components.messageInput.setAttribute("tabindex","-1"),components.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var lastTouchEndTime=0;function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceSensitiveWords(e){let t=sensitiveWords.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),a=RegExp(t.join("|"),"gi");return e.replace(a,e=>"*".repeat(e.length))}function createChatRoom(e,t,a,s){var n;let i=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div");i.setAttribute("tabindex","0"),i.classList.add("x2fP9fkxS"),createListener(t);let d=async()=>{(currentRoom!==t||isMobileDevice)&&(lastDoc=void 0,currentRoom=t,loadChatHistory(currentRoom),components.messageArea.innerHTML="",components.sendButton.classList.remove("disabled"),components.fileInput.removeAttribute("disabled"),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice||(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),_(".x2fP9fkxS.interim:not(.active)")&&_(".x2fP9fkxS.interim:not(.active)").remove(),i.classList.add("active")),isMobileDevice&&_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),_(".main").classList.add("x8VAGH6N2"),_(".xvwhg72ii").innerText=i.getAttribute("data-roomName"),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.setAttribute("tabindex","0"),components.sendButton.setAttribute("tabindex","0"))};i.onclick=function(){d()},i.onkeydown=function(e){13===e.keyCode&&d()},i.setAttribute("data-roomid",t),i.setAttribute("data-roomname",e),i.appendChild(o),o.classList.add("xQ65c0Nkc"),r.classList.add("xybvM5cRF"),o.appendChild(r),r.innerText=e,l.classList.add("xT3Ta8vKw"),n=a||(0===s?"暫無訊息":`${formatNumberWithCommas(s)} 則訊息`),l.innerHTML=`
		<span class="x97KBA8qs">${n}</span>
	`,o.appendChild(l),_(".xemr1y6ie").appendChild(i)}function timeAgo(e){let t=Math.floor((Date.now()-e)/1e3);return t<60?`${t}秒`:t<3600?`${Math.floor(t/60)}分鐘`:t<86400?`${Math.floor(t/3600)}小時`:t<2592e3?`${Math.floor(t/86400)}天`:t<31536e3?`${Math.floor(t/2592e3)}個月`:`${Math.floor(t/31536e3)}年前`}function formatFileSize(e){let t=["B","KB","MB","GB","TB"],a=e,s=0;for(;a>=1024&&s<t.length-1;)a/=1024,s++;return`${a.toFixed(2)} ${t[s]}`}document.addEventListener("touchend",function(e){var t=new Date().getTime();t-lastTouchEndTime<=300&&e.preventDefault(),lastTouchEndTime=t},!1),document.addEventListener("gesturestart",function(e){e.preventDefault()}),components.messageInput.addEventListener("drop",e=>{e.preventDefault();let t=e.dataTransfer.getData("text/plain");try{e.target.focus(),document.execCommand("insertHTML",!0,protectHtml(t))}catch(a){console.log(a)}}),components.searchInput.oninput=e=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(t=>{t.getAttribute("data-roomname").toLowerCase().includes(e.target.value.toLowerCase())?t.classList.remove("hide"):t.classList.add("hide")})},_(".x8u3Iqtu9").onclick=function(){components.searchInput.focus()},components.messageInput.oncopy=e=>{e.preventDefault();let t=window.getSelection().toString();e.clipboardData.setData("text/plain",t)},components.messageArea.addEventListener("scroll",function(){0===(components.messageArea.pageYOffset||components.messageArea.scrollTop)&&loadMoreChatHistory(currentRoom)});let app=e(firebaseConfig),db=c(app),storage=o(app);async function _A2653(e,t,a){var s=await g(p(db,"chats",a,"messages"));createChatRoom(e,a,t,s.size)}let oldScrollHeight,newScrollHeight;async function loadMoreChatHistory(e){try{if(void 0!==lastDoc){let t=await g(f(p(db,"chats",e,"messages"),$("timestamp","desc"),h(lastDoc),x(10)));lastDoc=10===t.docs.length?t.docs[9]:void 0,t.forEach(e=>{let t=e.data();t.senderUID===userID?_A22(t.content,e.id,!1):displayReceivedMessage(t.content,e.id,t.sender,timeAgo(t.timestamp),!1)});let a=components.messageArea.scrollHeight;components.messageArea.scrollTop=a-oldScrollHeight,oldScrollHeight=a}}catch(s){console.error("Error fetching messages: ",s)}}async function loadChatHistory(e){let t=await g(f(p(db,"chats",e,"messages"),$("timestamp","desc"),x(10)));t.docs[9]&&(lastDoc=t.docs[9]);let a=[];t.forEach(e=>{a.push(e)}),a.reverse(),a.forEach(e=>{var t=e.data();t.senderUID===userID?_A22(t.content,e.id):displayReceivedMessage(t.content,e.id,t.sender,timeAgo(t.timestamp))}),oldScrollHeight=components.messageArea.scrollHeight}function createListener(e){v(p(db,"chats",e,"messages"),t=>{t.metadata.fromCache||t.docChanges().forEach(t=>{if(currentRoom!==e)return;let a=t.doc.data();switch(t.type){case"added":a.senderUID!==userID&&("hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) Structure`,isAppBadgeSupport&&navigator.setAppBadge(unreadCount)),displayReceivedMessage(a.content,t.doc.id,a.sender,"現在"));break;case"removed":try{var s=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${t.doc.id}"]`);s.classList.add("deleted"),s.innerHTML="這則訊息已被刪除"}catch(n){console.log("發生未知錯誤",n)}break;case"modified":try{var s=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${t.doc.id}"] .xMyW2iRSH`);s.innerHTML=a.content}catch(i){console.log("發生未知錯誤",i)}}})},e=>{console.error("監聽錯誤:",e)})}window.onload=async function(){let e=await g(p(db,"chats")),t=0;_(".xemr1y6ie .spinner").remove(),e.forEach(e=>{var a=e.data();-1!==a.members.indexOf(userID)&&(t++,_A2653(a.name,a.description,e.id))}),0===t&&(_(".xemr1y6ie").innerHTML=`<div class="xZYFExNlg">尚未加入任何聊天室</div>`)};let provider=new s,auth=t();function setupLoginUI(){let e=document.createElement("div");e.classList.add("xrYn5ZY3v"),e.innerText="帳號登入";let t=document.createElement("div");t.classList.add("xRRuA0Z3S");let n=document.createElement("div");n.id="x7BYgkdiJ",n.innerHTML=`<svg class="xGBqJjpdr" viewBox="0 0 20 20">
	<path d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z" fill=#4285F4></path>
	<path d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z" fill=#34A853></path>
	<path d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z" fill=#FBBC05></path>
	<path d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z" fill=#EA4335></path></svg>
	<div>使用 Google 登入</div>`;let i=document.createElement("div");i.id="xBnuWNG6V",i.className="actionbtn xYIKBnbHS",n.className="actionbtn xYIKBnbHS",i.innerHTML=`<svg class=xGBqJjpdr viewBox="0 0 20 20">
	<path d="M1 5.006A2 2 0 012.995 3h14.01A2 2 0 0119 5.006v9.988A2 2 0 0117.005 17H2.995A2 2 0 011 14.994V5.006zM3 5l7 4 7-4v2l-7 4-7-4V5z" fill-rule=evenodd fill=#788aa2></path>
	</svg>
	<div>使用 電子郵件 登入</div>`,t.appendChild(n),t.appendChild(i);let o=new MyDialog;o.dialogContent.classList.add("bt"),o.dialogContent.appendChild(e),o.dialogContent.appendChild(t),n.onclick=function(){a(auth,provider).then(e=>{s.credentialFromResult(e).accessToken;let t=e.user;userID=t.uid,userName=t.displayName,o.dialogContent.innerHTML=`<div class="xJ0pEZGEO">已成功登入Google帳號</div>
						<div class="xDmLoXo3E">
						<img class="xm7NzrczQ" draggable="false" src="${t.photoURL}" alt="avatar"/>
						<div class="xDLBHn55v"><div class="xQ6IT8O6S">${t.displayName}</div>
						<div class="xPnpcvswL">${t.email}</div></div></div>`,o.dialogOverlay.onclick=function(){o.close()}}).catch(e=>{s.credentialFromError(e),console.log(e.code,e.message)})}}n(auth,e=>{e?(userID=e.uid,userName=e.displayName,_A2()):(userID="",setupLoginUI())}),components.signOutBtn.onclick=()=>{i(auth).then(()=>{console.log("User signed out")}).catch(e=>{console.error("Sign out error",e)})},components.fileInput.onchange=function(e){let t=e.target.files[0],a=new MyDialog;a.dialogContent.classList.add("bt");let s=document.createElement("div");s.classList.add("xrYn5ZY3v");let n=document.createElement("div");if(n.classList.add("xWDUelLWA"),a.dialogContent.appendChild(s),a.dialogContent.appendChild(n),t.size/1024/1024>5){s.innerText="這個文件太大了",n.innerText=`這個文件足足有 ${formatFileSize(t.size)}，我們無法負擔`,a.dialogOverlay.onclick=function(){a.close()};return}let i=r(storage,"uploads/"+t.name);s.innerText="正在努力上傳中",n.innerText="這可能需要一點時間，請耐心等待...";let o=document.createElement("div");o.classList.add("xCECpHDwZ"),a.dialogContent.appendChild(o);let c=document.createElement("div");c.classList.add("xty9qDHrl"),o.appendChild(c);let g=document.createElement("div");g.classList.add("xIEj1ZAnA"),g.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
								<path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
							</svg>`,c.appendChild(g);let h=document.createElement("div");h.classList.add("xxs4n9nhX"),c.appendChild(h),h.innerHTML=`<div class="xTGGn7ABj">${t.name}</div><div class="xtyaQiCLO">${formatFileSize(t.size)}</div>`,c.appendChild(h);let v=document.createElement("div");v.classList.add("xsoLox5sj"),c.appendChild(v);let f=document.createElement("div");f.classList.add("xk0osKWCK"),v.appendChild(f);let $=l(i,t);$.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;f.style.width=`${t}%`,console.log("Upload is "+t+"% done")},e=>{console.error(e)},async()=>{a.dialogOverlay.onclick=function(){a.close()},o.remove(),s.innerText="完成上傳",n.innerText="這個文件已成功上傳，你的好友可以訪問了";let e=await d($.snapshot.ref),i=`我剛剛上傳了一個名為「${t.name}」的文件，<a href="${e}" class="x0ciSQShX" target="_blank">點擊下載</a>`,r=u(p(db,"chats",currentRoom,"messages"));await m(r,{senderUID:userID,sender:userName,content:i,timestamp:Date.now()}),displaySentMessage(i,r.id),components.fileInput.value=""})};
