/**release 2.6*/
import{initializeApp as e}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as t,signInWithPopup as n,GoogleAuthProvider as a,onAuthStateChanged as s,signInWithEmailAndPassword as i,signOut as o}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as r,ref as l,uploadBytesResumable as c,getDownloadURL as d}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as p,enableIndexedDbPersistence as h,collection as u,setDoc as m,doc as g,getDoc as f,getDocs as v,startAfter as $,onSnapshot as x,query as y,orderBy as b,arrayRemove as C,updateDoc as w,limit as L}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";class MyIcons{constructor(){this.resources={check:['<path d="M20 6 9 17l-5-5" />'],loader:['<path d="M21 12a9 9 0 1 1-6.219-8.56" />'],copy:['<rect width="14" height="14" x="8" y="8" rx="2" ry="2" />','<path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />',],translate:['<path d="m5 8 6 6" />','<path d="m4 14 6-6 2-3" />','<path d="M2 5h12" />','<path d="M7 2h1" />','<path d="m22 22-5-10-5 10" />','<path d="M14 18h6" />',],edit:['<path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />',],more:['<circle cx="12" cy="12" r="1" />','<circle cx="12" cy="5" r="1" />','<circle cx="12" cy="19" r="1" />',],info:['<circle cx="12" cy="12" r="10"/>','<path d="M12 16v-4"/>','<path d="M12 8h.01"/>',],close:['<path d="M18 6 6 18"/>','<path d="m6 6 12 12"/>']}}get({name:e,size:t=20,styles:n=""}={}){if(!this.resources[e])throw Error(`Icon with name "${e}" does not exist`);return`<svg aria-hidden="true" style="${n}" xmlns="http://www.w3.org/2000/svg" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${this.resources[e].join("")}</svg>`}}let _myicons=new MyIcons;function oek(e,t){e.focusable(!0),e.addEventListener("keydown",function(e){(13===e.keyCode||"Enter"===e.key)&&t()}),e.addEventListener("click",function(){t()})}function MyWrapper(e,t=""){let n=ec(e);return n.innerHTML=t,n}HTMLElement.prototype.clear=function(){this.innerHTML=""},HTMLElement.prototype.focusable=function(e){this.tabIndex=e?"0":"-1"};class MyPopover{constructor(e){this.Root=ec("xEHCrF5Oe"),this.Overlay=ec("overlay"),this.Content=ec("xC3Uih0ex"),this.trigger=e;let t=this.trigger.getBoundingClientRect();this.Content.style.left=t.left+"px",this.Content.style.top=t.top+t.height+"px",this.Root.setAttribute("data-state","open"),this.Root.setAttribute("role","popover"),this.Root.setAttribute("aria-modal","true"),document.body.appendChild(this.Root),this.Root.appendChild(this.Overlay),this.Root.appendChild(this.Content),this.Root.onwheel=function(e){e.ctrlKey&&e.preventDefault()},this.hidden_elements=document.querySelectorAll("body > *:not(.xEHCrF5Oe, script, [hidden])"),this.hidden_elements.forEach(e=>{e.setAttribute("inert","true")}),this.Overlay.addEventListener("click",()=>this.close()),this.Overlay.addEventListener("contextmenu",()=>this.close()),document.addEventListener("keydown",this._handleKeyDown)}_handleKeyDown=e=>{27===e.keyCode&&(this.close(),this.trigger.focus())};_removeListeners(){document.removeEventListener("keydown",this._handleKeyDown)}close(){this._removeListeners(),this.hidden_elements.forEach(e=>{e.removeAttribute("inert")}),this.Root.setAttribute("data-state","closed"),setTimeout(()=>{this.Root.remove()},100)}}class MyDialog{constructor({closeOnOverlayClick:e=!1,closeOnEsc:t=!1}={}){this.Root=ec("x54SkYRT0"),this.Overlay=ec("overlay"),this.Content=ec("content"),this.Root.setAttribute("data-state","open"),this.Root.appendChild(this.Overlay),this.Root.appendChild(this.Content),this.Root.setAttribute("role","dialog"),this.Root.setAttribute("aria-modal","true"),this.Root.onwheel=function(e){e.ctrlKey&&e.preventDefault()},this.hidden_elements=document.querySelectorAll("body > *:not(.x54SkYRT0, script, style, [hidden])"),this.hidden_elements.forEach(e=>{e.setAttribute("inert","true")}),document.body.appendChild(this.Root),this.Root.classList.add("show"),MyDialog.stack.push(this),e&&this.Overlay.addEventListener("click",this._handleOverlayClick),t&&document.addEventListener("keydown",this._handleKeyDown)}_handleOverlayClick=()=>{this.close()};_handleKeyDown=e=>{27===e.keyCode&&MyDialog.stack[MyDialog.stack.length-1]===this&&this.close()};close(){let e=MyDialog.stack.indexOf(this);e>-1&&MyDialog.stack.splice(e,1),this.hidden_elements.forEach(e=>{e.removeAttribute("inert")}),this.Root.setAttribute("data-state","closed"),setTimeout(()=>{this.Root.remove()},100),this._removeListeners()}_removeListeners(){this.Overlay.onclick=null,document.removeEventListener("keydown",this._handleKeyDown)}}MyDialog.stack=[];let ec=e=>{let t=document.createElement("div");return t.classList.add(e),t},_=e=>document.querySelector(e),app=e({apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"}),db=p(app);h(db).then(()=>{console.log("Offline persistence is enabled.")}).catch(e=>{"failed-precondition"===e.code?console.error("Multiple tabs open, persistence can only be enabled in one tab at a time."):"unimplemented"===e.code&&console.error("The current browser does not support offline persistence.")});let storage=r(app),provider=new a,auth=t(),isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550,allRoom=[],isAppBadgeSupport="setAppBadge"in navigator&&"clearAppBadge"in navigator,components={sidebar:_(".sidebar"),main:_(".main"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageArea:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),signOutButton:_(".xlifWPlRj#x8Kzd47QX"),backButton:_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ"),primaryArea:_(".xemr1y6ie")},sensitiveWords=["幹","操","白癡","智障","死","笨蛋","傻逼",],versionInfo={current:"v0.7",directions:"Optimized the operation steps and fixed some errors."},userProfileCache={},roomProfileCache={},initialized=!1,oldScrollHeight,lastTouchEndTime=0,currentRoom="",lastDoc,unreadCount=0,userID;function quickHpdDialog(e,t=!1){let n=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0}),a=ec("xrYn5ZY3v");a.classList.add("lf"),n.Content.style.padding="0";let s=ec("x6Y89FynP");a.appendChild(s),s.innerText=e,n.Content.appendChild(a);let i=ec("xWDUelLWA");if(n.Content.appendChild(i),t){let o=ec("xvb5soWNa");o.focusable(!0),o.innerHTML=_myicons.get({name:"close",size:24,styles:"min-width: 24px"}),n.close=n.close.bind(n),oek(o,n.close),a.appendChild(o)}return{root:n,body:i}}function formatMessageContent(e){return replaceEmojiWithImage(replaceSensitiveWords(replaceSeparatorLines(replaceUrlsWithLinks(e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/(\r?\n){3,}/g,"\n\n")))).replaceAll("\n","<br>"))}async function handleSendMessage(){let e=components.messageInput.innerText.trim();if(!e||e.length>=800||!currentRoom)return;e=formatMessageContent(e),components.messageInput.clear();let t=g(u(db,"chats",currentRoom,"messages"));await m(t,{sender:userID,content:e,timestamp:Date.now()}),displaySentMessage(e,t.id)}function afc(e){let t=e.querySelector("img.xGsec9lFd");t&&oek(t,function(){window.open(t.src)})}function displaySentMessage(e,t,n=!0){let a=ec("xVC8gtuyS"),s=ec("xMyW2iRSH"),i=ec("xKljxgVJA"),o=ec("xu4Celbbq"),r=ec("xc4iCj2Gy"),l=ec("xRHoYYwoZ");if(a.setAttribute("data-message-id",t),a.classList.add("xiOw4dg0O"),a.appendChild(i),i.appendChild(l),l.appendChild(o),o.appendChild(r),l.appendChild(s),r.innerText="You",s.innerHTML=e,n)components.messageArea.appendChild(a),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"instant"});else{let c=components.messageArea.firstChild;components.messageArea.insertBefore(a,c)}}function displayReceivedMessage(e,t,n,a,s=!0){let i=ec("xVC8gtuyS"),o=ec("xMyW2iRSH"),r=ec("xSYcbYqTG"),l=ec("xKljxgVJA"),c=ec("xu4Celbbq"),d=ec("xc4iCj2Gy"),p=ec("xt8fROB2L"),h=ec("xRHoYYwoZ"),u=document.createElement("img");if(s)components.messageArea.appendChild(i),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"instant"});else{let m=components.messageArea.firstChild;components.messageArea.insertBefore(i,m)}p.classList.add("xt8fROB2L"),i.appendChild(r),i.appendChild(l),l.appendChild(h),h.appendChild(c),c.appendChild(d),h.appendChild(o),c.appendChild(p),r.appendChild(u),i.setAttribute("data-message-id",t),o.innerHTML=e,p.innerText="0s",d.innerText="Unknown",getUserProfile(n).then(e=>{p.innerText=timeAgo(a),u.src=e.avatarUrl||"/assets/avatar.png",d.onclick=function(){quickHpdDialog("Details",!0).body.innerHTML=`<div class="xGGKUZ7B3"><div class="xF37V7xd0">Name</div><div class="xeUKJgV96">${e.name}</div></div><div class="xGGKUZ7B3"><div class="xF37V7xd0">Description</div><div class="xeUKJgV96">${e.signature||"(empty)"}</div></div>`},r.classList.add("xWzeTGC6P"),d.innerText=e.name||"Unknown"})}function replaceUrlsWithLinks(e){return e.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){return'<a class="x0ciSQShX" translate="no" href="'.concat(e,'" target="_blank" rel="noreferrer noopener">').concat(decodeURIComponent(e),"</a>")})}function replaceSeparatorLines(e){return e.replace(/^\s*[-]{10,}\s*\n?/gm,'<div class="x3nWNfdWy horizontal"></div>')}function initialize(){if(initialized)return;Notification.requestPermission().then(e=>{"granted"===e?console.log("Notification permission granted"):console.log("Notification permission not granted")}),components.searchInput.removeAttribute("disabled"),components.searchInput.focusable(!0),components.messageArea.classList.remove("xVjpzmyej"),localStorage.getItem("cvs")!==versionInfo.current&&(localStorage.setItem("cvs",versionInfo.current),quickHpdDialog("What's new",!0).body.appendChild(MyWrapper("xeUKJgV96",versionInfo.directions)));let e=new Date().getHours();displayReceivedMessage("Good {dl} and welcome back. Let's start the chatting now".replace("{dl}",e>=5&&e<11?"morning":e>=11&&e<14?"afternoon":e>=14&&e<18?"evening":"night"),"0","oKyF1fvm",17040384e5,!0),initialized=!0}function escapeHTML(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceSensitiveWords(e){let t=RegExp(sensitiveWords.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|"),"gi");return e.replace(t,e=>"*".repeat(e.length))}function replaceEmojiWithImage(e){return e.replace(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu,e=>`<img src="https://raw.githubusercontent.com/AdvenaHQ/fluent-emoji/main/dist/100x100/${Array.from(e).map(e=>e.codePointAt(0).toString(16)).join("-")}.png" alt="${e}" draggable="false" class="xb1Ycteg3">`)}isMobileDevice&&document.body.classList.add("mobile");class EventManager{constructor(){this.eventMap=new Map}addEvent(e,t){this.eventMap.has(e)||(this.eventMap.set(e,new Set),document.addEventListener(e,t=>{this.triggerEvent(e,t)})),this.eventMap.get(e).add(t)}removeEvent(e,t){this.eventMap.has(e)&&(this.eventMap.get(e).delete(t),0===this.eventMap.get(e).size&&(this.eventMap.delete(e),document.removeEventListener(e,t=>{this.triggerEvent(e,t)})))}triggerEvent(e,t){this.eventMap.has(e)&&this.eventMap.get(e).forEach(e=>{e(t)})}}function createChatRoom(e,t,n,a,s=!1){var i;let o=ec("x2fP9fkxS"),r=ec("xQ65c0Nkc"),l=ec("xybvM5cRF"),c=ec("xT3Ta8vKw"),d=ec("x6HyfOZS7"),p=ec("xQkxrD9ZA");o.focusable(!0),createListener(t);let h=async()=>{let n=new URLSearchParams(window.location.search);n.set("r",t),window.history.replaceState({},"","?"+n.toString()),(currentRoom!==t||isMobileDevice)&&(lastDoc=void 0,currentRoom=t,loadChatHistory(currentRoom),components.messageArea.clear(),components.sendButton.classList.remove("disabled"),components.fileInput.removeAttribute("disabled"),_(".xpbRox0hO").classList.remove("disabled"),_(".xpbRox0hO").focusable(!0),components.sendButton.focusable(!0),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice||(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),_(".x2fP9fkxS.interim:not(.active)")&&_(".x2fP9fkxS.interim:not(.active)").remove(),o.classList.add("active")),isMobileDevice&&_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").focusable(!0),_(".main").classList.add("x8VAGH6N2"),_(".xvwhg72ii").innerText=e,components.messageInput.setAttribute("contenteditable","true"),components.messageInput.focusable(!0))};oek(o,h),s&&h(),allRoom.push({id:t,name:e,dom:o}),o.appendChild(r),o.appendChild(d),d.appendChild(p),p.focusable(!0);let u=function(){let e=quickHpdDialog("Invitation link",!0).body,n=ec("xKfGtNfnX"),a=ec("xMMSyk68x");a.innerText="Some people may not be able to join";let s=document.createElement("div");s.classList.add("xIcrOS5lb");let i=`${window.location.origin}/?join=${t}`;s.innerText=i;let o=document.createElement("div");o.focusable(!0),o.classList.add("xGugcvsJF");let r=_myicons.get({name:"copy",size:20,styles:"min-width: 20px"});o.innerHTML=r,oek(o,function e(){navigator.clipboard.writeText(i),o.innerHTML=_myicons.get({name:"check",size:20,styles:"min-width: 20px"}),setTimeout(function(){o.innerHTML=r},1500)}),e.appendChild(n),e.appendChild(a),n.appendChild(s),n.appendChild(o)},m=function(){new quickHpdDialog("Settings",!0).body.textContent="Not yet completed construction"},f=async function(){let e=allRoom.findIndex(e=>e.id===t);if(-1!==e)try{await w(g(db,"users",userID),{joined:C(t)}),allRoom.splice(e,1),o.remove(),currentRoom===t&&components.messageArea.clear()}catch(n){console.error("Error while deleting item:",n)}},v=function(){let e=new MyPopover(p),t=ec("xrQdSHI2A"),n=ec("xrQdSHI2A"),a=ec("xcoXgMpFW"),s=ec("xrQdSHI2A");function i(t){e.close(),t()}t.innerText="Invite People",t.style.color="rgb(112, 184, 255)",[t,n,s].forEach(e=>{e.focusable(!0)}),oek(t,()=>i(u)),oek(n,()=>i(m)),oek(s,()=>i(f)),e.Content.appendChild(t),n.innerText="Privacy Settings",e.Content.appendChild(n),e.Content.appendChild(a),s.innerText="Leave",s.style.color="rgb(239, 68, 68)",e.Content.appendChild(s)};p.onkeydown=e=>{e.stopPropagation(),13===e.keyCode&&v()},p.innerHTML=_myicons.get({name:"more",size:20,styles:"min-width: 20px"}),p.onclick=e=>{e.stopPropagation(),v()},r.appendChild(l),l.innerText=e,i=n||(0===a?"No message":`${formatNumberWithCommas(a)} messages`),c.innerText=i,r.appendChild(c),components.primaryArea.appendChild(o)}let pluralize=(e,t)=>`${t} ${t>1?formatNumberWithCommas(e)+"s":e}`;function timeAgo(e){let t=Math.max(Math.floor((Date.now()-e)/1e3),0);return t<60?`${pluralize("second",t)} ago`:t<3600?`${pluralize("minute",Math.floor(t/60))} ago`:t<86400?`${pluralize("hour",Math.floor(t/3600))} ago`:t<2592e3?`${pluralize("day",Math.floor(t/86400))} ago`:t<31536e3?`${pluralize("month",Math.floor(t/2592e3))} ago`:`${pluralize("year",Math.floor(t/31536e3))} ago`}function formatFileSize(e){let t=["B","KB","MB","GB","TB","PB"],n=e,a=0;for(;n>=1024&&a<t.length-1;)n/=1024,a++;return`${n.toFixed(2)} ${t[a]}`}async function getUserProfile(e){if(userProfileCache[e])return console.log("Get data from memory cache"),userProfileCache[e];let t=sessionStorage.getItem(`userProfile_${e}`);if(t){console.log("Get data from sessionStorage");let n=JSON.parse(t);return userProfileCache[e]=n,n}try{let a=await f(g(db,"users",e));if(!a.exists())return console.log("No data found for this user"),null;{let s=a.data();return userProfileCache[e]=s,sessionStorage.setItem(`userProfile_${e}`,JSON.stringify(s)),console.log("Get data from Firestore"),s}}catch(i){throw console.error("Error while getting user data:",i.toString()),i}}async function getRoomProfile(e){if(roomProfileCache[e])return console.log("Get data from memory cache"),roomProfileCache[e];let t=sessionStorage.getItem(`roomProfile_${e}`);if(t){console.log("Get data from sessionStorage");let n=JSON.parse(t);return roomProfileCache[e]=n,n}try{let a=await f(g(db,"chats",e));if(!a.exists())return console.log("No data found for this user"),null;{let s=a.data();return userProfileCache[e]=s,sessionStorage.setItem(`roomProfile_${e}`,JSON.stringify(s)),console.log("Get data from Firestore"),s}}catch(i){throw console.error("Error while getting user data:",i.toString()),i}}async function loadMoreChatHistory(e){try{if(void 0!==lastDoc){let t=await v(y(u(db,"chats",e,"messages"),b("timestamp","desc"),$(lastDoc),L(10)));if(lastDoc=10===t.docs.length?t.docs[9]:void 0,t.forEach(e=>{let t=e.data();t.sender===userID?displaySentMessage(t.content,e.id,!1):displayReceivedMessage(t.content,e.id,t.sender,t.timestamp,!1)}),0!==t.docs.length){let n=components.messageArea.scrollHeight;components.messageArea.scrollTop=n-oldScrollHeight}}}catch(a){console.error("Error fetching messages: ",a)}}async function loadChatHistory(e){let t=await v(y(u(db,"chats",e,"messages"),b("timestamp","desc"),L(10)));t.docs[9]&&(lastDoc=t.docs[9]);let n=[];t.forEach(e=>{n.push(e)}),n.reverse(),n.map(e=>{var t=e.data();t.sender===userID?displaySentMessage(t.content,e.id,!0):displayReceivedMessage(t.content,e.id,t.sender,t.timestamp,!0)}),oldScrollHeight=components.messageArea.scrollHeight}function createListener(e){x(u(db,"chats",e,"messages"),t=>{t.docChanges().forEach(n=>{if(currentRoom!==e)return;let a=n.doc.data();switch(n.type){case"added":a.sender===userID||t.metadata.fromCache||("hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) Structure`,isAppBadgeSupport&&navigator.setAppBadge(unreadCount)),displayReceivedMessage(a.content,n.doc.id,a.sender,a.timestamp,!0));break;case"removed":try{var s=_(`.xikyLwDf4 .xVC8gtuyS[data-message-id="${n.doc.id}"]`);s.classList.add("deleted"),s.innerHTML="This message has been deleted"}catch(i){console.log("An unknown error occurred",i)}break;case"modified":try{var s=_(`.xikyLwDf4 .xVC8gtuyS[data-message-id="${n.doc.id}"] .xMyW2iRSH`);s.innerHTML=a.content}catch(o){console.log("An unknown error occurred",o)}}})},e=>{console.error("An unknown error occurred",e)})}function setupLoginUI(){let e=document.createElement("div");e.classList.add("xrYn5ZY3v"),e.innerText="Account Login";let t=document.createElement("div");t.classList.add("xRRuA0Z3S");let s=document.createElement("div");s.id="x7BYgkdiJ",s.focusable(!0),s.innerHTML=`<svg aria-hidden="true" class="xGBqJjpdr" viewBox="0 0 20 20">
	<path d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z" fill=#4285F4></path>
	<path d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z" fill=#34A853></path>
	<path d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z" fill=#FBBC05></path>
	<path d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z" fill=#EA4335></path></svg>
	<div>Sign in with Google</div>`;let o=document.createElement("div");o.focusable(!0),o.id="xBnuWNG6V",o.className="actionbtn xYIKBnbHS",s.className="actionbtn xYIKBnbHS",o.innerHTML='<svg aria-hidden="true" class="xGBqJjpdr" viewBox="0 0 20 20"><path d="M1 5.006A2 2 0 012.995 3h14.01A2 2 0 0119 5.006v9.988A2 2 0 0117.005 17H2.995A2 2 0 011 14.994V5.006zM3 5l7 4 7-4v2l-7 4-7-4V5z" fill-rule=evenodd fill=#788aa2></path></svg><div>Sign in with email</div>',t.appendChild(s),t.appendChild(o);let r=new MyDialog;r.Content.classList.add("bt"),r.Content.appendChild(e),r.Content.appendChild(t),s.onclick=function(){n(auth,provider).then(e=>{a.credentialFromResult(e).accessToken;let t=e.user;getUserProfile(userID=t.uid).then(e=>{r.close(),e||setupProfileSettingUI(t.displayName)}).catch(e=>{console.error(e)})}).catch(e=>{a.credentialFromError(e),console.log(e.code,e.message)})},o.onclick=function(){let e=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0}),t=document.createElement("div");t.classList.add("xrYn5ZY3v"),t.innerText="Account Login",e.Content.appendChild(t);let n=document.createElement("div");n.classList.add("xZdL9CF5M"),e.Content.appendChild(n);let a=document.createElement("div");a.classList.add("xGGKUZ7B3"),n.appendChild(a);let s=document.createElement("label");s.classList.add("xF37V7xd0"),s.innerText="Email",a.appendChild(s);let o=document.createElement("input");o.classList.add("xYvZ9WF6d"),o.autocomplete="off",o.type="text",o.spellcheck="false",a.appendChild(o);let l=document.createElement("div");l.classList.add("xGGKUZ7B3"),l.style.marginTop="10px",l.style.marginBottom="5px",n.appendChild(l);let c=document.createElement("label");c.classList.add("xF37V7xd0"),c.innerText="Password",l.appendChild(c);let d=document.createElement("input");d.classList.add("xYvZ9WF6d"),d.type="password",d.autocomplete="off",l.appendChild(d);let p=document.createElement("div");p.classList.add("xw0IanPrC"),n.appendChild(p);let h=document.createElement("div");h.innerText="Login",h.focusable(!0),h.classList.add("x40AApYkW"),n.appendChild(h),o.focus();var u=!0;let m=function(t){u&&(u=!1,p.classList.remove("show"),h.innerHTML='<svg aria-hidden="true" class="x3xXCjYFp" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>',o.disabled=!0,d.disabled=!0,h.classList.add("disabled"),h.focusable(!1),h.blur(),i(auth,o.value,d.value).then(t=>{try{r.close(),e.close()}catch(n){}let a=t.user;console.log("User is logged in: ",a),getUserProfile(a.uid).then(e=>{e||setupProfileSettingUI()}).catch(e=>{console.error(e)})}).catch(e=>{setTimeout(function(){let t=e.code;switch(p.classList.add("show"),t){case"auth/invalid-login-credentials":case"auth/invalid-email":p.innerText="Wrong account or password";break;case"auth/network-request-failed":p.innerText="Network request failed";break;default:p.innerText="An unexpected error occurred."}h.innerHTML="Login",h.classList.remove("disabled"),h.focusable(!0),o.disabled=!1,d.disabled=!1,u=!0},3e3)}))};d.onkeydown=function(e){13===e.keyCode&&m()},oek(h,m)}}function setupProfileSettingUI(e="Unnamed"){let t=new MyDialog({closeOnEsc:!1,closeOnOverlayClick:!1});t.Content.style.padding="0",t.Content.classList.add("lg");let n=ec("xrYn5ZY3v");n.classList.add("lf");let a=ec("x6Y89FynP");a.innerText="Edit Profiles",n.appendChild(a),t.Content.appendChild(n);let s=ec("xWDUelLWA");t.Content.appendChild(s);let i=document.createElement("input");i.setAttribute("hidden","true"),i.id="_Jy2eOVG7",i.type="file";let o=ec("xGGKUZ7B3"),r=document.createElement("label");r.innerText="Display Name",r.classList.add("xF37V7xd0"),r.htmlFor="_rJvAjH9O";let l=document.createElement("input");l.value=e,l.classList.add("xYvZ9WF6d"),l.id="_rJvAjH9O",l.type="text",l.maxLength="20",l.autocomplete="off",l.spellcheck="false",s.appendChild(o),o.appendChild(r),o.appendChild(l);let c=ec("xGGKUZ7B3"),d=document.createElement("label");d.innerText="Description",d.classList.add("xF37V7xd0"),d.htmlFor="_fM6Qcf9q";let p=document.createElement("textarea");p.value="I am a human",p.maxLength="80",p.classList.add("xGuwEx6qN"),p.id="_fM6Qcf9q",p.rows="3",p.maxLength="50",p.autocomplete="off",p.spellcheck="false",s.appendChild(c),c.appendChild(d),c.appendChild(p);let h=ec("x40AApYkW");async function u(){h.classList.add("disabled"),h.innerText="Saving...",h.focusable(!1),l.disabled=!0,p.disabled=!0,i.disabled=!0,await m(g(db,"users",userID),{avatarUrl:null,name:l.value,signature:p.value,verified:!1}),t.close()}h.focusable(!0),h.innerText="Save",h.style.marginTop="5px",s.appendChild(h),oek(h,u)}async function preActionofCreate(e,t){let n=await v(u(db,"chats",e.id,"messages"));createChatRoom(e.name,e.id,e.description,n.size,t)}async function loadAllChatRoom(){components.primaryArea.clear();let e=(await f(g(db,"users",userID))).data(),t=_(".xemr1y6ie .spinner");t&&t.remove();let n=new URLSearchParams(window.location.search).get("r");e.joined.map(async e=>{try{getRoomProfile(e).then(async t=>{preActionofCreate({id:e,name:t.name,description:t.description},n===e)})}catch(t){console.error("Error fetching document for ID:",e,t)}})}s(auth,e=>{e?(userID=e.uid,loadAllChatRoom(),initialize()):(userID="",setupLoginUI())}),components.signOutButton.onclick=()=>{o(auth).then(()=>{userID="",components.primaryArea.clear(),components.messageArea.clear(),localStorage.setItem("cvs","")}).catch(e=>{console.error("Sign out error",e)})},components.fileInput.onchange=async function(e){let t=e.target.files[0];if(!t)return;let n=new MyDialog;n.Content.classList.add("bt");let a=document.createElement("div");a.classList.add("xrYn5ZY3v");let s=document.createElement("div");if(s.classList.add("xb1IsDa6e"),n.Content.appendChild(a),n.Content.appendChild(s),t.size/1024/1024>5){a.innerText="This file is too large",s.innerText=`This file is ${formatFileSize(t.size)}, we can't afford it.`,n.Overlay.onclick=function(){n.close()};return}let i=l(storage,"uploads/"+t.name);a.innerText="Uploading",s.innerText="This may take a while, please be patient...";let o=document.createElement("div");o.classList.add("xCECpHDwZ"),n.Content.appendChild(o);let r=document.createElement("div");r.classList.add("xty9qDHrl"),o.appendChild(r);let p=document.createElement("div");p.classList.add("xIEj1ZAnA"),p.innerHTML='<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'.concat('<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path></svg>'),r.appendChild(p);let h=document.createElement("div");h.classList.add("xxs4n9nhX"),r.appendChild(h),h.innerHTML='<div class="xTGGn7ABj">'.concat(t.name).concat(`</div><div class="xtyaQiCLO">${formatFileSize(t.size)}</div>`),r.appendChild(h);let f=document.createElement("div");f.classList.add("xsoLox5sj"),r.appendChild(f);let v=document.createElement("div");v.classList.add("xk0osKWCK"),f.appendChild(v);let $=c(i,t);$.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;v.style.width=`${t}%`},e=>{console.error(e)},async()=>{var e;n.Overlay.onclick=function(){n.close()},o.remove(),a.innerText="Complete upload",s.innerText="This file has been uploaded successfully";let i=await d($.snapshot.ref),r=String(t.type);e=r.startsWith("image/")?`<img loading="lazy" tabindex="0" src="${i}" class="xGsec9lFd">`:r.startsWith("video/")?'<video tabindex="0" src="'.concat(i).concat('" controlslist="nodownload" controls class="xGsec9lFd"></video>'):r.startsWith("audio/")?`<audio tabindex="0" src="${i}" controlslist="nodownload" controls class="xGsec9lFd"></audio>`:`I just uploaded a file "${t.name}", <a href="${i}" class="x0ciSQShX" target="_blank">Download</a>`;let l=g(u(db,"chats",currentRoom,"messages"));await m(l,{sender:userID,content:e,timestamp:Date.now()}),displaySentMessage(e,l.id,!0),components.fileInput.value=""})},document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",isAppBadgeSupport&&navigator.clearAppBadge(),unreadCount=0)}),document.addEventListener("gesturestart",function(e){e.preventDefault()}),components.searchInput.oninput=e=>{allRoom.forEach(t=>{t.name.toLowerCase().includes(e.target.value.toLowerCase().trim())?t.dom.classList.remove("hide"):t.dom.classList.add("hide")})},components.messageArea.addEventListener("scroll",function(){if(""!==userID){let e=components.messageArea.pageYOffset||components.messageArea.scrollTop;oldScrollHeight=components.messageArea.scrollHeight,0===e&&loadMoreChatHistory(currentRoom)}}),components.messageInput.addEventListener("input",function(){let e=components.messageInput.childNodes;1==e.length&&"BR"===e[0].nodeName&&components.messageInput.clear()}),components.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,escapeHTML((e.clipboardData||window.Clipboard).getData("text/plain")))},components.messageInput.addEventListener("drop",function(e){e.preventDefault();var t=e.dataTransfer.getData("text/plain");e.target.focus(),document.execCommand("insertHTML",!0,escapeHTML(t))}),components.messageInput.oncopy=function(e){e.preventDefault();var t=window.getSelection().toString();e.clipboardData.setData("text/plain",t)},components.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:isMobileDevice||e.shiftKey||(e.preventDefault(),handleSendMessage());break;case 85:case 66:e.ctrlKey&&e.preventDefault()}}),components.sendButton.onclick=handleSendMessage,components.sendButton.onkeydown=function(e){13===e.keyCode&&handleSendMessage()},document.onkeydown=function(e){switch(e.keyCode){case 191:document.activeElement!=components.messageInput&&document.activeElement!==components.searchInput&&(e.preventDefault(),components.messageInput.focus());break;case 75:e.ctrlKey&&initialized&&(e.preventDefault(),components.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:case 109:case 107:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),document.oncontextmenu=function(e){e.preventDefault()},components.backButton.onclick=function(){currentRoom="";let e=window.location.href.replace(/\?.*$/,"");window.history.replaceState(null,"",e),components.main.classList.remove("x8VAGH6N2"),components.messageArea.clear(),components.messageInput.clear(),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.focusable(!1),components.sendButton.focusable(!1)},document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1}),document.addEventListener("touchend",function(e){var t=new Date().getTime();t-lastTouchEndTime<=300&&e.preventDefault(),lastTouchEndTime=t},!1);
