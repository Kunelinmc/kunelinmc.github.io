import{initializeApp as e}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as t,signInWithPopup as a,GoogleAuthProvider as s,onAuthStateChanged as n,signOut as i}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as r,ref as l,uploadBytesResumable as d,getDownloadURL as o}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as c,collection as p,setDoc as m,doc as u,getDocs as g,getDoc as f,startAfter as x,onSnapshot as v,query as h,orderBy as b,limit as L}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";(()=>{let f=function(e){return document.querySelector(e)},y=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var $,A,w,C="",T=!1,I=0;let M={activitybar:f(".activitybar"),sidebar:f(".sidebar"),main:f(".main"),messageInput:f(".xtsARDHTI"),searchInput:f(".xujXllYgW"),messageArea:f(".xikyLwDf4"),sendButton:f(".xuwRtDpu4"),fileInput:f(".xVEJA40Qh"),actionModalContent:f(".x54SkYRT0"),actionModal:f(".x54SkYRT0"),actionModalTitle:f(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:f(".xWDUelLWA"),actionModalOverlay:f(".x54SkYRT0 .overlay"),actionModalIcon:f(".x3DtTJteF"),signInBtn1:f(".xYIKBnbHS#x7BYgkdiJ"),signInBtn2:f(".xYIKBnbHS#xBnuWNG6V"),signInBtn3:f(".xYIKBnbHS#xWmsCDNbu"),signInModal:f(".xUO0M1BpL"),signInModalContent:f(".xUO0M1BpL .content"),signInModalTitle:f(".xUO0M1BpL .xrYn5ZY3v"),signOutBtn:f(".xlifWPlRj#x8Kzd47QX"),openSettingsBtn:f(".xlifWPlRj#x93dGr74c")},_=["幹","操","草","白癡","智障","死","笨蛋","傻逼"];var E=!1,S=!1;async function D(){var e;let t=function(e){let t=_.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),a=RegExp(t.join("|"),"gi");return e.replace(a,e=>"*".repeat(e.length))}((e=M.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/(\r?\n){3,}/g,"\n\n")).replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){return'<a class="x0ciSQShX" href="'.concat(e,'" target="_blank">').concat(decodeURIComponent(e),"</a>")}).replaceAll("\n","<br>"));if(!t)return;M.messageInput.innerHTML="";let a=u(p(G,"chats",C,"messages"));await m(a,{senderUID:A,sender:w,content:t,timestamp:Date.now()}),k(t,a.id)}function k(e,t){let a=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div");l.classList.add("xRHoYYwoZ"),s.classList.add("xMyW2iRSH"),a.classList.add("xVC8gtuyS"),a.classList.add("xiOw4dg0O"),n.classList.add("xKljxgVJA"),i.classList.add("xu4Celbbq"),r.classList.add("xc4iCj2Gy"),a.appendChild(n),n.appendChild(l),l.appendChild(i),i.appendChild(r),l.appendChild(s),r.innerHTML="你",s.innerHTML=e,M.messageArea.appendChild(a),M.messageArea.scrollTo({top:M.messageArea.scrollHeight,behavior:"smooth"});try{a.setAttribute("data-mid",t)}catch(d){console.log("無法設置該元素參數：",d)}}function B(e,t,a,s,n=!0){let i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),o=document.createElement("div"),c=document.createElement("div"),p=document.createElement("div"),m=document.createElement("div");if(m.classList.add("xRHoYYwoZ"),r.classList.add("xMyW2iRSH"),i.classList.add("xVC8gtuyS"),l.classList.add("xSYcbYqTG"),d.classList.add("xKljxgVJA"),o.classList.add("xu4Celbbq"),c.classList.add("xc4iCj2Gy"),p.classList.add("xt8fROB2L"),p.innerText=s,i.setAttribute("data-mid",t),i.appendChild(l),i.appendChild(d),d.appendChild(m),m.appendChild(o),o.appendChild(c),o.appendChild(p),m.appendChild(r),c.innerText=a,r.innerHTML=e,n)M.messageArea.appendChild(i),M.messageArea.scrollTo({top:M.messageArea.scrollHeight,behavior:"smooth"});else{let u=M.messageArea.firstChild;M.messageArea.insertBefore(i,u)}}function H(e,t,a=!0){var s=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div");if(l.classList.add("xRHoYYwoZ"),n.classList.add("xMyW2iRSH"),s.classList.add("xVC8gtuyS"),i.classList.add("xKljxgVJA"),r.classList.add("xu4Celbbq"),s.setAttribute("data-mid",t),s.appendChild(i),i.appendChild(l),l.appendChild(r),l.appendChild(n),n.innerHTML=e,s.classList.add("xiOw4dg0O"),r.innerHTML='<div class="xc4iCj2Gy">你</div>',a)M.messageArea.appendChild(s),M.messageArea.scrollTo({top:M.messageArea.scrollHeight,behavior:"smooth"});else{let d=M.messageArea.firstChild;M.messageArea.insertBefore(s,d)}}function K(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",T&&navigator.clearAppBadge(),I=0)}),M.messageInput.addEventListener("input",function(e){""===e.target.innerText.trim()&&(e.target.innerHTML="")}),M.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:y||e.shiftKey||(e.preventDefault(),D());break;case 85:case 66:e.ctrlKey&&e.preventDefault()}}),y&&document.body.classList.add("mobile"),("setAppBadge"in navigator||"clearAppBadge"in navigator)&&(T=!0),M.sendButton.onclick=D,M.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,K((e.clipboardData||window.clipboardData).getData("text/plain")))},document.onkeydown=function(e){switch(e.keyCode){case 191:"true"===M.messageInput.getAttribute("contenteditable")&&document.activeElement!==M.messageInput&&document.activeElement!==M.searchInput&&(e.preventDefault(),f(".xtsARDHTI").focus());break;case 75:e.ctrlKey&&E&&(e.preventDefault(),M.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),document.oncontextmenu=function(e){e.preventDefault()},f(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){C="",f(".main").classList.remove("x8VAGH6N2"),M.messageInput.innerHTML="",M.messageInput.setAttribute("contenteditable","false"),M.messageInput.setAttribute("tabindex","-1"),M.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var R=0;function j(e){let t=Math.floor((Date.now()-e)/1e3);return t<60?`${t}秒`:t<3600?`${Math.floor(t/60)}分鐘`:t<86400?`${Math.floor(t/3600)}小時`:t<2592e3?`${Math.floor(t/86400)}天`:t<31536e3?`${Math.floor(t/2592e3)}個月`:`${Math.floor(t/31536e3)}年前`}function Y(e){let t=["B","KB","MB","GB","TB"],a=e,s=0;for(;a>=1024&&s<t.length-1;)a/=1024,s++;return`${a.toFixed(2)} ${t[s]}`}document.addEventListener("touchend",function(e){var t=(new Date).getTime();t-R<=300&&e.preventDefault(),R=t},!1),document.addEventListener("gesturestart",function(e){e.preventDefault()}),M.messageInput.addEventListener("drop",e=>{e.preventDefault();let t=e.dataTransfer.getData("text/plain");try{e.target.focus(),document.execCommand("insertHTML",!0,K(t))}catch(a){console.log(a)}}),M.searchInput.oninput=e=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(t=>{t.getAttribute("data-roomname").toLowerCase().includes(e.target.value.toLowerCase())?t.classList.remove("hide"):t.classList.add("hide")})},f(".x8u3Iqtu9").onclick=function(){M.searchInput.focus()},M.messageInput.oncopy=e=>{e.preventDefault();let t=window.getSelection().toString();e.clipboardData.setData("text/plain",t)},M.messageArea.addEventListener("scroll",function(){0===(M.messageArea.pageYOffset||M.messageArea.scrollTop)&&async function(e){try{if(void 0!==$){let t=await g(h(p(G,"chats",e,"messages"),b("timestamp","desc"),x($),L(10)));$=10===t.docs.length?t.docs[9]:void 0,t.forEach(e=>{let t=e.data();t.senderUID===A?H(t.content,e.id,!1):B(t.content,e.id,t.sender,j(t.timestamp),!1)});let a=M.messageArea.scrollHeight;M.messageArea.scrollTop=a-V,V=a}}catch(s){console.error("Error fetching messages: ",s)}}(C)});let O=e({apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"}),G=c(O),U=r(O),V;window.onload=async function(){let e=await g(p(G,"chats"));f(".xemr1y6ie .spinner").remove(),e.forEach(e=>{var t=e.data();-1!==t.members.indexOf(A)&&async function(e,t,a){var s,n,i,r,l,d,o;let c,m,u,x,w;s=e,n=a,i=t,r=(await g(p(G,"chats",a,"messages"))).size,c=document.createElement("div"),m=document.createElement("div"),u=document.createElement("div"),x=document.createElement("div"),c.setAttribute("tabindex","0"),c.classList.add("x2fP9fkxS"),v(p(G,"chats",d=n,"messages"),e=>{e.metadata.fromCache||e.docChanges().forEach(e=>{if(C!==d)return;let t=e.doc.data();switch(e.type){case"added":t.senderUID!==A&&("hidden"===document.visibilityState&&(I++,document.title=`(${I}) Structure`,T&&navigator.setAppBadge(I)),B(t.content,e.doc.id,t.sender,"現在"));break;case"removed":try{(s=f(`.xikyLwDf4 .xVC8gtuyS[data-mid="${e.doc.id}"]`)).classList.add("deleted"),s.innerHTML="這則訊息已被刪除"}catch(a){console.log("發生未知錯誤",a)}break;case"modified":try{var s;(s=f(`.xikyLwDf4 .xVC8gtuyS[data-mid="${e.doc.id}"] .xMyW2iRSH`)).innerHTML=t.content}catch(n){console.log("發生未知錯誤",n)}}})},e=>{console.error("監聽錯誤:",e)}),w=async()=>{(C!==n||y)&&($=void 0,async function(e){let t=await g(h(p(G,"chats",e,"messages"),b("timestamp","desc"),L(10)));t.docs[9]&&($=t.docs[9]);let a=[];t.forEach(e=>{a.push(e)}),a.reverse(),a.forEach(e=>{var t=e.data();t.senderUID===A?H(t.content,e.id):B(t.content,e.id,t.sender,j(t.timestamp))}),V=M.messageArea.scrollHeight}(C=n),M.messageArea.innerHTML="",M.sendButton.classList.remove("disabled"),M.fileInput.removeAttribute("disabled"),M.messageInput.setAttribute("contenteditable","true"),y||(f(".x2fP9fkxS.active")&&f(".x2fP9fkxS.active").classList.remove("active"),f(".x2fP9fkxS.interim:not(.active)")&&f(".x2fP9fkxS.interim:not(.active)").remove(),c.classList.add("active")),y&&f(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),f(".main").classList.add("x8VAGH6N2"),f(".xvwhg72ii").innerText=c.getAttribute("data-roomName"),M.messageInput.setAttribute("contenteditable","true"),M.messageInput.setAttribute("tabindex","0"),M.sendButton.setAttribute("tabindex","0"))},c.onclick=function(){w()},c.onkeydown=function(e){13===e.keyCode&&w()},c.setAttribute("data-roomid",n),c.setAttribute("data-roomname",s),c.appendChild(m),m.classList.add("xQ65c0Nkc"),u.classList.add("xybvM5cRF"),m.appendChild(u),u.innerText=s,x.classList.add("xT3Ta8vKw"),l=i||(0===r?"暫無訊息":`${(o=r).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")} 則訊息`),x.innerHTML=`
		<span class="x97KBA8qs">${l}</span>
	`,m.appendChild(x),f(".xemr1y6ie").appendChild(c)}(t.name,t.description,e.id)})};let W=new s,P=t();n(P,e=>{e?(A=e.uid,w=e.displayName,function(){if(!1===S){M.searchInput.removeAttribute("disabled"),M.searchInput.setAttribute("tabindex","0"),M.messageArea.classList.remove("xVjpzmyej"),f(".xnKzgeITl")&&f(".xnKzgeITl").remove();var e=(new Date).getHours();B("{dl}好，歡迎回來，現在就開始對話吧！".replace("{dl}",e>=5&&e<11?"早上":e>=11&&e<14?"中午":e>=14&&e<18?"下午":"晚安"),"0","陌生人","現在"),S=!0,E=!0}}()):(M.signInModal.classList.add("show"),A="",console.log("User is signed out"))}),M.signOutBtn.onclick=()=>{i(P).then(()=>{console.log("User signed out")}).catch(e=>{console.error("Sign out error",e)})},M.signInBtn1.onclick=function(){a(P,W).then(e=>{s.credentialFromResult(e).accessToken;let t=e.user;A=t.uid,w=t.displayName,M.signInModalContent.innerHTML=`<div class="xJ0pEZGEO">已成功登入Google帳號</div>
					<div class="xDmLoXo3E">
					<img class="xm7NzrczQ" draggable="false" src="${t.photoURL}" alt="avatar"/>
					<div class="xDLBHn55v"><div class="xQ6IT8O6S">${t.displayName}</div>
					<div class="xPnpcvswL">${t.email}</div></div></div>`,M.signInModal.onclick=function(){M.signInModal.classList.remove("show"),setTimeout(function(){M.signInModal.remove()},500)}}).catch(e=>{s.credentialFromError(e),console.log(e.code,e.message)})},M.fileInput.onchange=function(e){let t=e.target.files[0];if(t.size/1024/1024>5)return M.actionModalContent.classList.add("show"),M.actionModalTitle.innerText="這個文件太大了",M.actionModalSubtitle.innerText=`這個文件足足有 ${Y(t.size)}，我們無法負擔`,f(".xCECpHDwZ").classList.remove("show"),void(M.actionModalOverlay.onclick=function(){M.actionModal.classList.remove("show")});M.actionModalOverlay.onclick=function(){};let a=l(U,"uploads/"+t.name);M.actionModalContent.classList.add("show"),M.actionModalTitle.innerText="正在努力上傳中",M.actionModalSubtitle.innerText="這可能需要一點時間，請耐心等待...",f(".xCECpHDwZ").classList.add("show"),f(".xTGGn7ABj").innerText=t.name,f(".xtyaQiCLO").innerText=Y(t.size);let s=d(a,t);s.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;f(".xk0osKWCK").style.width=`${t}%`,console.log("Upload is "+t+"% done")},e=>{console.error("上传失败:",e)},async()=>{M.actionModalOverlay.onclick=function(){M.actionModal.classList.remove("show")},M.actionModalTitle.innerText="完成上傳",M.actionModalSubtitle.innerText="這個文件已成功上傳，你的好友可以訪問了",f(".xCECpHDwZ").classList.remove("show");let e=await o(s.snapshot.ref),a=`我剛剛上傳了一個名為「${t.name}」的文件，<a href="${e}" class="x0ciSQShX" target="_blank">點擊下載</a>`,n=u(p(G,"chats",C,"messages"));await m(n,{senderUID:A,sender:w,content:a,timestamp:Date.now()}),k(a,n.id),M.fileInput.value=""})}})();
