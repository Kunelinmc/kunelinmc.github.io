import{initializeApp as e}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as t,signInWithPopup as n,GoogleAuthProvider as s,onAuthStateChanged as a,signOut as o}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as i,ref as r,uploadBytesResumable as c,getDownloadURL as d}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as l,collection as p,setDoc as m,doc as u,getDocs as g,startAfter as f,onSnapshot as v,query as h,orderBy as x,limit as b}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";let firebaseConfig={apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"},_=function(e){return document.querySelector(e)},isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var lastDoc,userID,userName,currentRoom,currentRoom="",isAppBadgeSupport=!1,unreadCount=0;let components={activitybar:_(".activitybar"),sidebar:_(".sidebar"),main:_(".main"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageArea:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),actionModalContent:_(".x54SkYRT0"),actionModal:_(".x54SkYRT0"),actionModalTitle:_(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:_(".xWDUelLWA"),actionModalOverlay:_(".x54SkYRT0 .overlay"),actionModalIcon:_(".x3DtTJteF"),signInBtn1:_(".xYIKBnbHS#x7BYgkdiJ"),signInBtn2:_(".xYIKBnbHS#xBnuWNG6V"),signInBtn3:_(".xYIKBnbHS#xWmsCDNbu"),signInModal:_(".xUO0M1BpL"),signInModalContent:_(".xUO0M1BpL .content"),signInModalTitle:_(".xUO0M1BpL .xrYn5ZY3v"),signOutBtn:_(".xlifWPlRj#x8Kzd47QX"),openSettingsBtn:_(".xlifWPlRj#x93dGr74c")},sensitiveWords=["幹","操","草","白癡","智障","死","笨蛋","傻逼"];var _N0=!1,_GF=!1;async function handleSendMessage(){let e=replaceSensitiveWords(replaceUrlsWithLinks(components.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;")));if(!e)return;components.messageInput.innerHTML="";let t=u(p(db,"chats",currentRoom,"messages"));await m(t,{senderUID:userID,sender:userName,content:e,timestamp:Date.now()}),displaySentMessage(e,t.id)}function displaySentMessage(e,t){let n=document.createElement("div"),s=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");r.classList.add("xRHoYYwoZ"),s.classList.add("xMyW2iRSH"),n.classList.add("xVC8gtuyS"),n.classList.add("xiOw4dg0O"),a.classList.add("xKljxgVJA"),o.classList.add("xu4Celbbq"),i.classList.add("xc4iCj2Gy"),n.appendChild(a),a.appendChild(r),r.appendChild(o),o.appendChild(i),r.appendChild(s),i.innerHTML="我",s.innerHTML=e,components.messageArea.appendChild(n),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});try{n.setAttribute("data-mid",t)}catch(c){console.log("無法設置該元素參數：",c)}}function displayReceivedMessage(e,t,n,s,a=!0){let o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),d=document.createElement("div"),l=document.createElement("div"),p=document.createElement("div"),m=document.createElement("div"),u=document.createElement("div");if(u.classList.add("xRHoYYwoZ"),i.classList.add("xMyW2iRSH"),o.classList.add("xVC8gtuyS"),r.classList.add("xSYcbYqTG"),c.classList.add("xKljxgVJA"),d.classList.add("xu4Celbbq"),l.classList.add("xc4iCj2Gy"),p.classList.add("xuvoVURIs"),m.classList.add("xt8fROB2L"),p.innerText=" • ",m.innerText=s,o.setAttribute("data-mid",t),o.appendChild(r),o.appendChild(c),c.appendChild(u),u.appendChild(d),d.appendChild(l),d.appendChild(p),d.appendChild(m),u.appendChild(i),l.innerText=n,i.innerHTML=e,a)components.messageArea.appendChild(o),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let g=components.messageArea.firstChild;components.messageArea.insertBefore(o,g)}}function replaceUrlsWithLinks(e){return e.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){return'<a class="x0ciSQShX" href="'.concat(e,'" target="_blank">').concat(decodeURIComponent(e),"</a>")})}function _A2(){if(!1===_GF){components.searchInput.removeAttribute("disabled"),components.searchInput.setAttribute("tabindex","0"),components.messageArea.classList.remove("xVjpzmyej"),_(".xnKzgeITl")&&_(".xnKzgeITl").remove();var e=new Date().getHours();displayReceivedMessage(`{dl}好，歡迎回來，現在就開始對話吧！`.replace("{dl}",e>=5&&e<11?"早上":e>=11&&e<14?"中午":e>=14&&e<18?"下午":"晚上"),"0","陌生人","現在"),_GF=!0,_N0=!0}}function _A22(e,t,n=!0){var s=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");if(r.classList.add("xRHoYYwoZ"),a.classList.add("xMyW2iRSH"),s.classList.add("xVC8gtuyS"),o.classList.add("xKljxgVJA"),i.classList.add("xu4Celbbq"),s.setAttribute("data-mid",t),s.appendChild(o),o.appendChild(r),r.appendChild(i),r.appendChild(a),a.innerHTML=e,s.classList.add("xiOw4dg0O"),i.innerHTML='<div class="xc4iCj2Gy">你</div>',n)components.messageArea.appendChild(s),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let c=components.messageArea.firstChild;components.messageArea.insertBefore(s,c)}}function protectHtml(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",isAppBadgeSupport&&navigator.clearAppBadge(),unreadCount=0)}),components.messageInput.addEventListener("input",function(e){""===e.target.innerText.trim()&&(e.target.innerHTML="")}),components.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:isMobileDevice||e.shiftKey||(e.preventDefault(),handleSendMessage());break;case 85:case 66:e.ctrlKey&&e.preventDefault()}}),isMobileDevice&&document.body.classList.add("mobile"),("setAppBadge"in navigator||"clearAppBadge"in navigator)&&(isAppBadgeSupport=!0),components.sendButton.onclick=handleSendMessage,components.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,protectHtml((e.clipboardData||window.clipboardData).getData("text/plain")))},document.onkeydown=function(e){switch(e.keyCode){case 191:"true"===components.messageInput.getAttribute("contenteditable")&&document.activeElement!==components.messageInput&&document.activeElement!==components.searchInput&&(e.preventDefault(),_(".xtsARDHTI").focus());break;case 75:e.ctrlKey&&_N0&&(e.preventDefault(),components.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),document.oncontextmenu=function(e){e.preventDefault()},_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){currentRoom="",_(".main").classList.remove("x8VAGH6N2"),components.messageInput.innerHTML="",components.messageInput.setAttribute("contenteditable","false"),components.messageInput.setAttribute("tabindex","-1"),components.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var lastTouchEndTime=0;function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceSensitiveWords(e){let t=sensitiveWords.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),n=RegExp(t.join("|"),"gi");return e.replace(n,e=>"*".repeat(e.length))}function createChatRoom(e,t,n,s){let a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");a.setAttribute("tabindex","0"),a.classList.add("x2fP9fkxS"),createListener(t);let c=async()=>{(currentRoom!==t||isMobileDevice)&&(lastDoc=void 0,currentRoom=t,loadChatHistory(currentRoom),components.messageArea.innerHTML="",components.sendButton.classList.remove("disabled"),components.fileInput.removeAttribute("disabled"),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice||(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),_(".x2fP9fkxS.interim:not(.active)")&&_(".x2fP9fkxS.interim:not(.active)").remove(),a.classList.add("active")),isMobileDevice&&_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),_(".main").classList.add("x8VAGH6N2"),_(".xvwhg72ii").innerText=a.getAttribute("data-roomName"),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.setAttribute("tabindex","0"),components.sendButton.setAttribute("tabindex","0"))};a.onclick=function(){c()},a.onkeydown=function(e){13===e.keyCode&&(components.messageArea.innerHTML="",c())},a.setAttribute("data-roomid",t),a.setAttribute("data-roomname",e),a.appendChild(o),o.classList.add("xQ65c0Nkc"),i.classList.add("xybvM5cRF"),o.appendChild(i),i.innerText=e,r.classList.add("xT3Ta8vKw"),r.innerHTML=`
		<span class="x97KBA8qs"><span class="x0o9XxPwY">${formatNumberWithCommas(n)}</span> 則訊息</span><span class="xVSkoFFmK">•</span><span class="x6EjoHfJB">${s}</span>
	`,o.appendChild(r),_(".xemr1y6ie").appendChild(a)}function timeAgo(e){let t=Math.floor((Date.now()-e)/1e3);return t<60?`${t}秒`:t<3600?`${Math.floor(t/60)}分鐘`:t<86400?`${Math.floor(t/3600)}小時`:t<2592e3?`${Math.floor(t/86400)}天`:t<31536e3?`${Math.floor(t/2592e3)}個月`:`${Math.floor(t/31536e3)}年前`}function formatFileSize(e){let t=["B","KB","MB","GB","TB"],n=e,s=0;for(;n>=1024&&s<t.length-1;)n/=1024,s++;return`${n.toFixed(2)} ${t[s]}`}document.addEventListener("touchend",function(e){var t=new Date().getTime();t-lastTouchEndTime<=300&&e.preventDefault(),lastTouchEndTime=t},!1),document.addEventListener("gesturestart",function(e){e.preventDefault()}),components.messageInput.addEventListener("drop",e=>{e.preventDefault();let t=e.dataTransfer.getData("text/plain");try{e.target.focus(),document.execCommand("insertHTML",!0,protectHtml(t))}catch(n){console.log(n)}}),components.searchInput.oninput=e=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(t=>{t.getAttribute("data-roomname").toLowerCase().includes(e.target.value.toLowerCase())?t.classList.remove("hide"):t.classList.add("hide")})},_(".x8u3Iqtu9").onclick=function(){components.searchInput.focus()},components.messageInput.oncopy=e=>{e.preventDefault();let t=window.getSelection().getRangeAt(0),n=document.createElement("div");n.appendChild(t.cloneContents());let s=n.textContent||n.innerText||"";e.clipboardData.setData("text/plain",s)},components.messageArea.addEventListener("scroll",function(){0===(components.messageArea.pageYOffset||components.messageArea.scrollTop)&&loadMoreChatHistory(currentRoom)});let app=e(firebaseConfig),db=l(app),storage=i(app);async function _A2653(e,t){var n=await g(p(db,"chats",t,"messages"));createChatRoom(e,t,n.size,"現在")}async function loadMoreChatHistory(e){try{if(void 0!==lastDoc){let t=await g(h(p(db,"chats",e,"messages"),x("timestamp","desc"),f(lastDoc),b(10)));t.docs[9]&&(lastDoc=t.docs[9]),t.forEach(e=>{var t=e.data();t.senderUID===userID?_A22(t.content,e.id,!1):displayReceivedMessage(t.content,t.id,t.sender,timeAgo(t.timestamp),!1)}),(void 0==t.docs[9]||null==t.docs[9])&&(lastDoc=void 0)}}catch(n){}}async function loadChatHistory(e){let t=await g(h(p(db,"chats",e,"messages"),x("timestamp","desc"),b(10)));t.docs[9]&&(lastDoc=t.docs[9]);let n=[];t.forEach(e=>{n.push(e)}),n.reverse(),n.forEach(e=>{var t=e.data();t.senderUID===userID?_A22(t.content,e.id):displayReceivedMessage(t.content,e.id,t.sender,timeAgo(t.timestamp))})}function createListener(e){v(p(db,"chats",e,"messages"),t=>{t.metadata.fromCache||t.docChanges().forEach(t=>{let n=t.doc.data();if("added"===t.type)"hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) Structure`,isAppBadgeSupport&&navigator.setAppBadge(unreadCount)),e===currentRoom&&n.senderUID!==userID&&displayReceivedMessage(n.content,t.doc.id,n.sender,"現在");else if("removed"===t.type&&currentRoom===e)try{var s=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${t.doc.id}"]`);s.classList.add("deleted"),s.innerHTML="這則訊息已被刪除"}catch(a){console.log("發生未知錯誤",a)}})},e=>{console.error("監聽錯誤:",e)})}window.onload=async function(){let e=await g(p(db,"chats"));_(".xemr1y6ie .spinner").remove(),e.forEach(e=>{var t=e.data();-1!==t.members.indexOf(userID)&&_A2653(t.name,e.id)})};let provider=new s,auth=t(),SignInWidthGoogle=function(){n(auth,provider).then(e=>{s.credentialFromResult(e).accessToken;let t=e.user;userID=t.uid,userName=t.displayName,components.signInModalContent.innerHTML=`<div class="xJ0pEZGEO">已成功登入Google帳號</div>
					<div class="xDmLoXo3E">
					<img class="xm7NzrczQ" draggable="false" src="${t.photoURL}" alt="avatar"/>
					<div class="xDLBHn55v"><div class="xQ6IT8O6S">${t.displayName}</div>
					<div class="xPnpcvswL">${t.email}</div></div></div>`,components.signInModal.onclick=function(){components.signInModal.classList.remove("show"),setTimeout(function(){components.signInModal.remove()},500)}}).catch(e=>{s.credentialFromError(e),console.log(e.code,e.message)})};a(auth,e=>{e?(userID=e.uid,userName=e.displayName,_A2()):(components.signInModal.classList.add("show"),userID="",console.log("User is signed out"))}),components.signOutBtn.onclick=()=>{o(auth).then(()=>{console.log("User signed out")}).catch(e=>{console.error("Sign out error",e)})},components.signInBtn1.onclick=function(){SignInWidthGoogle()},components.fileInput.onchange=function(e){let t=e.target.files[0];if(t.size/1024/1024>5){components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="這個文件太大了",components.actionModalSubtitle.innerText=`這個文件足足有 ${formatFileSize(t.size)}，我們無法負擔`,_(".xCECpHDwZ").classList.remove("show"),components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")};return}components.actionModalOverlay.onclick=function(){};let n=r(storage,"uploads/"+t.name);components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="正在努力上傳中",components.actionModalSubtitle.innerText="這可能需要一點時間，請耐心等待...",_(".xCECpHDwZ").classList.add("show"),_(".xTGGn7ABj").innerText=t.name,_(".xtyaQiCLO").innerText=formatFileSize(t.size);let s=c(n,t);s.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;_(".xk0osKWCK").style.width=`${t}%`,console.log("Upload is "+t+"% done")},e=>{console.error("上传失败:",e)},async()=>{components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")},components.actionModalTitle.innerText="完成上傳",components.actionModalSubtitle.innerText="這個文件已成功上傳，你的好友可以訪問了",_(".xCECpHDwZ").classList.remove("show");let e=await d(s.snapshot.ref),n=`我剛剛上傳了一個名為「${t.name}」的文件，<a href="${e}" class="x0ciSQShX" target="_blank">點擊下載</a>`,a=u(p(db,"chats",currentRoom,"messages"));await m(a,{senderUID:userID,sender:userName,content:n,timestamp:Date.now()}),displaySentMessage(n,a.id),components.fileInput.value=""})};
