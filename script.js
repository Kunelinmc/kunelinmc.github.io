import{initializeApp as t}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getAuth as n,signInWithPopup as a,GoogleAuthProvider as o,onAuthStateChanged as i,signOut as r}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";import{getStorage as c,ref as l,uploadBytesResumable as d,getDownloadURL as p}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getFirestore as m,collection as u,setDoc as g,doc as v,getDocs as f,startAfter as h,onSnapshot as x,query as b,orderBy as L,limit as y}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";let firebaseConfig={apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"},_=function(t){return document.querySelector(t)},isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550;var lastDoc,userID,userName,currentRoom,currentRoom="",unreadCount=0;let components={activitybar:_(".activitybar"),sidebar:_(".sidebar"),main:_(".main"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageArea:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),actionModalContent:_(".x54SkYRT0"),actionModal:_(".x54SkYRT0"),actionModalTitle:_(".x54SkYRT0 .xrYn5ZY3v"),actionModalSubtitle:_(".xWDUelLWA"),actionModalOverlay:_(".x54SkYRT0 .overlay"),actionModalIcon:_(".x3DtTJteF"),signInBtn1:_(".xYIKBnbHS#x7BYgkdiJ"),signInBtn2:_(".xYIKBnbHS#xBnuWNG6V"),signInBtn3:_(".xYIKBnbHS#xWmsCDNbu"),signInModal:_(".xUO0M1BpL"),signInModalContent:_(".xUO0M1BpL .content"),signInModalTitle:_(".xUO0M1BpL .xrYn5ZY3v"),signOutBtn:_(".xlifWPlRj#x8Kzd47QX")},sensitiveWords=["幹","操","草","白癡","智障","死","笨蛋","靠北"];var _N0=!1,_GF=!1;async function handleSendMessage(){let t=replaceSensitiveWords(replaceUrlsWithLinks(components.messageInput.innerText.trim().replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;")));if(!t)return;components.messageInput.innerHTML="";let n=v(u(db,"chats",currentRoom,"messages"));await g(n,{senderUID:userID,sender:userName,content:t,timestamp:Date.now()}),displaySentMessage(t,n.id)}function displaySentMessage(t,n){let a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div");l.classList.add("xRHoYYwoZ"),o.classList.add("xMyW2iRSH"),a.classList.add("xVC8gtuyS"),a.classList.add("xiOw4dg0O"),i.classList.add("xKljxgVJA"),r.classList.add("xu4Celbbq"),c.classList.add("xc4iCj2Gy"),a.appendChild(i),i.appendChild(l),l.appendChild(r),r.appendChild(c),l.appendChild(o),c.innerHTML="我",o.innerHTML=t,components.messageArea.appendChild(a),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});try{a.setAttribute("data-mid",n)}catch(d){console.log("無法設置該元素參數：",d)}}function displayReceivedMessage(t,n,a,o,i=!0){let r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),p=document.createElement("div"),m=document.createElement("div"),u=document.createElement("div"),g=document.createElement("div"),v=document.createElement("div");if(v.classList.add("xRHoYYwoZ"),c.classList.add("xMyW2iRSH"),r.classList.add("xVC8gtuyS"),l.classList.add("xSYcbYqTG"),d.classList.add("xKljxgVJA"),p.classList.add("xu4Celbbq"),m.classList.add("xc4iCj2Gy"),u.classList.add("xuvoVURIs"),g.classList.add("xt8fROB2L"),u.innerText=" • ",g.innerText=o,r.setAttribute("data-mid",n),r.appendChild(l),r.appendChild(d),d.appendChild(v),v.appendChild(p),p.appendChild(m),p.appendChild(u),p.appendChild(g),v.appendChild(c),m.innerText=a,c.innerHTML=t,i)components.messageArea.appendChild(r),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let f=components.messageArea.firstChild;components.messageArea.insertBefore(r,f)}}function replaceUrlsWithLinks(t){return t.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(t){return'<a class="x0ciSQShX" href="'.concat(t,'" target="_blank">').concat(decodeURIComponent(t),"</a>")})}function _A2(){if(!1===_GF){components.searchInput.removeAttribute("disabled"),components.searchInput.setAttribute("tabindex","0"),components.messageArea.classList.remove("xVjpzmyej"),_(".xnKzgeITl")&&_(".xnKzgeITl").remove();var t=new Date().getHours();displayReceivedMessage(`{dl}好，歡迎回來，現在就開始對話吧！`.replace("{dl}",t>=5&&t<11?"早上":t>=11&&t<14?"中午":t>=14&&t<18?"下午":"晚上"),"0","陌生人","現在"),_GF=!0,_N0=!0}}function _A17(t){var n=t.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;"),a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div");c.classList.add("xRHoYYwoZ"),o.classList.add("xMyW2iRSH"),a.classList.add("xVC8gtuyS"),i.classList.add("xKljxgVJA"),r.classList.add("xu4Celbbq"),a.appendChild(i),i.appendChild(c),c.appendChild(r),c.appendChild(o);var l=replaceUrlsWithLinks(n).trim().replace(/(\r?\n){3,}/g,"\n\n").replace(/\n+$/,"").replaceAll("\n","<br>");o.innerHTML=replaceSensitiveWords(l),a.classList.add("xiOw4dg0O"),r.innerHTML='<div class="xc4iCj2Gy">你</div>',sendMessage(currentRoom,l,a),components.messageArea.appendChild(a),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"})}function _A22(t,n,a=!0){var o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div");if(l.classList.add("xRHoYYwoZ"),i.classList.add("xMyW2iRSH"),o.classList.add("xVC8gtuyS"),r.classList.add("xKljxgVJA"),c.classList.add("xu4Celbbq"),o.setAttribute("data-mid",n),o.appendChild(r),r.appendChild(l),l.appendChild(c),l.appendChild(i),i.innerHTML=replaceSensitiveWords(t),o.classList.add("xiOw4dg0O"),c.innerHTML='<div class="xc4iCj2Gy">你</div>',a)components.messageArea.appendChild(o),components.messageArea.scrollTo({top:components.messageArea.scrollHeight,behavior:"smooth"});else{let d=components.messageArea.firstChild;components.messageArea.insertBefore(o,d)}}function protectHtml(t){return t.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(document.title="Structure",unreadCount=0)}),components.messageInput.addEventListener("input",function(t){""===t.target.innerText.trim()&&(t.target.innerHTML="")}),components.messageInput.addEventListener("keydown",function(t){switch(t.keyCode){case 13:isMobileDevice||t.shiftKey||(t.preventDefault(),handleSendMessage());break;case 85:case 66:t.ctrlKey&&t.preventDefault()}}),isMobileDevice&&document.body.classList.add("mobile"),components.sendButton.onclick=handleSendMessage,components.messageInput.onpaste=function(t){t.preventDefault(),document.execCommand("insertHTML",!0,protectHtml((t.clipboardData||window.clipboardData).getData("text/plain")))},document.onkeydown=function(t){switch(t.keyCode){case 191:"true"===components.messageInput.getAttribute("contenteditable")&&document.activeElement!==components.messageInput&&document.activeElement!==components.searchInput&&(t.preventDefault(),_(".xtsARDHTI").focus());break;case 75:t.ctrlKey&&_N0&&(t.preventDefault(),components.searchInput.focus());break;case 123:t.preventDefault();break;case 67:t.ctrlKey&&t.shiftKey&&t.preventDefault();break;case 85:case 79:case 187:case 189:case 80:case 83:t.ctrlKey&&t.preventDefault();break;case 37:case 39:t.altKey&&t.preventDefault()}},document.querySelectorAll("body > div").forEach(function(t){t.onwheel=function(t){t.ctrlKey&&t.preventDefault()}}),document.oncontextmenu=function(t){t.preventDefault()},_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").onclick=function(){currentRoom="",_(".main").classList.remove("x8VAGH6N2"),components.messageInput.innerHTML="",components.messageInput.setAttribute("contenteditable","false"),components.messageInput.setAttribute("tabindex","-1"),components.sendButton.setAttribute("tabindex","-1")},document.addEventListener("touchstart",function(t){t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1});var lastTouchEndTime=0;document.addEventListener("touchend",function(t){var n=new Date().getTime();n-lastTouchEndTime<=300&&t.preventDefault(),lastTouchEndTime=n},!1),document.addEventListener("gesturestart",function(t){t.preventDefault()});var _f991=!0;function formatNumberWithCommas(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceSensitiveWords(t){let n=sensitiveWords.map(t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),a=RegExp(n.join("|"),"gi");return t.replace(a,t=>"*".repeat(t.length))}function createChatRoom(t,n,a,o){let i=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div");i.setAttribute("tabindex","0"),i.classList.add("x2fP9fkxS"),createListener(n);let d=async()=>{(currentRoom!==n||isMobileDevice)&&(lastDoc=void 0,currentRoom=n,loadChatHistory(currentRoom),components.messageArea.innerHTML="",components.sendButton.classList.remove("disabled"),components.fileInput.removeAttribute("disabled"),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice||(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),_(".x2fP9fkxS.interim:not(.active)")&&_(".x2fP9fkxS.interim:not(.active)").remove(),i.classList.add("active")),isMobileDevice&&_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").setAttribute("tabindex","0"),_(".main").classList.add("x8VAGH6N2"),_(".xvwhg72ii").innerText=i.getAttribute("data-roomName"),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.setAttribute("tabindex","0"),components.sendButton.setAttribute("tabindex","0"))};i.onclick=function(){d()},i.onkeydown=function(t){13===t.keyCode&&(components.messageArea.innerHTML="",d())},i.setAttribute("data-roomid",n),i.setAttribute("data-roomname",t),i.appendChild(r),r.classList.add("xQ65c0Nkc"),c.classList.add("xybvM5cRF"),r.appendChild(c),c.innerText=t,l.classList.add("xT3Ta8vKw"),l.innerHTML=`
		<span class="x97KBA8qs"><span class="x0o9XxPwY">${formatNumberWithCommas(a)}</span> 則訊息</span><span class="xVSkoFFmK">•</span><span class="x6EjoHfJB">${o}</span>
	`,r.appendChild(l),_(".xemr1y6ie").appendChild(i)}function timeAgo(t){let n=Math.floor((Date.now()-t)/1e3);return n<60?`${n}秒`:n<3600?`${Math.floor(n/60)}分鐘`:n<86400?`${Math.floor(n/3600)}小時`:n<2592e3?`${Math.floor(n/86400)}天`:n<31536e3?`${Math.floor(n/2592e3)}個月`:`${Math.floor(n/31536e3)}年前`}function formatFileSize(t){let n=["Byte","KB","MB","GB","TB"],a=t,o=0;for(;a>=1024&&o<n.length-1;)a/=1024,o++;return`${a.toFixed(2)} ${n[o]}`}components.messageInput.addEventListener("drop",t=>{t.preventDefault();let n=t.dataTransfer.getData("text/plain");try{t.target.focus(),document.execCommand("insertHTML",!0,protectHtml(n))}catch(a){console.log(a)}}),components.searchInput.oninput=t=>{document.querySelectorAll(".x8FrVw7Ca .x2fP9fkxS").forEach(n=>{n.getAttribute("data-roomname").toLowerCase().includes(t.target.value.toLowerCase())?n.classList.remove("hide"):n.classList.add("hide")})},_(".x8u3Iqtu9").onclick=function(){components.searchInput.focus()},components.searchInput.onblur=()=>{setTimeout(function(){window.scrollTo(0,0)},500)},components.messageInput.oncopy=t=>{t.preventDefault();let n=window.getSelection().getRangeAt(0),a=document.createElement("div");a.appendChild(n.cloneContents());let o=a.textContent||a.innerText||"";t.clipboardData.setData("text/plain",o)},components.messageArea.addEventListener("scroll",function(){0===(components.messageArea.pageYOffset||components.messageArea.scrollTop)&&loadMoreChatHistory(currentRoom)});let app=t(firebaseConfig),db=m(app),storage=c(app);async function _A2653(t,n){var a=await f(u(db,"chats",n,"messages"));createChatRoom(t,n,a.size,"現在")}async function sendMessage(t,n,a){try{let o=v(u(db,"chats",e,"messages"));try{a.setAttribute("data-mid",o.id)}catch(i){console.log("無法設置該元素參數：",i)}await g(o,{senderUID:window.UserID,sender:window.UserName,content:s,timestamp:Date.now()})}catch(r){console.error("Error adding message: ",r)}}async function loadMoreChatHistory(t){try{if(void 0!==lastDoc){let n=await f(b(u(db,"chats",t,"messages"),L("timestamp","desc"),h(lastDoc),y(10)));n.docs[9]&&(lastDoc=n.docs[9]),n.forEach(t=>{var n=t.data();n.senderUID===userID?_A22(n.content,t.id,!1):displayReceivedMessage(n.content,n.id,n.sender,timeAgo(n.timestamp),!1)}),(void 0==n.docs[9]||null==n.docs[9])&&(lastDoc=void 0)}}catch(a){}}async function loadChatHistory(t){let n=await f(b(u(db,"chats",t,"messages"),L("timestamp","desc"),y(10)));n.docs[9]&&(lastDoc=n.docs[9]);let a=[];n.forEach(t=>{a.push(t)}),a.reverse(),a.forEach(t=>{var n=t.data();n.senderUID===userID?_A22(n.content,t.id):displayReceivedMessage(n.content,t.id,n.sender,timeAgo(n.timestamp))})}function createListener(t){x(u(db,"chats",t,"messages"),n=>{n.metadata.fromCache||n.docChanges().forEach(n=>{let a=n.doc.data();if("added"===n.type)"hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) Structure`),t===currentRoom&&a.senderUID!==userID&&displayReceivedMessage(a.content,n.doc.id,a.sender,"現在");else if("removed"===n.type&&currentRoom===t)try{var o=_(`.xikyLwDf4 .xVC8gtuyS[data-mid="${n.doc.id}"]`);o.classList.add("deleted"),o.innerHTML="這則訊息已被刪除"}catch(i){console.log("發生未知錯誤",i)}})},t=>{console.error("監聽錯誤:",t)})}window.onload=async function(){let t=await f(u(db,"chats"));_(".xemr1y6ie .spinner").remove(),t.forEach(t=>{var n=t.data();-1!==n.members.indexOf(userID)&&_A2653(n.name,t.id)})};let provider=new o,auth=n(),SignInWidthGoogle=function(){a(auth,provider).then(t=>{o.credentialFromResult(t).accessToken;let n=t.user;userID=n.uid,userName=n.displayName,components.signInModalContent.innerHTML=`
					<div class="xJ0pEZGEO">已成功登入Google帳號</div>
					<div class="xDmLoXo3E">
					<img class="xm7NzrczQ" draggable="false" src="${n.photoURL}" alt="avatar"/>
					<div class="xDLBHn55v"><div class="xQ6IT8O6S">${n.displayName}</div>
					<div class="xPnpcvswL">${n.email}</div></div></div>
				`,components.signInModal.onclick=function(){components.signInModal.classList.remove("show"),setTimeout(function(){components.signInModal.remove()},500)}}).catch(t=>{o.credentialFromError(t),console.log(t.code,t.message)})};i(auth,t=>{t?(userID=t.uid,userName=t.displayName,_A2()):(components.signInModal.classList.add("show"),userID="",console.log("User is signed out"))}),components.signOutBtn.onclick=()=>{r(auth).then(()=>{console.log("User signed out")}).catch(t=>{console.error("Sign out error",t)})},components.signInBtn1.onclick=function(){SignInWidthGoogle()},components.fileInput.onchange=function(t){let n=t.target.files[0];if(n.size/1024/1024>5){components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="這個文件太大了",components.actionModalSubtitle.innerText=`這個文件足足有 ${formatFileSize(n.size)}，我們無法負擔`,_(".xCECpHDwZ").classList.remove("show"),components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")};return}components.actionModalOverlay.onclick=function(){};let a=l(storage,"uploads/"+n.name);components.actionModalContent.classList.add("show"),components.actionModalTitle.innerText="正在努力上傳中",components.actionModalSubtitle.innerText="這可能需要一點時間，請耐心等待...",_(".xCECpHDwZ").classList.add("show"),_(".xTGGn7ABj").innerText=n.name,_(".xtyaQiCLO").innerText=formatFileSize(n.size);let o=d(a,n);o.on("state_changed",t=>{let n=t.bytesTransferred/t.totalBytes*100;_(".xk0osKWCK").style.width=`${n}%`,console.log("Upload is "+n+"% done")},t=>{console.error("上传失败:",t)},async()=>{components.actionModalOverlay.onclick=function(){components.actionModal.classList.remove("show")},components.actionModalTitle.innerText="完成上傳",components.actionModalSubtitle.innerText="這個文件已成功上傳，你的好友可以訪問了",_(".xCECpHDwZ").classList.remove("show");let t=await p(o.snapshot.ref),a=`我剛剛上傳了一個名為「${n.name}」的文件，<a href="${t}" class="x0ciSQShX" target="_blank">點擊下載</a>`,i=v(u(db,"chats",currentRoom,"messages"));await g(i,{senderUID:userID,sender:userName,content:a,timestamp:Date.now()}),displaySentMessage(a,i.id),components.fileInput.value=""})};
