/**release 0.2.1*/
import{initializeApp as e}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";import{getAuth as t,signInWithPopup as i,GoogleAuthProvider as s,onAuthStateChanged as n,signInWithEmailAndPassword as a,signOut as o}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";import{getStorage as l,ref as r,uploadBytesResumable as d,getDownloadURL as c}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";import{getFirestore as h,enableIndexedDbPersistence as p,collection as u,setDoc as m,doc as g,deleteDoc as v,getDoc as $,where as x,getDocs as f,startAfter as C,onSnapshot as b,query as w,orderBy as y,arrayUnion as L,arrayRemove as k,updateDoc as M,limit as T}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";class ImageViewer{constructor(e,t={}){this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.logicalWidth=0,this.logicalHeight=0,this.devicePixelRatio=window.devicePixelRatio||1,this.updateCanvasSize(),this.options={minScale:.1,maxScale:5,onClickOutside:null,...t},this.customDrawer=null,this.lastTapTime=0,this.tapTimeout=null,this.scale=1,this.posX=0,this.posY=0,this.isDragging=!1,this.lastX=0,this.lastY=0,this.img=null,this.needsRedraw=!1,this.animationFrameId=null,this.isTouching=!1,this.initialDistance=0,this.initialScale=1,this.touchStartPosX=0,this.touchStartPosY=0,this.touchStartScale=1,this.initialCenterX=0,this.initialCenterY=0,this.rotation=0,this.velocityX=0,this.velocityY=0,this.lastTime=0,this.isInertialMoving=!1,this.decelerationRate=.85,this.minVelocityThreshold=.1,this.setupEventListeners(),this.requestRedraw()}updateCanvasSize(){let e=this.canvas.parentElement;this.logicalWidth=e.clientWidth,this.logicalHeight=e.clientHeight,this.devicePixelRatio=window.devicePixelRatio||1,this.canvas.style.width=this.logicalWidth+"px",this.canvas.style.height=this.logicalHeight+"px",this.canvas.width=Math.floor(this.logicalWidth*this.devicePixelRatio),this.canvas.height=Math.floor(this.logicalHeight*this.devicePixelRatio),this.ctx.scale(this.devicePixelRatio,this.devicePixelRatio)}setupEventListeners(){this.handleCanvasClick=this.handleCanvasClick.bind(this),this.handleCanvasTouchEnd=this.handleCanvasTouchEnd.bind(this),this.canvas.addEventListener("click",this.handleCanvasClick),this.canvas.addEventListener("touchend",this.handleCanvasTouchEnd),this.handleResize=this.handleResize.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleWheel=this.handleWheel.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.draw=this.draw.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),window.addEventListener("resize",this.handleResize),this.canvas.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("wheel",this.handleWheel),this.canvas.addEventListener("mouseleave",this.handleMouseLeave),this.canvas.addEventListener("touchstart",this.handleTouchStart),this.canvas.addEventListener("touchmove",this.handleTouchMove),this.canvas.addEventListener("touchend",this.handleTouchEnd)}getDisplayWidth(){return this.rotation%180==90?this.img.height:this.img.width}getDisplayHeight(){return this.rotation%180==90?this.img.width:this.img.height}calculateInitialScale(){if(!this.img)return;let e=this.getDisplayWidth(),t=this.getDisplayHeight(),i=this.logicalWidth/e,s=this.logicalHeight/t;this.options.minScale=Math.min(i,s,1),this.scale=this.options.minScale}centerImage(){if(!this.img)return;let e=this.getDisplayWidth()*this.scale,t=this.getDisplayHeight()*this.scale;this.posX=(this.logicalWidth-e)/2,this.posY=(this.logicalHeight-t)/2,this.enforceBounds()}setCustomDrawer(e){"function"==typeof e?this.customDrawer=e:console.error("setCustomDrawer 期望接收一个函数")}clearCustomDrawer(){this.customDrawer=null}draw(){if(this.needsRedraw){if(this.needsRedraw=!1,this.ctx.clearRect(0,0,this.logicalWidth,this.logicalHeight),this.img){this.ctx.save();let e=this.getDisplayWidth()*this.scale,t=this.getDisplayHeight()*this.scale;this.ctx.translate(this.posX+e/2,this.posY+t/2),this.ctx.rotate(this.rotation*Math.PI/180),this.ctx.scale(this.scale,this.scale),this.ctx.drawImage(this.img,-this.img.width/2,-this.img.height/2),this.ctx.restore()}this.customDrawer&&this.customDrawer(this.ctx,this)}}rotate(){this.rotation=(this.rotation+90)%360,this.calculateInitialScale(),this.centerImage(),this.requestRedraw()}loadImage(e){this.img=new Image,this.img.onload=()=>{this.rotation=0,this.calculateInitialScale(),this.centerImage(),this.requestRedraw()},this.img.src=e}enforceBounds(){if(!this.img)return;let e=this.getDisplayWidth()*this.scale,t=this.getDisplayHeight()*this.scale;e>this.logicalWidth?this.posX=Math.min(Math.max(this.posX,this.logicalWidth-e),0):this.posX=(this.logicalWidth-e)/2,t>this.logicalHeight?this.posY=Math.min(Math.max(this.posY,this.logicalHeight-t),0):this.posY=(this.logicalHeight-t)/2}isInImageArea(e,t){if(!this.img)return!1;let i=this.getDisplayWidth()*this.scale,s=this.getDisplayHeight()*this.scale,n=this.posX,a=this.posY,o=Math.min(n+i,this.logicalWidth),l=Math.min(a+s,this.logicalHeight);return e>=Math.max(n,0)&&e<=o&&t>=Math.max(a,0)&&t<=l}requestRedraw(){this.needsRedraw||(this.needsRedraw=!0,this.canvas.dispatchEvent(new MouseEvent("mousemove")),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(this.draw))}handleMouseDown(e){let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.isDraggable()&&this.isInImageArea(i,s)&&(this.isDragging=!0,this.lastX=e.clientX,this.lastY=e.clientY,this.canvas.style.cursor="grabbing")}handleMouseLeave(){this.canvas.style.cursor="default"}handleMouseMove(e){let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;if(this.isInImageArea(i,s)?this.canvas.style.cursor=this.isDragging?"grabbing":"grab":this.canvas.style.cursor="default",this.isDragging){let n=Date.now(),a=n-this.lastTime;this.lastTime=n;let o=e.clientX-this.lastX,l=e.clientY-this.lastY;this.posX+=o,this.posY+=l,a>0&&(this.velocityX=o/a,this.velocityY=l/a),this.lastX=e.clientX,this.lastY=e.clientY,this.enforceBounds(),this.requestRedraw()}}handleMouseUp(e){this.isDragging=!1,Math.abs(this.velocityX)>this.minVelocityThreshold||Math.abs(this.velocityY)>this.minVelocityThreshold?this.startInertia():(this.velocityX=0,this.velocityY=0);let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.isInImageArea(i,s)?this.canvas.style.cursor="grab":this.canvas.style.cursor="default"}startInertia(){this.isInertialMoving=!0,this.lastTime=Date.now(),this.animateInertia()}animateInertia(){if(!this.isInertialMoving)return;let e=Date.now(),t=e-this.lastTime;this.lastTime=e,this.velocityX*=Math.pow(this.decelerationRate,t/16),this.velocityY*=Math.pow(this.decelerationRate,t/16),this.posX+=this.velocityX*t,this.posY+=this.velocityY*t,this.enforceBounds(),this.requestRedraw(),Math.abs(this.velocityX)<this.minVelocityThreshold&&Math.abs(this.velocityY)<this.minVelocityThreshold?(this.isInertialMoving=!1,this.velocityX=0,this.velocityY=0):requestAnimationFrame(this.animateInertia.bind(this))}handleWheel(e){e.preventDefault();let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;if(!this.isInImageArea(i,s))return;let n=e.deltaY>0?.9:1.1,a=(i-this.posX)/this.scale,o=(s-this.posY)/this.scale,l=Math.min(Math.max(this.scale*n,this.options.minScale),this.options.maxScale);this.posX=i-a*l,this.posY=s-o*l,this.scale=l,this.enforceBounds(),this.requestRedraw()}handleTouchStart(e){if(0===e.touches.length)return;let t=Array.from(e.touches),i=this.getTouchCenter(t);this.initialCenterX=i.x,this.initialCenterY=i.y,this.touchStartPosX=this.posX,this.touchStartPosY=this.posY,this.touchStartScale=this.scale,e.touches.length>=2&&(this.initialDistance=this.getTouchDistance(e.touches[0],e.touches[1])),this.isTouching=!0}handleTouchMove(e){if(!this.isTouching)return;e.preventDefault();let t=Array.from(e.touches);if(0===t.length)return;let i=this.getTouchCenter(t),s=1;if(t.length>=2){let n=this.getTouchDistance(t[0],t[1]);this.initialDistance>0&&(s=n/this.initialDistance)}let a=Math.min(Math.max(this.touchStartScale*s,this.options.minScale),this.options.maxScale),o=(this.initialCenterX-this.touchStartPosX)/this.touchStartScale,l=(this.initialCenterY-this.touchStartPosY)/this.touchStartScale;if(this.posX=i.x-o*a,this.posY=i.y-l*a,this.scale=a,this.enforceBounds(),this.requestRedraw(),1===t.length){let r=Date.now(),d=r-this.lastTime;this.lastTime=r;let c=this.canvas.getBoundingClientRect(),h=t[0],p=h.clientX-c.left,u=h.clientY-c.top;d>0&&(this.velocityX=(p-this.lastX)/d,this.velocityY=(u-this.lastY)/d),this.lastX=p,this.lastY=u}}handleTouchEnd(){this.isTouching=!1,this.initialDistance=0,Math.abs(this.velocityX)>this.minVelocityThreshold||Math.abs(this.velocityY)>this.minVelocityThreshold?this.startInertia():(this.velocityX=0,this.velocityY=0)}handleResize(){this.updateCanvasSize(),this.img&&(this.calculateInitialScale(),this.centerImage(),this.canvas.dispatchEvent(new MouseEvent("mousemove")),this.requestRedraw())}handleCanvasClick(e){if(!this.img)return;let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.isInImageArea(i,s)||this.triggerClickOutside(e)}handleCanvasTouchEnd(e){if(!this.img||e.touches.length>0)return;let t=this.canvas.getBoundingClientRect(),i=e.changedTouches[0],s=i.clientX-t.left,n=i.clientY-t.top,a=new Date().getTime();if(a-this.lastTapTime<360){clearTimeout(this.tapTimeout);return}this.tapTimeout=setTimeout(()=>{this.isInImageArea(s,n)||this.triggerClickOutside(e),this.lastTapTime=a},200)}getTouchDistance(e,t){let i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}isDraggable(){return this.img&&(this.img.width*this.scale>this.logicalWidth||this.img.height*this.scale>this.logicalHeight)}triggerClickOutside(e){if("function"==typeof this.options.onClickOutside){let t=this.canvas.getBoundingClientRect(),i={x:e.clientX-t.left,y:e.clientY-t.top,canvasX:e.clientX-t.left,canvasY:e.clientY-t.top,imageX:-1,imageY:-1};this.img&&(i.imageX=(i.canvasX-this.posX)/this.scale,i.imageY=(i.canvasY-this.posY)/this.scale),this.options.onClickOutside(i,e)}}getTouchCenter(e){let t=0,i=0,s=this.canvas.getBoundingClientRect();for(let n of e)t+=n.clientX-s.left,i+=n.clientY-s.top;return{x:t/e.length,y:i/e.length}}destroy(){window.removeEventListener("resize",this.handleResize),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("mouseleave",this.handleMouseLeave),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("click",this.handleCanvasClick),this.canvas.removeEventListener("touchend",this.handleCanvasTouchEnd),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)}}function cubicBezier(e,t,i,s){let n=3*e-3*i+1,a=3*i-6*e,o=3*e,l=3*t-3*s+1,r=3*s-6*t,d=3*t;function c(e){return((n*e+a)*e+o)*e}function h(e){return(3*n*e+2*a)*e+o}return e=>{var t;return((l*(t=function e(t){let i=0,s=1,n=t;for(let a=0;a<8;a++){let o=c(n)-t;if(1e-6>Math.abs(o))return n;let l=h(n);if(1e-6>Math.abs(l))break;n-=o/l}for(;s>i;){let r=c(n)-t;if(1e-6>Math.abs(r))break;r>0?s=n:i=n,n=(s+i)/2}return n}(e))+r)*t+d)*t}}function bindMenuNavigation(e,t="vertical"){function i(){if(e.length<=1){e.forEach(e=>{e._navHandler&&(e.removeEventListener("keydown",e._navHandler),delete e._navHandler)});return}e.forEach((i,s)=>{i._navHandler&&i.removeEventListener("keydown",i._navHandler),i._navHandler=i=>{let n=s;if("vertical"===t){if("ArrowDown"===i.key)n=(s+1)%e.length;else{if("ArrowUp"!==i.key)return;n=(s-1+e.length)%e.length}}else if("horizontal"!==t)return;else if("ArrowRight"===i.key)n=(s+1)%e.length;else{if("ArrowLeft"!==i.key)return;n=(s-1+e.length)%e.length}e[n].focus()},i.addEventListener("keydown",i._navHandler)})}return i(),{removeItem:function t(s){e=e.filter(e=>e!==s),i()},addItem:function t(s){e.push(s),i()},updateEventListeners:i}}HTMLElement.prototype.clear=function(){this.innerHTML=""},HTMLElement.prototype.focusable=function(e){this.tabIndex=e?"0":"-1",this.blur()},HTMLElement.prototype.bindWithCooldown=function(e,t=500){let i=this;i._bindWithCooldownHandler&&(i.removeEventListener("click",i._bindWithCooldownHandler),i.removeEventListener("keydown",i._bindWithCooldownHandler));let s=0,n=function(n){let a=Date.now();i.classList.contains("disabled")||i.hasAttribute("disabled")||"click"!==n.type&&32!==n.keyCode&&13!==n.keyCode||!(a-s>=t)&&0!==t||(s=a,e.call(i,n))};i.addEventListener("click",n),i.addEventListener("keydown",n),i._bindWithCooldownHandler=n};let myStorage={set(e,t){try{let i=JSON.stringify(t);localStorage.setItem(e,i)}catch(s){console.error("Error saving to localStorage",s)}},get(e,t=null){try{let i=localStorage.getItem(e);return null!==i?JSON.parse(i):t}catch(s){return console.error("Error reading from localStorage",s),t}},remove(e){try{localStorage.removeItem(e)}catch(t){console.error("Error removing from localStorage",t)}},clear(){try{localStorage.clear()}catch(e){console.error("Error clearing localStorage",e)}},has:e=>null!==localStorage.getItem(e),keys:()=>Object.keys(localStorage)};class MyTooltip{constructor({parent:e,text:t,placement:i="top",interactive:s=!0}){this._parent=e,this._content=t,this._placement=i,this._tooltip=null,this._tooltipId=`tooltip-${Math.random().toString(36).substr(2,9)}`,this._parent.setAttribute("aria-describedby",this._tooltipId),s&&(this.showTooltip=this.showTooltip.bind(this),this.hideTooltip=this.hideTooltip.bind(this),this._parent.addEventListener("mouseenter",this.showTooltip),this._parent.addEventListener("focus",this.showTooltip),this._parent.addEventListener("blur",this.hideTooltip),this._parent.addEventListener("mouseleave",this.hideTooltip))}_createTooltipElement(){let e=ec("xuocLuDI6");return e.setAttribute("placement",this._placement),e.setAttribute("id",this._tooltipId),e.innerText=this._content,e}updatePosition(){if(!this._tooltip)return;let e=this._parent.getBoundingClientRect(),t=this._tooltip.getBoundingClientRect(),i,s;switch(this._placement){case"top":i=window.scrollY+e.top-t.height-8,s=window.scrollX+e.left+e.width/2-t.width/2;break;case"bottom":i=window.scrollY+e.bottom+8,s=window.scrollX+e.left+e.width/2-t.width/2;break;case"left":i=window.scrollY+e.top+e.height/2-t.height/2,s=window.scrollX+e.left-t.width-8;break;case"right":i=window.scrollY+e.top+e.height/2-t.height/2,s=window.scrollX+e.right+8;break;default:throw Error("Invalid placement value")}this._tooltip.style.top=`${i}px`,this._tooltip.style.left=`${s}px`}showTooltip(){this._tooltip||(this._tooltip=this._createTooltipElement(),document.body.appendChild(this._tooltip),this.updatePosition(),this._tooltip.setAttribute("data-state","delayed-open"),this._tooltip.setAttribute("aria-expanded","true"))}hideTooltip(){this._tooltip&&(this._tooltip.setAttribute("data-state","closed"),this._tooltip.setAttribute("aria-expanded","false"),this._tooltip.remove(),this._tooltip=null)}setText(e){this._content=e,this._tooltip&&(this._tooltip.innerText=e,this.updatePosition())}destroy(){this.hideTooltip(),this._parent&&(this._parent.removeAttribute("aria-describedby"),this._parent.removeEventListener("mouseenter",this.showTooltip),this._parent.removeEventListener("focus",this.showTooltip),this._parent.removeEventListener("blur",this.hideTooltip),this._parent.removeEventListener("mouseleave",this.hideTooltip)),this._tooltip=null,this._parent=null,this._content=null}}class MyPopover{constructor({trigger:e,placement:t="bottom"}){let i=`_${generateRandomString(12)}`;this.trigger=e,this.placement=t,this.Root=ec("xEHCrF5Oe"),this.Overlay=ec("overlay"),this.Content=ec("xC3Uih0ex"),this.Root.setAttribute("data-state","open"),this.Root.setAttribute("role","popover"),this.Root.setAttribute("aria-modal","true"),this.Root.id=i,document.body.appendChild(this.Root),this.Root.appendChild(this.Overlay),this.Root.appendChild(this.Content),this.Root.onwheel=function(e){e.ctrlKey&&e.preventDefault()};let s=cssEscape(i);this._deactivated_elements=document.querySelectorAll(`body > *:not(#${s}, script, style)`),this._deactivated_elements.forEach(e=>{e.setAttribute("inert","true")}),this.Overlay.addEventListener("click",()=>this.close()),this.Overlay.addEventListener("contextmenu",()=>this.close()),document.addEventListener("keydown",this._handleKeyDown),this._setPosition(),window.addEventListener("resize",this._handleResize)}_handleResize=()=>{this._setPosition()};_setPosition(){let e=this.trigger.getBoundingClientRect(),t=this.Content.getBoundingClientRect(),i;if(Array.isArray(this.placement)){for(let s of this.placement){let n=this._calculatePosition(s,e,t);if(this._isPositionWithinViewport(n,t)){i=s;break}}i||(i=this.placement[0])}else i=this.placement;let a=this._calculatePosition(i,e,t);this.Content.style.position="absolute",this.Content.style.top=`${a.top}px`,this.Content.style.left=`${a.left}px`}_calculatePosition(e,t,i){let s=0,n=0,[a,o]=e.split("-");switch(a){case"top":s=t.top-i.height;break;case"bottom":s=t.bottom;break;case"left":n=t.left-i.width;break;case"right":n=t.right}switch(o){case"start":n=t.left;break;case"end":n=t.left+t.width-i.width;break;default:"top"===a||"bottom"===a?n=t.left+(t.width-i.width)/2:s=t.top+(t.height-i.height)/2}return{top:s,left:n}}_isPositionWithinViewport(e,t){let i=window.innerWidth,s=window.innerHeight,{top:n,left:a}=e;return n>=0&&a>=0&&n+t.height<=s&&a+t.width<=i}_handleKeyDown=e=>{27===e.keyCode&&(this.close(),this.trigger.focus())};_removeListeners(){document.removeEventListener("keydown",this._handleKeyDown),window.removeEventListener("resize",this._handleResize)}onClose(e){this.onCloseCallback=e}close(){this._removeListeners(),this._deactivated_elements.forEach(e=>{e.removeAttribute("inert")}),this.Root.setAttribute("data-state","closed"),setTimeout(()=>{this.Root.remove(),this.onCloseCallback&&this.onCloseCallback()},100)}}function cssEscape(e){return e.replace(/([!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g,"\\$&").replace(/^(-?\d)/,"\\3"+e.charAt(0)+" ")}class MyDialog{constructor({closeOnOverlayClick:e=!1,closeOnEsc:t=!1,excludeElements:i=[]}={}){let s=`_${generateRandomString(12)}`;this.Root=ec("x54SkYRT0"),this.Overlay=ec("overlay"),this.Content=ec("content"),this.Root.setAttribute("data-state","open"),this.Root.appendChild(this.Overlay),this.Root.appendChild(this.Content),this.Root.setAttribute("role","dialog"),this.Root.setAttribute("aria-modal","true"),this.Root.onwheel=function(e){e.ctrlKey&&e.preventDefault()},this.Lock=!1,this.Root.id=s;let n=cssEscape(s);this._deactivated_elements=Array.from(document.querySelectorAll(`body > *:not(#${n}, script, style)`)),this._deactivated_elements.forEach(e=>e.setAttribute("inert","true")),this._exclude_for_restore=i,document.body.appendChild(this.Root),this.Root.classList.add("show"),MyDialog.stack.push(this),e&&this.Overlay.addEventListener("click",this._handleOverlayClick),t&&document.addEventListener("keydown",this._handleKeyDown)}_handleOverlayClick=()=>{this.close()};_handleKeyDown=e=>{27===e.keyCode&&MyDialog.stack[MyDialog.stack.length-1]===this&&this.close()};onClose(e){this.onCloseCallback=e}close(){if(!this.Lock){let e=MyDialog.stack.indexOf(this);e>-1&&MyDialog.stack.splice(e,1),this.onCloseCallback&&this.onCloseCallback(),this._exclude_for_restore.length>0?this._exclude_for_restore.forEach(e=>{e instanceof HTMLElement&&e.removeAttribute("inert")}):this._deactivated_elements.forEach(e=>{e.removeAttribute("inert")}),this.Root.setAttribute("data-state","closed"),setTimeout(()=>{this.Root.remove()},100),this._removeListeners()}}_removeListeners(){this.Overlay.onclick=null,document.removeEventListener("keydown",this._handleKeyDown)}}MyDialog.stack=[];class AlertDialog extends MyDialog{constructor({title:e,message:t,buttons:i=[],closeOnOverlayClick:s=!1,closeOnEsc:n=!0,showCloseButton:a=!1}={}){super({closeOnOverlayClick:s,closeOnEsc:n});let o=this._createHeader(e,a),l=this._createBody(t);if(this.Content.style.padding="0px",this.Content.classList.add("xv1VrMJb6"),this.Content.classList.add("xLDQZ1SSl"),this.Content.appendChild(o),this.Content.appendChild(l),i.length>0){let r=this._createFooter(i);l.appendChild(r)}}_createHeader(e,t){let i=document.createElement("div");i.className="xrYn5ZY3v lf gn";let s=document.createElement("div");if(s.className="x6Y89FynP",s.textContent=e||"Alert",i.appendChild(s),t){let n=ec("xvb5soWNa");n.focusable(!0),n.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',n.bindWithCooldown(()=>{this.close()}),i.appendChild(n)}return i}_createBody(e){let t=document.createElement("div");t.className="xWDUelLWA";let i=document.createElement("div");return i.className="xujSSErs5",i.innerHTML=e||"Are you sure?",t.appendChild(i),t}_createFooter(e){let t=document.createElement("div");t.className="xWh2LBcgj";let i=bindMenuNavigation([],"horizontal");return e.forEach(({text:e,classList:s=[],onClick:n})=>{let a=document.createElement("div");a.className="xgw2tzk6r "+s.join(" "),a.setAttribute("tabindex","0"),a.textContent=e,a.bindWithCooldown(()=>{n&&n(),this.close()}),i.addItem(a),t.appendChild(a)}),t}}let ec=e=>{let t=document.createElement("div");return t.classList.add(e),t},_=e=>document.querySelector(e);function generateRandomString(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="";for(let s=0;s<e;s++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}function typewriterWithBezier(e,t,i={}){let{interval:s=24,fadeDuration:n=214,bezierControl:a=[.42,0,1,1]}=i,o=cubicBezier(...a),l=Array.from((new DOMParser).parseFromString(`<div>${t}</div>`,"text/html").body.firstChild.childNodes),r=[];l.forEach(t=>(function e(t,i){if(t.nodeType===Node.TEXT_NODE){let s=t.textContent.split("");for(let n of s){let a=document.createElement("span");a.classList.add("xSwoj5Cx2"),a.textContent=n,i.appendChild(a),r.push(a)}}else if(t.nodeType===Node.ELEMENT_NODE){let o=t.cloneNode(!1);i.appendChild(o),Array.from(t.childNodes).forEach(t=>e(t,o))}})(t,e)),function e(){r.length&&(function e(t){let i=performance.now();function s(e){let a=Math.min((e-i)/n,1),l=o(a);t.style.opacity=l,a<1&&requestAnimationFrame(s)}requestAnimationFrame(s)}(r.shift()),setTimeout(e,s))}()}function getTimeRangeStatus(e,t){let i=new Date,s=new Date(e),n=new Date(t);if(i>=s&&i<=n)return"現在";let a=i<s?s:n,o=a.getHours(),l;l=o>=0&&o<6?"清晨":o<12?"早上":o<18?"下午":"晚上";let r=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),d=r(a),c=r(i),h;switch(Math.round((d-c)/864e5)){case -2:h="前天";break;case -1:h="昨天";break;case 0:h="今天";break;case 1:h="明天";break;case 2:h="後天";break;default:h=`${a.getMonth()+1}/${a.getDate()}`}return`${h} ${l}`}function getScreenInfo(){return{screenWidth:window.screen.width,screenHeight:window.screen.height,devicePixelRatio:window.devicePixelRatio}}function detectDeviceOS(){let e=navigator.userAgent||navigator.vendor||window.opera,t=navigator.platform,i=navigator.maxTouchPoints||0;if(/iPad|iPhone|iPod/.test(e)||"MacIntel"===t&&i>1){let s=e.match(/OS (\d+)_?(\d+)?_?(\d+)?/i);if(s){let n=s[1]||"0",a;return{os:"iOS",version:`${n}.${s[2]||"0"}.${s[3]||"0"}`,deviceType:/iPad/.test(e)?"Tablet":"Mobile"}}}if(/Android/.test(e)){let o=e.match(/Android (\d+)\.?(\d+)?\.?(\d+)?/i);if(o){let l=o[1]||"0",r;return{os:"Android",version:`${l}.${o[2]||"0"}.${o[3]||"0"}`,deviceType:/Mobile/.test(e)?"Mobile":"Tablet"}}}if(/Win/.test(t)){let d=e.match(/Windows NT (\d+)\.?(\d+)?/i);if(d){let c;return{os:"Windows",version:`${d[1]||"0"}.${d[2]||"0"}`,deviceType:"Desktop"}}return{os:"Windows",version:null,deviceType:"Desktop"}}if(/Mac/.test(t)){let h=e.match(/Mac OS X (\d+)_?(\d+)?_?(\d+)?/i);if(h){let p=h[1]||"0",u;return{os:"macOS",version:`${p}.${h[2]||"0"}.${h[3]||"0"}`,deviceType:"Desktop"}}return{os:"macOS",version:null,deviceType:"Desktop"}}return/Linux/.test(t)?{os:"Linux",version:null,deviceType:"Desktop"}:{os:"Unknown",version:null,deviceType:"Unknown"}}function convertRubySyntax(e){return e.replace(/\{RUBY_B#(.*?)\}(.*?)\{RUBY_E#\}/g,(e,t,i)=>`<ruby><rb>${i}</rb><rt>${t}</rt></ruby>`)}let platformIcons={edit:'<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>',trash:'<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>',copy:'<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>'};class MyDrawer{constructor({closeOnOverlayClick:e=!1,closeOnEsc:t=!1,excludeElements:i=[]}={}){let s=`_${generateRandomString(12)}`;this.Root=ec("drawer-root"),this.Overlay=ec("drawer-overlay"),this.Content=ec("drawer-content"),this.Header=ec("drawer-header"),this.Handle=document.createElement("div"),this.Handle.className="drawer-drag-handle",this.Header.appendChild(this.Handle),this.Body=ec("drawer-body"),this.Content.appendChild(this.Header),this.Content.appendChild(this.Body),this.Root.setAttribute("data-state","open"),this.Root.appendChild(this.Overlay),this.Root.appendChild(this.Content),this.Root.setAttribute("role","dialog"),this.Root.setAttribute("aria-modal","true"),this.Root.onwheel=e=>{e.ctrlKey&&e.preventDefault()},this.Lock=!1,this.Root.id=s;let n=cssEscape(s);this._deactivated_elements=Array.from(document.querySelectorAll(`body > *:not(#${n}, script, style)`)),this._deactivated_elements.forEach(e=>e.setAttribute("inert","true")),this._exclude_for_restore=i,document.body.appendChild(this.Root),this.Root.classList.add("show"),MyDrawer.stack.push(this),e&&this.Overlay.addEventListener("click",this._handleOverlayClick),t&&document.addEventListener("keydown",this._handleKeyDown),this._setupDrag()}_handleOverlayClick=()=>{this.close()};_handleKeyDown=e=>{27===e.keyCode&&MyDrawer.stack[MyDrawer.stack.length-1]===this&&this.close()};onClose(e){this.onCloseCallback=e}close(){if(!this.Lock){let e=MyDrawer.stack.indexOf(this);e>-1&&MyDrawer.stack.splice(e,1),this.onCloseCallback&&this.onCloseCallback();let t=()=>{this._exclude_for_restore.length>0?this._exclude_for_restore.forEach(e=>e.removeAttribute("inert")):this._deactivated_elements.forEach(e=>e.removeAttribute("inert"))},i=window.getComputedStyle(this.Content).transform;"none"===i||i.includes("matrix")?(this.Content.classList.remove("x9GmoP75O"),this.Content.style.transform="translateY(100%)",setTimeout(()=>{t(),this.Root.remove()},300)):(t(),this.Root.remove()),this._removeListeners()}}_removeListeners(){this.Overlay.onclick=null,document.removeEventListener("keydown",this._handleKeyDown)}_setupDrag(){let e=0,t=0,i=!1,s=t=>{t.target.closest(".xBWmlKrN2")||(e=t.touches?t.touches[0].clientY:t.clientY,i=!0,this.Content.classList.add("x9GmoP75O"))},n=s=>{if(!i)return;let n=(t=s.touches?s.touches[0].clientY:s.clientY)-e;n>0&&(this.Content.style.transform=`translateY(${n}px)`)},a=()=>{if(!i)return;let s=t-e,n=this.Content.offsetHeight;this.Content.classList.remove("x9GmoP75O"),s>.5*n?this.close():this.Content.style.transform="translateY(0)",i=!1};this.Content.addEventListener("touchstart",s,{passive:!0}),this.Content.addEventListener("touchmove",n,{passive:!0}),this.Content.addEventListener("touchend",a),this.Content.addEventListener("mousedown",e=>{s(e);let t=e=>n(e),i=()=>{a(),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",i)})}}MyDrawer.stack=[];let app=e({apiKey:"AIzaSyAp73V5ZsBUtpy4kS3-QyGirGSpz71DPWo",authDomain:"smiling-theory-397204.firebaseapp.com",databaseURL:"https://smiling-theory-397204-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"smiling-theory-397204",storageBucket:"smiling-theory-397204.appspot.com",messagingSenderId:"360479398694",appId:"1:360479398694:web:05b7df5ce277f89ea8ffe7",measurementId:"G-6BKTT1K7D1"}),db=h(app),storage=l(app),provider=new s,auth=t();p(db).then(()=>{console.log("離線緩存功能已啟用")}).catch(e=>{"failed-precondition"===e.code?console.error("已開啟多個分頁，無法啟用離線緩存功能"):"unimplemented"===e.code&&console.error("當前瀏覽器不支持離線緩存")});let isMobileDevice=/(Android|webOS|Windows Phone|iPhone|iPod|iPad)/i.test(window.navigator.platform)||window.innerWidth<550,allGroups=[],components={sidebar:_(".xFz8bwNFr"),main:_(".x8o58HttN"),messageInput:_(".xtsARDHTI"),searchInput:_(".xujXllYgW"),messageContainer:_(".xikyLwDf4"),sendButton:_(".xuwRtDpu4"),fileInput:_(".xVEJA40Qh"),attachButton:_(".xpbRox0hO#xJTcQcZ9E"),stickerButton:_(".xpbRox0hO#xbXZpIWEa"),markButton:_(".xpbRox0hO#xsVrze5YA"),brushButton:_(".xpbRox0hO#xrfvUzMAG"),heading:_(".xehdiGgBv"),backButton:_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ"),primaryArea:_(".xemr1y6ie"),spinnerContainer:_(".xemr1y6ie .spinner"),spinnerLabel:_(".xemr1y6ie .spinner .xkT2bkntT"),_mb_att_btn:_(".xDADAUUv4"),roomNameLabel:_(".x8o58HttN .xMyenRl7K .xvwhg72ii"),signatureLabel:_(".xlKSJ67AP"),nameLabel:_(".xt4GQkVIo"),avatarLabel:_(".xbVHF6S6B"),avatarWrapper:_(".xaoteDJh4"),profileContainer:_(".xQ6gFUtqT"),layoutResizer:_(".xrFP6D2e1"),statusLabel:_(".xOJE48BLX"),activityBar:_(".pS2na74a"),layoutResizer2:_(".PLc7zlhg")},spinner_strc=`<svg aria-hidden="true" class="xxA4Cqchz" style="min-width: 20px" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M12 3a9 9 0 1 0 9 9"></path>
						</svg>載入中…`,versionInfo={current:"0.0.2",cacheId:"x0n0HCjlj",directions:`<ul class="xxmjDL5xB xbH7v2Hbn">
	<li class="xcKqXW8uF">修復了一些錯誤</li>
	<li class="xcKqXW8uF">現在能通過 Drawer 查看長訊息</li>
	</ul>`},allMessages=[],userProfileCache={},roomDataCache={},chatPrompt,initialized=!1,currentRoom="",lastDoc,unreadCount=0,userId,isScrollEventActive=!1,markingState=!1,messagesCF=components.messageContainer,userPSCState={state:!1,_a:null,_b:null,_n:"",_d:"",_m:[]},lastMessageInfo="",activingView=null,hasScroll=!1;if(isMobileDevice)document.body.classList.add("mobile"),components._mb_att_btn.bindWithCooldown(function(){components.fileInput.click()});else{document.body.classList.add("desktop"),new MyTooltip({parent:components.attachButton,text:"附加文件",placement:"top"}),components.attachButton.bindWithCooldown(function(){components.fileInput.click()}),new MyTooltip({parent:components.sendButton,text:"發送",placement:"top",interactive:!0}),new MyTooltip({parent:components.stickerButton,text:"加入貼圖",placement:"top",interactive:!0});let S=new MyTooltip({parent:components.markButton,text:"標記為重要",placement:"top",interactive:!0});new MyTooltip({parent:components.brushButton,text:"潤色文本",placement:"top",interactive:!0}),bindMenuNavigation([components.attachButton,components.brushButton,components.markButton,components.stickerButton,],"horizontal"),components.brushButton.bindWithCooldown(function(){let e=HeadingDialog("潤色文本",!0);e.content.classList.add("lg"),e.body.classList.add("xDLwiKdTE")}),components.markButton.bindWithCooldown(function(){markingState?(markingState=!1,components.markButton.classList.remove("x3zdxRXQ6"),S.setText("標記為重要")):(markingState=!0,components.markButton.classList.add("x3zdxRXQ6"),S.setText("取消標記"))},0);let E=!1,I=0,A=0,R=e=>{E=!0,document.body.classList.add("xz7kq9zLe");let t=e.target.getBoundingClientRect();A=e.clientX-t.left,document.addEventListener("mousemove",H),document.addEventListener("mouseup",D)},H=e=>{if(!E)return;let t=components.sidebar.getBoundingClientRect().left,i=e.clientX-t-A;I=i,components.sidebar.style.width=i+"px"},D=()=>{E=!1,myStorage.set("xjS4MkN99",I),document.body.classList.remove("xz7kq9zLe"),document.removeEventListener("mousemove",H),document.removeEventListener("mouseup",D)};window.addEventListener("blur",()=>{document.body.classList.remove("resizing"),E=!1}),components.layoutResizer.addEventListener("mousedown",e=>{R(e)})}function HeadingDialog(e,t=!1,...i){console.log(i);let s=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0,excludeElements:i}),n=ec("xrYn5ZY3v");n.classList.add("lf"),s.Content.style.padding="0";let a=ec("x6Y89FynP");n.appendChild(a),a.innerText=e,s.Content.appendChild(n);let o=ec("xWDUelLWA");s.Content.appendChild(o);let l;t&&((l=ec("xvb5soWNa")).focusable(!0),l.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',s.close=s.close.bind(s),l.bindWithCooldown(s.close),n.appendChild(l));let r=n.getBoundingClientRect();return n.style.minHeight=r.height+"px",{root:s,body:o,content:s.Content,closebtn:l,Root:s.Root,Content:s.Content}}async function parseMessageContent(e,t){if(t.startsWith("<")){let i=t.match(/<\s*(\w+)\s+(\S+)/),s=i[1],n=i[2];if("image"===s){let a=document.createElement("img");a.focusable(!0),a.classList.add("xGsec9lFd"),a.classList.add("xUSR4cuWD"),a.setAttribute("data-state","loading"),hasScroll||(console.log("嘗試修復偏差位移"),components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"instant"})),a.onerror=function(){console.log("載入失敗"),a.setAttribute("data-state","failed"),a.classList.remove("xUSR4cuWD")},a.onload=function(){hasScroll||(console.log("嘗試修復偏差位移"),components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"instant"})),a.setAttribute("data-state","loaded"),a.classList.remove("xUSR4cuWD"),e.classList.add("xFIqZCKV3"),a.bindWithCooldown(function(){let e=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0});e.Content.classList.add("xPSnkbRat");let t=document.createElement("canvas");t.classList.add("xWuhDLG1C"),e.Content.appendChild(t);let i=new ImageViewer(t,{maxScale:2,onClickOutside(e,t){s(e,t)}});function s(){i.destroy(),e.close()}i.loadImage(n);let a=ec("x8o1OSu71");a.focusable(!0),a.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',a.bindWithCooldown(s),e.Content.appendChild(a);let o=ec("x8o1OSu71");o.classList.add("xHZuqwWhI"),o.focusable(!0),o.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.95 11a8 8 0 1 0 -.5 4m.5 5v-5h-5" /></svg>',o.bindWithCooldown(function(){i.rotate()},0),e.Content.appendChild(o)},0)},navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:n}),a.src=n,e.appendChild(a)}else if("video"===s){let o=document.createElement("video");o.setAttribute("muted",""),o.focusable(!0),o.setAttribute("controls","true"),o.setAttribute("controlslist","nodownload"),o.onloadedmetadata=function(){console.log("嘗試修復偏差位移"),components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"instant"})},navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:n}),o.src=n,o.classList.add("xGsec9lFd"),e.appendChild(o)}else if("audio"===s){let l=document.createElement("audio");l.focusable(!0),l.setAttribute("controls","true"),navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:n}),l.src=n,l.classList.add("xGsec9lFd"),e.appendChild(l)}else e.innerHTML=`<div class="xUiYNFhtR">無法預覽這個文件 <a class="x0ciSQShX no-wrap" href="${n}" target="_blank" rel="noreferrer noopener">下載</a></div>`}else{let r=document.createElement("span"),d=ec("xYj7x2KZ4");r.classList.add("xVlceg4Ab"),renderTextWithMentions(r,t),e.appendChild(r),e.appendChild(d);if(r.getBoundingClientRect().height>125){e.classList.add("xDVzL7FIt");let c=ec("x6EwJGLAa"),h={0:`<span class="xNM56JYdv">展開全部</span>`,1:`<span class="xNM56JYdv">顯示較少</span>`,2:`<span class="xNM56JYdv">查看全部</span>`};c.innerHTML=h[isMobileDevice?2:0],c.focusable(!0);let p=0;c.bindWithCooldown(function(){if(isMobileDevice){let i=new MyDrawer({closeOnEsc:!0,closeOnOverlayClick:!0}),s=ec("xBWmlKrN2");i.Body.appendChild(s),renderTextWithMentions(s,t)}else 0===p?(p=1,e.classList.add("x2y08yFOH"),c.innerHTML=h[1]):(p=0,e.classList.remove("x2y08yFOH"),c.innerHTML=h[0])},0),d.appendChild(c)}}}function renderTextWithMentions(e,t){let i=/@(\w+)/g,s=0,n;for(e.clear();null!==(n=i.exec(t));){let{index:a}=n,o=n[1];a>s&&appendTextWithUrlsAndLineBreaks(e,t.slice(s,a));let l=document.createElement("a");l.classList.add("x0ciSQShX"),l.focusable(!0),l.dataset.userId=o,userPSCState._m.push({userId:o,dom:l}),getUserProfile(o).then(function(e){e?(l.textContent=`@${e.name||"未知"}`,l.bindWithCooldown(function(){userInfoShowCase(activingView,{data:e,type:isMobileDevice?"mobile":"desktop"})},0)):l.textContent=`@未知`}).catch(function(e){l.textContent=`@${o}`,console.log(`無法載入這位用戶的暱稱`,e)}),e.appendChild(l),s=i.lastIndex}s<t.length&&appendTextWithUrlsAndLineBreaks(e,t.slice(s))}function appendTextWithUrlsAndLineBreaks(e,t){let i=t.split("\n");i.forEach((t,s)=>{if(t){let n=replaceUrlsWithLinks(t),a=document.createElement("div");a.innerHTML=n,Array.from(a.childNodes).forEach(t=>{e.appendChild(t)})}s<i.length-1&&e.appendChild(document.createElement("br"))})}function replaceUrlsWithLinks(e){return e.replace(/https?:\/\/[^\s/$.?#].[^\s]*/g,function(e){let t=e.replace(/^https?:\/\//,"");return'<span class="xCe4Btdzm" tabindex="0"><a class="x0ciSQShX" tabindex="-1" translate="no" href="'+e+'" target="_blank" rel="noreferrer noopener">'+decodeURIComponent(t)+"</a></span>"})}async function handleSendMessage(){let e=components.messageInput.innerText.trim();if(!e||!currentRoom||""===e)return;components.sendButton.classList.add("disabled"),components.sendButton.focusable(!1);let t=e.match(/^\/(\w+)\s*(.*)/);if(t){let i=t[1],s=t[2];if("task"===i){if("1358"===s){components.messageInput.clear(),navigator.serviceWorker?.controller?.postMessage({action:"clear-all-caches"}),displaySentMessage({content:`已成功清除緩存，重新載入後即生效`,tag:"2"},generateRandomString(20),"3");return}components.messageInput.clear(),displaySentMessage({content:`未知的指令，請重新嘗試`},generateRandomString(20),"3");return}}e=e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replace(/\.\.\./g,"…").replace(/(\r?\n){3,}/g,"\n\n"),components.messageInput.clear();let n=markingState?"1":null;components.markButton.classList.remove("x3zdxRXQ6"),markingState=!1;let a=g(u(db,"chats",currentRoom,"messages"));await m(a,{sender:userId,content:e,timestamp:Date.now(),tag:n}),displaySentMessage({content:e,tag:n},a.id,"3")}navigator.serviceWorker.addEventListener("message",e=>{if("cache-size-result"===e.data.type){let t=document.getElementById("cacheSizeResult");if(e.data.error){t.innerHTML=`错误: ${e.data.error}`;return}displaySentMessage({content:formatFileSize(e.data.bytes)},generateRandomString(20),"3")}});let totalHeight=0;function displaySentMessage(e,t,i="1"){let s=ec("xVC8gtuyS"),n=ec("xMyW2iRSH"),a=ec("xKljxgVJA"),o=ec("xu4Celbbq"),l=ec("xc4iCj2Gy"),r=ec("xRHoYYwoZ");switch(s.setAttribute("data-visible","true"),s.setAttribute("data-message-id",t),s.classList.add("xiOw4dg0O"),s.appendChild(a),a.appendChild(r),r.appendChild(o),o.appendChild(l),r.appendChild(n),l.innerText="你",lastMessageInfo.sender===e.sender&&s.classList.add("xOmVIOA3e"),"1"===e.tag?n.classList.add("x4rKxFxLl"):"2"===e.tag&&n.classList.add("xHJfZfjT1"),chatPrompt&&(chatPrompt.remove(),chatPrompt=null),i){case"1":components.messageContainer.appendChild(s);break;case"2":messagesCF.appendChild(s),totalHeight+=s.offsetHeight;break;case"3":components.messageContainer.appendChild(s),isScrollEventActive=!0,components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"smooth"})}parseMessageContent(n,e.content)}function displayReceivedMessage(e,t,i="1"){let s=ec("xVC8gtuyS"),n=ec("xMyW2iRSH"),a=ec("xSYcbYqTG"),o=ec("xKljxgVJA"),l=ec("xu4Celbbq"),r=ec("xc4iCj2Gy"),d=ec("xt8fROB2L"),c=ec("xRHoYYwoZ"),h=document.createElement("img");switch(s.setAttribute("data-visible","true"),d.classList.add("xt8fROB2L"),h.loading="lazy",s.appendChild(a),s.appendChild(o),o.appendChild(c),c.appendChild(l),l.appendChild(r),c.appendChild(n),l.appendChild(d),a.appendChild(h),s.setAttribute("data-message-id",t),"1"===e.tag&&n.classList.add("x4rKxFxLl"),d.innerText="0s",r.innerText="未知",h.draggable=!1,chatPrompt&&(chatPrompt.remove(),chatPrompt=null),lastMessageInfo.sender===e.sender&&s.classList.add("xOmVIOA3e"),i){case"1":components.messageContainer.appendChild(s);break;case"2":messagesCF.appendChild(s),totalHeight+=s.offsetHeight;break;case"3":components.messageContainer.appendChild(s),isScrollEventActive=!0,components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"smooth"}),isScrollEventActive=!1}parseMessageContent(n,e.content),getUserProfile(e.sender).then(t=>{function i(){userInfoShowCase(components.main,{data:t,type:isMobileDevice?"mobile":"desktop"})}d.innerText=timeAgo(e.timestamp),h.src=t.avatarUrl||"/assets/avatar.png",h.onload=function(){a.classList.add("xWzeTGC6P")},r.onclick=i,a.focusable(!0),a.bindWithCooldown(i),r.innerText=t.name||"未知"}).catch(e=>{console.error(e)})}function updateApp(e,t,i){components.signatureLabel.innerHTML=escapeHTML(i||"暫時還沒有描述哦"),components.avatarWrapper.classList.remove("xJd2GT7MI"),components.avatarLabel.src=e||"assets/avatar.png",components.nameLabel.textContent=t||"未知"}async function initialize(){if(initialized)return;console.log("正在初始化應用程序"),components.roomNameLabel.innerText="未知",components.searchInput.placeholder="搜尋…",components.messageInput.setAttribute("placeholder","在這裡輸入訊息…"),components.spinnerLabel.innerText="載入中…";let e=myStorage.get("xjS4MkN99");e&&(components.sidebar.style.width=e+"px"),document.body.classList.add("xmKH3ad5R");let t=detectDeviceOS(),i=getScreenInfo();loadAllChatRoom();try{getUserProfile(userId).then(async e=>{(!e.deviceInfo||Date.now()-e.deviceInfo.lastUpdate>36e5)&&(await updateUserProfile(userId,{deviceInfo:{lastUpdate:Date.now(),os:`${t.os} ${t.version}`,screen:`${i.screenWidth}x${i.screenHeight} @${i.devicePixelRatio}x`}}),console.log("已上傳裝置信息"))})}catch(s){console.error("發生未知錯誤",s)}try{function n(){let e=components.messageContainer.getBoundingClientRect();components.messageContainer.style.setProperty("--x9LFHiVqv",`${Number((.6*e.height-24).toFixed(2))}px`),components.messageContainer.style.setProperty("--xVizV2ybq",`${Number((.72*e.height).toFixed(2))-24}px`)}n(),window.addEventListener("resize",n)}catch(a){console.log("設置布局時發生錯誤")}components.searchInput.removeAttribute("disabled"),components.searchInput.focusable(!0),components.profileContainer.classList.remove("disabled"),components.profileContainer.focusable(!0),localStorage.getItem("cvs")!==versionInfo.current&&(isMobileDevice?new MyDrawer({closeOnEsc:!0,closeOnOverlayClick:!0}).Body.innerHTML=`<div class="xa6f2dQXX">更新了什麼</div><div class="x68JrA5Ak">${versionInfo.directions}</div>`:HeadingDialog("更新了什麼",!0).body.innerHTML=`<div class="xeUKJgV96">${versionInfo.directions}</div>`,localStorage.setItem("cvs",versionInfo.current)),initialized=!0}function escapeHTML(e){return e.replace(/&([^;]+)/g,"&amp;$1").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll(" ","&nbsp;").replaceAll("\n","<br>")}function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}let titleTemplete="Structure",labelElement;function createChatRoom(e){var t;let i=ec("x2fP9fkxS"),s=ec("xQ65c0Nkc"),n=ec("xybvM5cRF"),a=ec("xT3Ta8vKw"),o=ec("x6HyfOZS7"),l=ec("xQkxrD9ZA");async function r(){if(currentRoom!==e.id||isMobileDevice){components.messageInput.innerHTML="",currentRoom=e.id,userPSCState._m.length=0,activingView=components.main,hasScroll=!1;let t=[];e.members.forEach(e=>{getUserProfile(e).then(i=>{t.push({id:e,name:i.name})}).catch(e=>{console.error("取得用户名称时发生错误：",e)})}),titleTemplete=`${e.name||"未知"} - Structure`,document.title=titleTemplete,components.roomNameLabel.innerText=e.name,allMessages.length=0,labelElement&&labelElement.remove(),"public"===e.tag?((labelElement=ec("xjrgLBAlF")).focusable(!0),labelElement.classList.add("xYARRkCjq"),labelElement.textContent="公開",labelElement.bindWithCooldown(function(){HeadingDialog("說明",!0).body.innerHTML=`<div class="xrrfDPLS2">任何人都能加入這個聊天室</div>`}),components.statusLabel.appendChild(labelElement)):"privacy"===e.tag&&((labelElement=ec("xjrgLBAlF")).focusable(!0),labelElement.classList.add("xxC3C39Oc"),labelElement.textContent="私人",labelElement.bindWithCooldown(function(){HeadingDialog("說明",!0).body.innerHTML=`<div class="xrrfDPLS2">只有受邀人能加入本聊天室</div>`}),components.statusLabel.appendChild(labelElement));let s=new URLSearchParams(window.location.search);s.set("r",e.id),window.history.replaceState({},"","?"+s.toString()),components.messageContainer.classList.remove("xVjpzmyej"),components.fileInput.removeAttribute("disabled"),components.attachButton.classList.remove("disabled"),components.attachButton.focusable(!0),components.stickerButton.classList.remove("disabled"),components.stickerButton.focusable(!0),components.markButton.classList.remove("disabled"),components.markButton.focusable(!0),components.markButton.classList.remove("x3zdxRXQ6"),markingState=!1,components.brushButton.classList.remove("disabled"),components.brushButton.focusable(!0),components.messageInput.setAttribute("contenteditable","true"),isMobileDevice?(components._mb_att_btn.classList.remove("disabled"),components._mb_att_btn.focusable(!0),components.backButton.classList.remove("disabled"),_(".xehdiGgBv .xMyenRl7K .x8JU9DbQZ").focusable(!0),components.main.classList.add("x8VAGH6N2")):(_(".x2fP9fkxS.active")&&_(".x2fP9fkxS.active").classList.remove("active"),i.classList.add("active")),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.focusable(!0),components.messageContainer.clear(),(chatPrompt=ec("xqBX9i6rZ")).classList.add("spinner"),chatPrompt.innerHTML=spinner_strc,components.messageContainer.appendChild(chatPrompt);let n=await f(w(u(db,"chats",e.id,"messages"),y("timestamp","desc"),T(10)));lastDoc=n.docs[9];let a=[];n.forEach(e=>{a.push(e)}),0===a.length&&chatPrompt&&(chatPrompt.innerHTML=`這裡還沒有訊息，現在就開始聊天吧`),a.reverse(),a.map(e=>{var t=e.data();-1===allMessages.indexOf(e.id)&&(t.sender===userId?(allMessages.push(e.id),displaySentMessage(t,e.id,"1")):(allMessages.push(e.id),displayReceivedMessage(t,e.id,"1"))),lastMessageInfo=t}),isScrollEventActive=!0,components.messageContainer.scrollTo({top:components.messageContainer.scrollHeight,behavior:"instant"}),isScrollEventActive=!1}}createListener(e.id),i.bindWithCooldown(r),allGroups.push({id:e.id,name:e.name||"未知",launch:r,dom:i}),i.appendChild(s),i.appendChild(o),o.appendChild(l);let d=function(){let t=new MyPopover({trigger:l,placement:["bottom-start","bottom-end","top-start","top-end"]});t.Content.classList.add("xoV8hdbgt");let s=ec("xrQdSHI2A"),n=ec("xrQdSHI2A"),a=ec("xcoXgMpFW"),o=ec("xrQdSHI2A");s.bindWithCooldown(function(){t.close();let i=ec("xPAY7PmDq"),s;isMobileDevice?((s=new NavigationView({parent:components.sidebar,title:"所有成員"})).Content.classList.add("xU2hUavXh"),s.Content.appendChild(i)):((s=HeadingDialog("所有成員",!0)).content.classList.add("lg"),s.content.classList.add("xb4MnocjO"),s.body.appendChild(i));let n=0;e.members.forEach(e=>{n++,function e(t){getUserProfile(t).then(e=>{let t=ec("xScefCkPw"),n=ec("xZHdsOFDz"),a=document.createElement("img");a.classList.add("xxnnTDIPC"),a.src=e.avatarUrl||"assets/avatar.png",a.draggable=!1,a.loading="lazy",navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:e.avatarUrl}),n.appendChild(a);let o=ec("xs8tjkwHJ"),l=ec("xt4GQkVIo"),r=ec("xlKSJ67AP");l.innerText=e.name,r.innerText=e.signature||"暫時還沒有描述哦",t.focusable(!0),o.appendChild(l),o.appendChild(r),t.appendChild(n),t.appendChild(o),t.bindWithCooldown(function(){isMobileDevice?userInfoShowCase(s.Root,{data:e,type:"mobile"}):(s.root.close(),userInfoShowCase(components.main,{data:e,type:"desktop"}))}),i.appendChild(t)}).catch(e=>{console.error(e)})}(e)}),1==n&&i.classList.add("xyS4vzBWG")}),s.innerHTML=`<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"  fill="none"  stroke="currentColor" stroke-width="2" stroke-linecap="round"  stroke-linejoin="round"><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>查看所有成員`,s.classList.add("xUdcoAHYM"),[s,n,o].forEach(e=>{e.focusable(!0)}),o.bindWithCooldown(function(){t.close(),new AlertDialog({closeOnEsc:!0,closeOnOverlayClick:!0,title:"退出",message:"確定要退出這個聊天室嗎，之後仍可重新加入",buttons:[{text:"取消"},{text:"確定",classList:["xTJA9U7y9"],onClick:async function(){let t=allGroups.findIndex(t=>t.id===e.id);if(-1!==t)try{await M(g(db,"users",userId),{joined:k(e.id)}),await M(g(db,"chats",e.id),{members:k(userId)}),allGroups.splice(t,1),i.remove(),currentRoom===e.id&&(currentRoom=null,components.statusLabel.innerHTML="",components.roomNameLabel.innerText="未知",components.messageContainer.clear()),0===allGroups.length&&(components.primaryArea.innerHTML=`<div class="xzF3bjGCc">尚未加入任何聊天室</div>`)}catch(s){console.error("Error while deleting item:",s)}}},]})}),t.Content.appendChild(s),n.innerHTML=`<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" /><path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M19 19m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /></svg>查看行程安排`,n.bindWithCooldown(async function(){t.close();let i,s=ec("xtx2Cn8cK"),n=ec("xNu1Upzh6");isMobileDevice?((i=new NavigationView({parent:components.sidebar,title:"行程安排"})).Content.classList.add("x6q2Zh2QF"),i.Content.classList.add("xU2hUavXh"),i.Content.appendChild(s)):((i=HeadingDialog("行程安排",!0)).content.classList.add("xb4MnocjO"),i.content.classList.add("lg"),i.body.appendChild(s));let a=bindMenuNavigation([]);function o(t,s){let o=ec("xTIlpY4Et"),l=ec("xA9JMbz3o");o.appendChild(l),"green"===t.theme?l.classList.add("x9hGI5hex"):"pink"===t.theme&&l.classList.add("x0eVQzH93");let r=ec("xHxVtIAsn");o.appendChild(r);let d=ec("xt4GQkVIo");d.innerHTML=t.name||"未知",r.appendChild(d);let c=ec("xHQ4s8VGa");renderTextWithMentions(c,t.description||"忘記加上描述了"),r.appendChild(c);let h=getTimeRangeStatus(t.startAt,t.endAt),p=ec("xPP6DGDrH");p.innerText=h,o.appendChild(p);let u=ec("xxChbQgko"),m=ec("xaTPzRSCY");m.innerHTML=platformIcons.edit,m.focusable(!0);let $=ec("xaTPzRSCY");$.innerHTML=platformIcons.trash,$.focusable(!0),bindMenuNavigation([m,$],"horizontal"),$.bindWithCooldown(async function(){o.classList.add("disabled");try{$.focusable(!1),$.classList.add("disabled"),m.focusable(!1),m.classList.add("disabled");await v(g(db,"chats",e.id,"todos",s)),console.log(`已成功刪除行程：${s}`),o.remove(),a.removeItem(o)}catch(t){$.focusable(!0),$.classList.remove("disabled"),m.focusable(!0),m.classList.remove("disabled"),console.error("刪除失敗：",t),o.classList.remove("disabled")}}),u.appendChild(m),u.appendChild($),o.appendChild(u),o.focusable(!0),a.addItem(o),n.appendChild(o);let x={name:t.name||"未知",startAt:t.startAt||17356608e5,endAt:t.endAt||17356608e5,description:t.description||""};m.bindWithCooldown(function(n){n.stopPropagation(),function n(){let a=HeadingDialog("編輯行程",!0,i.Root),o=ec("xGGKUZ7B3"),l=`_${generateRandomString(12)}`,r=document.createElement("label"),h=document.createElement("input");r.classList.add("xF37V7xd0"),h.classList.add("xYvZ9WF6d"),r.htmlFor=l,r.textContent="標題",h.id=l,h.type="text",h.value=x.name,h.maxLength=30,o.appendChild(r),o.appendChild(h);let p=ec("xGGKUZ7B3"),u=`_${generateRandomString(12)}`,m=document.createElement("label"),v=document.createElement("textarea");m.classList.add("xF37V7xd0"),v.classList.add("xGuwEx6qN"),m.htmlFor=u,m.textContent="描述",v.id=u,v.rows=3,v.value=x.description,v.maxLength=80,p.appendChild(m),p.appendChild(v);let $=ec("xGGKUZ7B3");$.classList.add("xFJWlqoGn");let f=`_${generateRandomString(12)}`,C=document.createElement("label"),b=ec("x9ZwavJjj"),w=document.createElement("input"),y=document.createElement("input");C.classList.add("xF37V7xd0"),w.classList.add("xYvZ9WF6d"),C.htmlFor=f,C.textContent="開始",w.type="date",w.id=f,y.classList.add("xYvZ9WF6d"),y.type="time";let L=`_${generateRandomString(12)}`,k=ec("x9ZwavJjj"),T=document.createElement("label"),S=document.createElement("input"),E=document.createElement("input");T.classList.add("xF37V7xd0"),S.classList.add("xYvZ9WF6d"),T.htmlFor=L,T.textContent="結束",S.id=L,S.type="date",E.classList.add("xYvZ9WF6d"),E.type="time";let I=ec("xGGKUZ7B3"),A=ec("x40AApYkW");A.classList.add("xwtdXtpQT"),A.textContent="完成",A.classList.add("disabled");let R={};function H(){""!==h.value.trim()&&w.value&&y.value&&S.value&&E.value&&(h.value!==R._z||w.value!==R._a||y.value!==R._b||S.value!==R._c||E.value!==R._d||v.value!==R._y)?(A.focusable(!0),A.classList.remove("disabled")):(A.focusable(!1),A.classList.add("disabled"))}R._z=t.name,R._y=t.description;let D=[h,w,y,S,E,v];if(D.forEach(e=>{e.oninput=H}),A.bindWithCooldown(async function(){A.classList.add("disabled"),A.innerHTML='<svg aria-hidden="true" class="x3xXCjYFp" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';let t=new Date(`${w.value}T${y.value}`).getTime(),i=new Date(`${S.value}T${E.value}`).getTime(),n=h.value,o=v.value;D.forEach(e=>{e.setAttribute("disabled",!0)});let l=g(db,"chats",e.id,"todos",s);try{await M(l,{endAt:i,startAt:t,name:n,description:o}),x.name=n,x.description=o,x.startAt=t,x.endAt=i,d.innerHTML=x.name,renderTextWithMentions(c,x.description||"暫時還沒有描述哦"),console.log(`已成功更新行程：${s}`),a.root.close()}catch(r){console.error("更新失敗：",r),D.forEach(e=>{e.classList.remove("disabled")})}}),b.appendChild(C),b.appendChild(w),b.appendChild(y),k.appendChild(T),k.appendChild(S),k.appendChild(E),a.body.appendChild(o),a.body.appendChild(p),a.body.appendChild($),a.body.appendChild(I),$.appendChild(b),$.appendChild(k),I.appendChild(A),x.startAt){let W=new Date(x.startAt),B=new Date(x.startAt).toISOString().split("T")[0];console.log(B);let P=W.toTimeString().split(":").slice(0,2).join(":");console.log(B),R._a=B,R._b=P,w.value=B,y.value=P}if(x.endAt){let Y=new Date(x.endAt),O=new Date(x.endAt).toISOString().split("T")[0],z=Y.toTimeString().split(":").slice(0,2).join(":");R._c=O,R._d=z,S.value=O,E.value=z}H(),h.focus()}()})}s.appendChild(n);let l=ec("xTOLrzGN6");s.appendChild(l);let r=ec("xCgVOK4ur");l.appendChild(r);let d=ec("xtG9t2xuE"),c=ec("x5FOXvrVK"),h=ec("x5FOXvrVK"),p=ec("x7ho7YfuM");d.appendChild(c),d.appendChild(h),d.appendChild(p);let $=!1;c.innerText=`編輯模式`,h.innerText=`預覽模式`,d.focusable(!0),r.appendChild(d);let x=ec("xY17x64dw");x.classList.add("xmiEvp5FV"),x.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-plus"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>',x.focusable(!0),d.bindWithCooldown(function(){$?(x.classList.remove("hide"),n.classList.remove("xbrV3058R"),d.classList.remove("xHCo3rIZ7"),$=!1):(x.classList.add("hide"),n.classList.add("xbrV3058R"),d.classList.add("xHCo3rIZ7"),$=!0)},0),x.bindWithCooldown(async function(){let t=g(u(db,"chats",e.id,"todos")),i={name:"新的行程",description:"",startAt:Date.now(),endAt:Date.now()};await m(t,i),o(i,t.id)},1e3),r.appendChild(x),n.innerHTML=`<div class="xmBX2cWRZ spinner">${spinner_strc}</div>`;let C=await f(w(u(db,"chats",e.id,"todos")));n.innerHTML=`<div class="xmBX2cWRZ">還沒有任何行程，現在就創建一個吧</div>`,0!==C.docs.length&&C.forEach(e=>{o(e.data(),e.id)})}),t.Content.appendChild(n),t.Content.appendChild(a),o.innerHTML=`<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-door-exit"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 12v.01" /><path d="M3 21h18" /><path d="M5 21v-16a2 2 0 0 1 2 -2h7.5m2.5 10.5v7.5" /><path d="M14 7h7m-3 -3l3 3l-3 3" /></svg>退出`,o.classList.add("xGy5QqsmI"),t.Content.appendChild(o),bindMenuNavigation([s,n,o]),t._setPosition()};l.bindWithCooldown(function(e){e.stopPropagation(),d()}),l.focusable(!0),i.focusable(!0),l.innerHTML='<svg aria-hidden="true" style="min-width: 20px;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',s.appendChild(n),n.innerText=e.name||"未知",t=e.description?e.description:0===e.size?"沒有訊息":`${formatNumberWithCommas(e.size)} 則訊息`,a.innerText=t,s.appendChild(a),components.primaryArea.appendChild(i),e.focus&&(r(),i.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}))}function timeAgo(e){let t=Math.max(Math.floor((Date.now()-e)/1e3),0);return t<60?`${t} 秒前`:t<3600?`${Math.floor(t/60)} 分鐘前`:t<86400?`${Math.floor(t/3600)} 小時前`:t<2592e3?`${Math.floor(t/86400)} 天前`:t<31536e3?`${Math.floor(t/2592e3)} 個月前`:`${formatNumberWithCommas(Math.floor(t/31536e3))} 年前`}function formatFileSize(e){let t=["B","KB","MB","GB","TB","PB"],i=e,s=0;for(;i>=1024&&s<t.length-1;)i/=1024,s++;return`${i.toFixed(2)} ${t[s]}`}async function updateUserProfile(e,t){try{let i=g(db,"users",e);if(t){await M(i,t),userProfileCache[e]&&(userProfileCache[e]={...userProfileCache[e],...t});let s=sessionStorage.getItem(`upf_${e}`);if(s){let n={...JSON.parse(s),...t};sessionStorage.setItem(`upf_${e}`,JSON.stringify(n))}}else delete userProfileCache[e],sessionStorage.removeItem(`upf_${e}`);return!0}catch(a){return console.error("Failed to update user profile:",a),!1}}async function getUserProfile(e){if(userProfileCache[e])return userProfileCache[e];let t=sessionStorage.getItem(`upf_${e}`);if(t){let i=JSON.parse(t);return userProfileCache[e]=i,i}try{let s=await $(g(db,"users",e));if(!s.exists())return null;{let n=s.data();return userProfileCache[e]=n,sessionStorage.setItem(`upf_${e}`,JSON.stringify(n)),n}}catch(a){throw a}}async function getRoomData(e){if(roomDataCache[e])return roomDataCache[e];let t=sessionStorage.getItem(`rpf_${e}`);if(t){let i=JSON.parse(t);return roomDataCache[e]=i,i}try{let s=await $(g(db,"chats",e));if(!s.exists())return null;{let n=s.data();return userProfileCache[e]=n,sessionStorage.setItem(`rpf_${e}`,JSON.stringify(n)),n}}catch(a){throw a}}async function loadMessages(e,t){if(console.log("嘗試加載更多訊息"),void 0!==lastDoc){isScrollEventActive=!0;let i=await f(w(u(db,"chats",e,"messages"),y("timestamp","desc"),C(lastDoc),T(10)));if(console.log(`${i.docs.length} messages left`),0===i.docs.length)return;lastDoc=10===i.docs.length?i.docs[9]:void 0;let s=[];i.forEach(e=>{s.push(e)}),s.reverse();let n=0;messagesCF=ec("xWIHJooz8"),lastMessageInfo="";let a=components.messageContainer.firstChild;components.messageContainer.insertBefore(messagesCF,a);let o=components.messageContainer.scrollHeight;s.map(e=>{n++;let t=e.data();-1===allMessages.indexOf(e.id)&&(t.sender===userId?(allMessages.push(e.id),displaySentMessage(t,e.id,"2")):(allMessages.push(e.id),displayReceivedMessage(t,e.id,"2")),lastMessageInfo=t)});isScrollEventActive=!0,totalHeight=components.messageContainer.scrollHeight-o,components.messageContainer.scrollTo({top:totalHeight,left:0,behavior:"instant"}),totalHeight=0,setTimeout(function(){isScrollEventActive=!1},500)}else isScrollEventActive=!1}let messageTemplete='.xikyLwDf4 .xVC8gtuyS[data-message-id="{sid}"]';function createListener(e){b(u(db,"chats",e,"messages"),t=>{t.docChanges().forEach(t=>{if(currentRoom!==e)return;let i=t.doc.data();switch(t.type){case"added":i.sender===userId||-1!==allMessages.indexOf(t.doc.id)||t.doc.metadata.fromCache||("hidden"===document.visibilityState&&(unreadCount++,document.title=`(${unreadCount}) ${titleTemplete}`),allMessages.push(t.doc.id),displayReceivedMessage(i,t.doc.id,"3"));break;case"removed":let s=_(messageTemplete.replace("{sid}",t.doc.id));try{s.classList.add("xl4gtQk5f"),setTimeout(function(){s.remove()},3e3)}catch(n){console.log(n)}break;case"modified":try{let a=_(messageTemplete.replace("{sid}",t.doc.id)).querySelector(".xMyW2iRSH");a?(a.clear(),parseMessageContent(a,i.content)):console.log("找不到匹配的訊息容器")}catch(o){console.log("修改訊息時發生未知錯誤",o)}}})},e=>{console.error("An unknown error occurred",e)})}function setupLoginUI(){let e=ec("xrYn5ZY3v");e.innerText="歡迎回來";let t=ec("x4V8Jejrz");t.innerText="登入帳號後即可使用我們的服務";let n=ec("xRRuA0Z3S"),o=document.createElement("div");o.id="x7BYgkdiJ",o.focusable(!0);let l=`<svg aria-hidden="true" class="xGBqJjpdr" viewBox="0 0 20 20"><path d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z" fill=#4285F4></path><path d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z" fill=#34A853></path><path d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z" fill=#FBBC05></path><path d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z" fill=#EA4335></path></svg>使用 Google 登入`,r=`<div class="spinner"><svg aria-hidden="true" class="xxA4Cqchz" style="min-width: 20px" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a9 9 0 1 0 9 9"></path></svg><span class="xkT2bkntT">等待中…</span></div>`;o.innerHTML=l;let d=document.createElement("div");d.focusable(!0),d.id="xBnuWNG6V",d.className="actionbtn xYIKBnbHS",o.className="actionbtn xYIKBnbHS",d.innerHTML=`<svg aria-hidden="true" class="xGBqJjpdr" viewBox="0 0 20 20"><path d="M1 5.006A2 2 0 012.995 3h14.01A2 2 0 0119 5.006v9.988A2 2 0 0117.005 17H2.995A2 2 0 011 14.994V5.006zM3 5l7 4 7-4v2l-7 4-7-4V5z" fill-rule=evenodd fill=#788aa2></path></svg>使用 電子郵件 登入`,n.appendChild(o),n.appendChild(d);let c=new MyDialog;c.Content.classList.add("bt"),c.Root.classList.add("xCmJYJQtp"),c.Content.classList.add("xySmLVr4a"),c.Content.appendChild(e),c.Content.appendChild(t),c.Content.appendChild(n);let h=ec("xrYn5ZY3v");h.classList.add("lf"),h.classList.add("gc");let p=ec("xZyuwxZPZ");p.focusable(!0),p.innerHTML='<svg style="min-width: 24px" aria-hidden="true" class="xRmN7l0Zc" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>',h.appendChild(p);let u=ec("x6Y89FynP");u.innerText="電子郵件登入",h.appendChild(u);let m=ec("xWDUelLWA");m.classList.add("xwxpzc3QF"),c.Content.appendChild(h),c.Content.appendChild(m);let g=document.createElement("div");m.appendChild(g),g.classList.add("xZdL9CF5M");let v=document.createElement("div");v.classList.add("xGGKUZ7B3"),g.appendChild(v);let $=document.createElement("label");$.classList.add("xF37V7xd0"),$.innerText="電子郵件地址",v.appendChild($);let x=document.createElement("input");x.classList.add("xYvZ9WF6d"),x.autocomplete="off",x.type="text",x.disabled=!0,x.spellcheck=!1,v.appendChild(x);let f=document.createElement("div");f.classList.add("xGGKUZ7B3"),f.style.marginTop="10px",f.style.marginBottom="5px",g.appendChild(f);let C=document.createElement("label");C.classList.add("xF37V7xd0"),C.innerText="密碼",f.appendChild(C);let b=document.createElement("input");b.classList.add("xYvZ9WF6d"),b.type="password",b.disabled=!0,b.autocomplete="off",f.appendChild(b);let w=document.createElement("div");w.classList.add("xw0IanPrC"),g.appendChild(w);let y=document.createElement("div");y.innerText="送出",y.classList.add("disabled"),y.classList.add("x40AApYkW"),g.appendChild(y);let L=ec("xPT7rhLdL");L.focusable(!0),L.innerHTML=`<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12l14 0"></path><path d="M5 12l6 6"></path><path d="M5 12l6 -6"></path></svg>返回上一頁`,L.bindWithCooldown(function(){c.Content.classList.remove("xA7y7OLtP"),y.classList.add("disabled"),y.focusable(!1),x.disabled=!0,b.disabled=!0}),g.appendChild(L),p.bindWithCooldown(function(){c.Content.classList.remove("xA7y7OLtP"),y.classList.add("disabled"),y.focusable(!1),x.disabled=!0,b.disabled=!0});let k=!0,M=function(){k&&(k=!1,p.classList.add("disabled"),p.focusable(!1),w.classList.remove("show"),y.innerHTML='<svg aria-hidden="true" class="x3xXCjYFp" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>',x.disabled=!0,b.disabled=!0,y.classList.add("disabled"),y.focusable(!1),y.blur(),L.classList.add("disabled"),L.focusable(!1),a(auth,x.value,b.value).then(e=>{try{c.close(),α.close()}catch(t){}let i=e.user;console.log("User is logged in: ",i)}).catch(e=>{setTimeout(function(){let t=e.code;switch(w.classList.add("show"),t){case"auth/invalid-login-credentials":w.innerText="密碼錯誤，請重新嘗試";break;case"auth/invalid-email":w.innerText="找不到這個帳號，請重新嘗試";break;case"auth/network-request-failed":w.innerText="網路請求錯誤，請檢查網路連線";break;default:w.innerText="發生未知的錯誤"}y.innerHTML="送出",y.classList.remove("disabled"),y.focusable(!0),L.classList.remove("disabled"),L.focusable(!0),x.disabled=!1,b.disabled=!1,p.classList.remove("disabled"),p.focusable(!0),k=!0},3e3)}))};b.onkeydown=function(e){13===e.keyCode&&M()},y.bindWithCooldown(M),o.bindWithCooldown(function(){o.classList.add("disabled"),d.classList.add("disabled"),o.innerHTML=r,o.focusable(!1),d.focusable(!1),i(auth,provider).then(e=>{s.credentialFromResult(e).accessToken;getUserProfile(userId=e.user.uid).then(e=>{try{updateApp(e.avatarUrl,e.name,e.signature)}catch(t){console.error("無法設置")}c.close()}).catch(e=>{console.error(e)})}).catch(e=>{"auth/popup-closed-by-user"===e.code&&(o.classList.remove("disabled"),d.classList.remove("disabled"),o.focusable(!0),d.focusable(!0),o.innerHTML=l)})}),d.bindWithCooldown(function(){c.Content.classList.add("xA7y7OLtP"),x.disabled=!1,b.disabled=!1,y.focusable(!0),y.classList.remove("disabled"),x.focus()})}function setupProfileSettingUI(e="",t="",...i){let s=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0,excludeElements:i});s.Content.style.padding="0";let n=ec("xrYn5ZY3v");n.classList.add("lf");let a=ec("x6Y89FynP");a.innerText="編輯個人資料",n.appendChild(a);let o=ec("xvb5soWNa");o.focusable(!0),o.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',s.close=s.close.bind(s),o.bindWithCooldown(s.close),n.appendChild(o),s.Content.appendChild(n);let l=ec("xWDUelLWA");s.Content.appendChild(l);let r=document.createElement("input");r.setAttribute("hidden","true"),r.id="_Jy2eOVG7",r.type="file";let d=ec("xGGKUZ7B3"),c=document.createElement("label");c.innerText="暱稱",c.classList.add("xF37V7xd0"),c.htmlFor="_rJvAjH9O";let h=document.createElement("input");h.value=e,h.classList.add("xYvZ9WF6d"),h.id="_rJvAjH9O",h.type="text",h.maxLength="20",h.autocomplete="off",h.spellcheck=!1,l.appendChild(d),d.appendChild(c),d.appendChild(h);let p=ec("xGGKUZ7B3"),u=document.createElement("label");u.innerText="描述",u.classList.add("xF37V7xd0"),u.htmlFor="_fM6Qcf9q";let v=document.createElement("textarea");v.maxLength="80",v.value=t,v.classList.add("xGuwEx6qN"),v.id="_fM6Qcf9q",v.rows="3",v.maxLength="50",v.autocomplete="off",v.spellcheck=!1,l.appendChild(p),p.appendChild(u),p.appendChild(v);let x=ec("x40AApYkW");function f(){v.value!==t||h.value!==e?(x.classList.remove("disabled"),x.focusable(!0)):(x.classList.add("disabled"),x.focusable(!1))}async function C(){x.classList.add("disabled"),x.innerHTML='<svg aria-hidden="true" class="x3xXCjYFp" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>',x.focusable(!1),h.disabled=!0,v.disabled=!0,r.disabled=!0;let e=h.value,t=v.value.trim();(await $(g(db,"users",userId))).exists()?await updateUserProfile(userId,{name:e,signature:t}):(await m(g(db,"users",userId),{name:e,signature:t,id:userId,joined:[],deviceInfo:""}),components.primaryArea.innerHTML=`<div class="xzF3bjGCc">重新載入後方可完整更新您的資料</div>`),components.nameLabel.innerText=e,components.signatureLabel.innerHTML=escapeHTML(t||"暫時還沒有描述哦"),userPSCState.state&&(userPSCState._n=e,userPSCState._d=t,userPSCState._a.innerText=e,userPSCState._b.innerHTML=replaceUrlsWithLinks(escapeHTML(t))||"暫時還沒有描述哦",userPSCState._m.forEach(t=>{t.userId===userId&&(t.dom.textContent=`@${e}`)})),s.close()}x.innerText="完成",x.classList.add("disabled"),x.style.marginTop="0",l.appendChild(x),v.oninput=f,h.oninput=f,x.bindWithCooldown(C),h.focus()}async function preActionofCreate(e,t){let i=await f(u(db,"chats",e.id,"messages"));allGroups.some(t=>t.id===e.id)||createChatRoom({name:e.name,id:e.id,type:e.type,tag:e.tag,description:e.description,size:i.size,members:e.members,focus:t,identity:e.identity})}async function loadAllChatRoom(){components.primaryArea.classList.add("xuGldtFot");let e=(await $(g(db,"users",userId))).data(),t=new URLSearchParams(window.location.search).get("r");(e.joined||[]).length>0?e.joined.map(async e=>{try{getRoomData(e).then(async i=>{preActionofCreate({id:e,name:i.name,type:i.type,tag:i.tag,plugins:i.plugins,members:i.members,description:i.description,identity:i.identity},t===e)})}catch(i){console.error("Error fetching document for ID:",e,i)}}):components.primaryArea.innerHTML=`<div class="xzF3bjGCc">尚未加入任何聊天室</div>`}n(auth,e=>{e?(getUserProfile(userId=e.uid).then(e=>{if(!e){setupProfileSettingUI();return}updateApp(e.avatarUrl,e.name,e.signature)}).catch(e=>{console.error(e),updateApp()}),initialize()):(userId="",setupLoginUI())});let fileIcons={audio:'<path d="M17.5 22h.5a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M2 19a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0v-4a6 6 0 0 1 12 0v4a2 2 0 1 1-4 0v-1a2 2 0 1 1 4 0" />',video:'<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="m10 11 5 3-5 3v-6Z" />',image:'<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><circle cx="10" cy="12" r="2" /><path d="m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22" />',archive:'<path d="M10 12v-1" /><path d="M10 18v-2" /><path d="M10 7V6" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M15.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v16a2 2 0 0 0 .274 1.01" /><circle cx="10" cy="20" r="2" />',others:'<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" />'};components.fileInput.onchange=async function(e){let t=e.target.files[0];if(!t)return;let i=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0});i.Lock=!0;let s=ec("xrYn5ZY3v");s.classList.add("lf");let n=ec("xWDUelLWA");n.classList.add("xIOucKmLX"),i.Content.appendChild(s),i.Content.appendChild(n),i.Content.classList.add("gt");let a=ec("x6Y89FynP"),o=ec("xujSSErs5");s.appendChild(a),n.appendChild(o);let l=ec("xvb5soWNa");if(l.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',l.focusable(!0),s.appendChild(l),t.size>52428800){a.innerText="上傳失敗",o.innerText=`這個文件有 ${formatFileSize(t.size)}，我們無法負擔`,l.onclick=function(){components.fileInput.value="",i.close.bind(i)()},i.Lock=!1;return}a.innerText="上傳中",o.innerText="正在上傳中，請耐心等待";let h=document.createElement("div");h.classList.add("xCECpHDwZ"),h.focusable(!0),n.appendChild(h);let p=document.createElement("div");p.classList.add("xty9qDHrl"),h.appendChild(p);let v=document.createElement("div");v.classList.add("xIEj1ZAnA");let $=String(t.type),x="",f="";$.startsWith("image/")?(x=fileIcons.image,f="< image {u}"):$.startsWith("video/")?(x=fileIcons.video,f="< video {u}"):$.startsWith("audio/")?(x=fileIcons.audio,f="< audio {u}"):-1!==["application/x-zip-compressed","application/zip","application/x-rar-compressed","application/vnd.rar","application/x-compressed",].indexOf($)?(x=fileIcons.archive,f="< other {u}"):"application/pdf"===$?(x=fileIcons.others,f="< pdf {u}"):(x=fileIcons.others,f="< other {u}"),v.innerHTML=`<svg aria-hidden="true" style="min-width: 28px" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${x}</svg>`,p.appendChild(v);let C=document.createElement("div");C.classList.add("xxs4n9nhX"),p.appendChild(C),C.innerHTML='<div class="xTGGn7ABj">'.concat(t.name).concat(`</div><div class="xtyaQiCLO">${formatFileSize(t.size)}</div>`),p.appendChild(C);let b=document.createElement("div");b.classList.add("xsoLox5sj"),p.appendChild(b);let w=document.createElement("div");w.classList.add("xk0osKWCK"),b.appendChild(w);let y="";try{y=`${generateRandomString(12)}-${t.name}`}catch(L){console.log("生成文件名時發生未知錯誤",L)}let k=r(storage,`uploads/${currentRoom}/attachment/${y}`),M=d(k,t);l.onclick=function(){a.innerText="上傳遭中斷",o.innerText="已取消上傳",i.Lock=!1,M.cancel(),components.fileInput.value="",i.close()},M.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;w.style.width=`${t}%`},e=>{console.log(e)},async()=>{let e=await c(M.snapshot.ref),t="";t=f.replace("{u}",e);let s=g(u(db,"chats",currentRoom,"messages"));await m(s,{sender:userId,content:t,timestamp:Date.now()}),displaySentMessage({content:t},s.id,"3"),components.fileInput.value="",h.remove(),a.innerText="上傳完成",o.innerText="這個文件已經成功上傳了",l.onclick=()=>{},i.Lock=!1,l.bindWithCooldown(function(){i.close()})})},document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&(console.log("已重新聚焦 清除未讀訊息數"),document.title=titleTemplete,unreadCount=0)}),components.searchInput.oninput=function(){let e=components.searchInput.value.toLowerCase().trim();""!==e?allGroups.forEach(t=>{t.name.toLowerCase().includes(e)?t.dom.classList.remove("hide"):t.dom.classList.add("hide")}):allGroups.forEach(e=>{e.dom.classList.remove("hide")})},components.messageContainer.addEventListener("scroll",function(){let e=components.messageContainer.scrollTop;""!==userId&&""!==currentRoom&&e<120&&!isScrollEventActive&&(hasScroll=!0,loadMessages(currentRoom))}),components.messageInput.oninput=function(){let e=components.messageInput.childNodes;1==e.length&&"BR"===e[0].nodeName&&components.messageInput.clear(),""!==components.messageInput.innerText.trim()?(components.sendButton.classList.remove("disabled"),components.sendButton.focusable(!0)):(components.sendButton.classList.add("disabled"),components.sendButton.focusable(!1))},components.messageInput.onfocus=function(){document.body.classList.add("xYIbDcl9T")},components.messageInput.onblur=function(){document.body.classList.remove("xYIbDcl9T")},components.messageInput.onpaste=function(e){e.preventDefault(),document.execCommand("insertHTML",!0,escapeHTML((e.clipboardData||window.Clipboard).getData("text/plain")))},components.messageInput.ondrop=function(e){e.preventDefault();let t=e.dataTransfer.getData("text/plain");e.target.focus(),document.execCommand("insertHTML",!0,escapeHTML(t))},components.messageInput.oncopy=function(e){e.preventDefault();var t=window.getSelection().toString();e.clipboardData.setData("text/plain",t)},components.messageInput.addEventListener("keydown",function(e){switch(e.keyCode){case 13:isMobileDevice||e.shiftKey||(e.preventDefault(),handleSendMessage());break;case 85:case 66:case 73:e.ctrlKey&&e.preventDefault()}}),components.sendButton.bindWithCooldown(handleSendMessage),document.onkeydown=function(e){switch(e.keyCode){case 191:let t=document.activeElement;t==components.messageInput||t==components.searchInput||"INPUT"==t.tagName.toUpperCase()||t.classList.contains("xGuwEx6qN")||t.classList.contains("xYvZ9WF6d")||(e.preventDefault(),components.messageInput.focus());break;case 75:e.ctrlKey&&initialized&&(e.preventDefault(),components.searchInput.focus());break;case 123:e.preventDefault();break;case 67:e.ctrlKey&&e.shiftKey&&e.preventDefault();break;case 85:case 187:case 189:case 80:case 83:case 79:case 109:case 107:e.ctrlKey&&e.preventDefault();break;case 37:case 39:e.altKey&&e.preventDefault()}},document.querySelectorAll("body > div").forEach(function(e){e.onwheel=function(e){e.ctrlKey&&e.preventDefault()}}),components.backButton.bindWithCooldown(function(){activingView=components.sidebar,components.backButton.classList.add("disabled"),components._mb_att_btn.classList.add("disabled");let e=window.location.href.replace(/\?.*$/,"");window.history.replaceState(null,"",e),components.main.classList.remove("x8VAGH6N2"),isScrollEventActive=!0,components.messageContainer.clear(),isScrollEventActive=!1,currentRoom="",titleTemplete="Structure",document.title=titleTemplete,components.messageInput.clear(),components.messageInput.setAttribute("contenteditable","true"),components.messageInput.focusable(!1),components.sendButton.classList.add("disabled"),components.sendButton.focusable(!1)}),components.profileContainer.bindWithCooldown(function(){let e=new MyPopover({trigger:components.profileContainer,placement:"top"});e.Content.classList.add("xLhiIL2Wm"),components.profileContainer.classList.add("x9EnCPd4S");let t=ec("xrQdSHI2A");t.focusable(!0),t.innerHTML=`<svg style="min-width: 24px" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M8 9h8" /><path d="M8 13h6" /><path d="M12.01 18.594l-4.01 2.406v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v5.5" /><path d="M16 19h6" /><path d="M19 16v6" /></svg>加入聊天室`,t.bindWithCooldown(function(){e.close();let t=HeadingDialog("加入聊天室",!0),i=ec("xGGKUZ7B3");i.classList.add("xlEirFRi3");let s=`_${generateRandomString(12)}`,n=document.createElement("label");n.textContent="邀請碼",n.htmlFor=s,n.classList.add("xF37V7xd0");let a=document.createElement("input");a.classList.add("x4qSHIItt"),a.id=s,a.autocomplete="off",a.autocorrect="off",a.maxLength="8",a.classList.add("xYvZ9WF6d"),a.classList.add("xYvZ9WF6d"),i.appendChild(n),i.appendChild(a);let o=ec("xw0IanPrC"),l=ec("x40AApYkW");l.classList.add("disabled"),l.textContent="送出";let r="disabled";async function d(){t.root.Lock=!0,t.closebtn.classList.add("disabled"),t.closebtn.focusable(!1),o.classList.remove("show"),l.classList.add("disabled"),a.setAttribute("disabled",!0),l.innerHTML='<svg aria-hidden="true" class="x3xXCjYFp" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';let e,i=await f(w(u(db,"chats"),x("jid","==",a.value.trim())));i.empty?setTimeout(function(){t.root.Lock=!1,t.closebtn.classList.remove("disabled"),t.closebtn.focusable(!0),o.classList.add("show"),o.innerText="無效的邀請碼，請重新嘗試",a.removeAttribute("disabled"),l.classList.remove("disabled"),l.innerHTML=`送出`},3e3):(t.root.Lock=!1,t.root.close());let s=[];i.forEach(e=>{s.push({id:e.id})}),s.forEach(async e=>{let t=allGroups.find(t=>t.id===e.id);t?(1===s.length&&(t.dom.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),t.launch()),console.log("已經加入了，不用再加入")):(await M(g(db,"users",userId),{joined:L(e.id)}),await M(g(db,"chats",e.id),{members:L(userId)}),sessionStorage.removeItem(`rpf_${e.id}`),getRoomData(e.id).then(async t=>{preActionofCreate({id:e.id,name:t.name,type:t.type,tag:t.tag,plugins:t.plugins,members:t.members,description:t.description,identity:t.identity},!0),console.log("成功加入",e.id)}))})}a.oninput=function(){let e;8===(e=a.value.trim()).length&&""!==e?(l.classList.remove("disabled"),l.focusable(!0),r="normal"):(l.classList.add("disabled"),l.focusable(!1),r="disabled")},a.onkeydown=function(e){13===e.keyCode&&"normal"===r&&d()},l.bindWithCooldown(async function(){"normal"===r&&d()}),t.body.appendChild(i),t.body.appendChild(o),t.body.appendChild(l),a.focus()});let i=ec("xrQdSHI2A");i.focusable(!0),i.innerHTML=`<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h1.5" /><path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /><path d="M20.2 20.2l1.8 1.8" /></svg>查看個人資料`,i.bindWithCooldown(function(){e.close(),getUserProfile(userId).then(e=>{userInfoShowCase(components.sidebar,{data:e,type:isMobileDevice?"mobile":"desktop"})}).catch(e=>{console.error(e)})});let s=ec("xcoXgMpFW"),n=ec("xrQdSHI2A");n.focusable(!0),n.bindWithCooldown(function(){e.close(),o(auth).then(()=>{userId="",currentRoom="",allGroups.length=0,allMessages.length=0,initialized=!1;let e=window.location.href.replace(/\?.*$/,"");window.history.replaceState(null,"",e),components.primaryArea.clear(),components.messageContainer.clear(),localStorage.setItem("cvs",""),chatPrompt&&(chatPrompt.remove(),chatPrompt=null),document.body.classList.remove("xmKH3ad5R"),components.profileContainer.classList.remove("disabled"),components.profileContainer.focusable(!0),components.markButton.classList.add("disabled"),components.brushButton.classList.add("disabled"),components.attachButton.classList.add("disabled"),components.stickerButton.classList.add("disabled"),markingState=!1,components.avatarWrapper.classList.add("xJd2GT7MI"),components.avatarLabel.src="",components.nameLabel.innerText="",components.signatureLabel.innerText=""}).catch(e=>{console.error("Sign out error",e)})}),n.innerHTML=`<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" /><path d="M9 12h12l-3 -3" /><path d="M18 15l3 -3" /></svg>登出`,bindMenuNavigation([t,i,n]),e.Content.appendChild(t),e.Content.appendChild(i),e.Content.appendChild(s),e.Content.appendChild(n),e._setPosition(),e.onClose(()=>{components.profileContainer.classList.remove("x9EnCPd4S")})});class NavigationView{constructor({parent:e,title:t}){let i=e,s=ec("xB4hVI3El"),n=ec("xopQXJrX5"),a=ec("xZz4zYjIm"),o=ec("xMyenRl7K"),l=ec("x8JU9DbQZ"),r=ec("xvwhg72ii");this._parent=i,this.Root=s,this.Content=a,this.Heading=n,this._backButton=l,this._deactivated_elements=document.querySelectorAll("body > *:not(.xEHCrF5Oe, script, [hidden])"),this._deactivated_elements.forEach(e=>{e.setAttribute("inert","true")}),n.appendChild(o),o.appendChild(l),o.appendChild(r),r.textContent=t,l.focusable(!0),l.innerHTML=`<svg style="min-width: 24px" aria-hidden="true" class="xvx75W2b4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>`,l.bindWithCooldown(this.close.bind(this)),s.appendChild(n),s.appendChild(a),document.body.appendChild(s),setTimeout(function(){activingView=s,i.classList.add("xCr0RyqCg"),s.classList.add("xa2pPtuLq")},50)}onClose(e){this.onCloseCallback=e}close(){this.onCloseCallback&&this.onCloseCallback(),this._deactivated_elements.forEach(e=>{e.removeAttribute("inert")}),activingView=this._parent,this.Root.classList.remove("xa2pPtuLq"),this._parent.classList.remove("xCr0RyqCg"),this._parent.classList.remove("xjv5U11Kz"),this.Root.classList.remove("xjv5U11Kz"),setTimeout(()=>{this.Root.remove()},100)}}async function userInfoShowCase(e,t){userPSCState.state=!0,userPSCState._n||(userPSCState._n=t.data.name),userPSCState._d||(userPSCState._d=t.data.signature);let i=ec("xkyfCNAI0"),s=ec("x0zSVRG3y"),n;navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:t.data.bannerUrl}),navigator.serviceWorker?.controller?.postMessage({action:"cache-url",url:t.data.avatarUrl}),"video"===t.data.bannerType?((n=document.createElement("video")).loop=!0,n.controlslist="nodownload",n.controls=!1,n.setAttribute("muted",""),n.playsInline=!0,n.preload=!0,n.autoplay=!0,n.src=t.data.bannerUrl):((n=document.createElement("img")).draggable=!1,n.src=t.data.bannerUrl||"assets/default-banner.png",n.loading="lazy"),n.classList.add("x96ofpjeu");let a=ec("xkKF4v6d2"),o=ec("xwvIJoAtO"),l=document.createElement("img");l.classList.add("xVwXc1fhM");let r=ec("xzCCWGB1D"),d=ec("xqYV0G7JT"),c=ec("xBjZoCxmV"),h=ec("xl2FSOZLU");h.classList.add("xLFOP2Fs3");let p=ec("xt0pX9m5p");i.appendChild(s),s.appendChild(n),i.appendChild(a),d.appendChild(o),o.appendChild(l),l.draggable=!1,l.src=t.data.avatarUrl||"assets/avatar.png",l.loading="lazy",a.appendChild(r),r.appendChild(d);let u=ec("x2OCp76zA");r.appendChild(u);let m=ec("xokk3UP7N");d.appendChild(m);let g=userPSCState._n,v=ec("x117sdiIx");v.textContent=g,c.appendChild(v);let $=ec("xxXoB6W0R");$.textContent=t.data.id,m.appendChild(c),m.appendChild($),userPSCState._a=v,userPSCState._b=h,h.innerHTML=replaceUrlsWithLinks(escapeHTML(userPSCState._d||"暫時還沒有描述哦")),a.appendChild(p);let x=ec("xylvbLNlS");x.innerText="描述",p.appendChild(x),p.appendChild(h);let f=ec("xylvbLNlS");f.id="xY3QPRePs",f.textContent=`最後上線`;let C=ec("xodqSvoQM"),b=new Date(t.data.deviceInfo.lastUpdate),w=b.getFullYear()+"/"+(b.getMonth()+1)+"/"+b.getDate()+" "+b.getHours().toString()+":"+b.getMinutes().toString().padStart(2,"0");C.innerText=`${timeAgo(t.data.deviceInfo.lastUpdate)||"未知"} (${w||"未知"})`,p.appendChild(f),p.appendChild(C);let y=ec("xylvbLNlS");y.textContent="裝置信息";let L=ec("xodqSvoQM");if(L.innerHTML=`${t.data.deviceInfo.os} ${t.data.deviceInfo.screen}`,p.appendChild(y),p.appendChild(L),"desktop"===t.type){let k=new MyDialog({closeOnEsc:!0,closeOnOverlayClick:!0});k.Content.classList.add("xlY0G76Nv"),k.Content.classList.add("lg"),k.Content.classList.add("gb");let M=ec("xjMiLDVEU"),T=ec("xUHiz9aGO"),S=ec("xhMhXcFlu"),E=ec("xIl46kG8k"),I=ec("xjMYgfYFc");E.appendChild(I),I.textContent=t.data.name,T.appendChild(E),T.appendChild(S);let A=ec("xHPTUCUar");if(A.bindWithCooldown(k.close.bind(k)),A.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',A.focusable(!0),t.data.id===userId){let R=ec("xHPTUCUar");R.bindWithCooldown(function(){setupProfileSettingUI(userPSCState._n,userPSCState._d,k.Root)}),R.innerHTML=platformIcons.edit,R.focusable(!0),S.appendChild(R),bindMenuNavigation([R,A],"horizontal")}S.appendChild(A),M.appendChild(T),k.Content.appendChild(M),M.appendChild(i);let H=k.Content.getBoundingClientRect();if(k.Content.style.setProperty("--xD672nKxG",`${H.height}px`),M.onscroll=function(){M.scrollTop>60?M.classList.add("xORN7XV1j"):M.classList.remove("xORN7XV1j")},t.data.verified){let D=ec("xTKxbdpu3");D.innerHTML='<svg aria-hidden="true" style="min-width: 24px" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',c.appendChild(D),D.bindWithCooldown(function(){HeadingDialog("說明",!0,k.Root).body.innerHTML=`<div class="xrrfDPLS2">此帳號已驗證</div>`})}k.onClose(function(){userPSCState.state=!1,userPSCState._a=null,userPSCState._b=null,userPSCState._n="",userPSCState._d=""})}else{let W=new NavigationView({parent:e,title:t.data.name});if(t.data.id===userId){let B=ec("x8JU9DbQZ");B.bindWithCooldown(function(){setupProfileSettingUI(userPSCState._n,userPSCState._d,W.Root)}),B.innerHTML=platformIcons.edit,B.focusable(!0),W.Heading.appendChild(B)}W.Root.classList.add("xwMgtrL2x"),W.onClose(function(){userPSCState.state=!1,userPSCState._a=null,userPSCState._b=null,userPSCState._n="",userPSCState._d=""}),W.Root.onscroll=function(){W.Root.scrollTop>60?W.Root.classList.add("xORN7XV1j"):W.Root.classList.remove("xORN7XV1j")},W._backButton.classList.add("xnS3FTqjp"),W.Content.appendChild(i)}}"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{e.onupdatefound=()=>{let t=e.installing;t.onstatechange=()=>{"installed"===t.state&&window.location.reload()}}}).catch(e=>{console.log("註冊失敗：",e)});
